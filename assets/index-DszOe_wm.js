(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))r(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const a of o.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&r(a)}).observe(document,{childList:!0,subtree:!0});function n(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerPolicy&&(o.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?o.credentials="include":i.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function r(i){if(i.ep)return;i.ep=!0;const o=n(i);fetch(i.href,o)}})();function getDefaultExportFromCjs(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var stats_min$1={exports:{}},stats_min=stats_min$1.exports,hasRequiredStats_min;function requireStats_min(){return hasRequiredStats_min||(hasRequiredStats_min=1,(function(t,e){(function(n,r){t.exports=r()})(stats_min,function(){var n=function(){function r(D){return a.appendChild(D.dom),D}function i(D){for(var O=0;O<a.children.length;O++)a.children[O].style.display=O===D?"block":"none";o=D}var o=0,a=document.createElement("div");a.style.cssText="position:fixed;top:0;left:0;cursor:pointer;opacity:0.9;z-index:10000",a.addEventListener("click",function(D){D.preventDefault(),i(++o%a.children.length)},!1);var l=(performance||Date).now(),A=l,E=0,v=r(new n.Panel("FPS","#0ff","#002")),x=r(new n.Panel("MS","#0f0","#020"));if(self.performance&&self.performance.memory)var R=r(new n.Panel("MB","#f08","#201"));return i(0),{REVISION:16,dom:a,addPanel:r,showPanel:i,begin:function(){l=(performance||Date).now()},end:function(){E++;var D=(performance||Date).now();if(x.update(D-l,200),D>A+1e3&&(v.update(1e3*E/(D-A),100),A=D,E=0,R)){var O=performance.memory;R.update(O.usedJSHeapSize/1048576,O.jsHeapSizeLimit/1048576)}return D},update:function(){l=this.end()},domElement:a,setMode:i}};return n.Panel=function(r,i,o){var a=1/0,l=0,A=Math.round,E=A(window.devicePixelRatio||1),v=80*E,x=48*E,R=3*E,D=2*E,O=3*E,U=15*E,H=74*E,$=30*E,X=document.createElement("canvas");X.width=v,X.height=x,X.style.cssText="width:80px;height:48px";var V=X.getContext("2d");return V.font="bold "+9*E+"px Helvetica,Arial,sans-serif",V.textBaseline="top",V.fillStyle=o,V.fillRect(0,0,v,x),V.fillStyle=i,V.fillText(r,R,D),V.fillRect(O,U,H,$),V.fillStyle=o,V.globalAlpha=.9,V.fillRect(O,U,H,$),{dom:X,update:function(q,te){a=Math.min(a,q),l=Math.max(l,q),V.fillStyle=o,V.globalAlpha=1,V.fillRect(0,0,v,U),V.fillStyle=i,V.fillText(A(q)+" "+r+" ("+A(a)+"-"+A(l)+")",R,D),V.drawImage(X,O+E,U,H-E,$,O,U,H-E,$),V.fillRect(O+H-E,U,E,$),V.fillStyle=o,V.globalAlpha=.9,V.fillRect(O+H-E,U,E,A((1-q/te)*$))}}},n})})(stats_min$1)),stats_min$1.exports}var stats_minExports=requireStats_min();const Stats=getDefaultExportFromCjs(stats_minExports);function ___$insertStyle(t){if(!(typeof window>"u")){var e=document.createElement("style");return e.setAttribute("type","text/css"),e.innerHTML=t,document.head.appendChild(e),t}}function colorToString(t,e){var n=t.__state.conversionName.toString(),r=Math.round(t.r),i=Math.round(t.g),o=Math.round(t.b),a=t.a,l=Math.round(t.h),A=t.s.toFixed(1),E=t.v.toFixed(1);if(e||n==="THREE_CHAR_HEX"||n==="SIX_CHAR_HEX"){for(var v=t.hex.toString(16);v.length<6;)v="0"+v;return"#"+v}else{if(n==="CSS_RGB")return"rgb("+r+","+i+","+o+")";if(n==="CSS_RGBA")return"rgba("+r+","+i+","+o+","+a+")";if(n==="HEX")return"0x"+t.hex.toString(16);if(n==="RGB_ARRAY")return"["+r+","+i+","+o+"]";if(n==="RGBA_ARRAY")return"["+r+","+i+","+o+","+a+"]";if(n==="RGB_OBJ")return"{r:"+r+",g:"+i+",b:"+o+"}";if(n==="RGBA_OBJ")return"{r:"+r+",g:"+i+",b:"+o+",a:"+a+"}";if(n==="HSV_OBJ")return"{h:"+l+",s:"+A+",v:"+E+"}";if(n==="HSVA_OBJ")return"{h:"+l+",s:"+A+",v:"+E+",a:"+a+"}"}return"unknown format"}var ARR_EACH=Array.prototype.forEach,ARR_SLICE=Array.prototype.slice,Common={BREAK:{},extend:function(e){return this.each(ARR_SLICE.call(arguments,1),function(n){var r=this.isObject(n)?Object.keys(n):[];r.forEach(function(i){this.isUndefined(n[i])||(e[i]=n[i])}.bind(this))},this),e},defaults:function(e){return this.each(ARR_SLICE.call(arguments,1),function(n){var r=this.isObject(n)?Object.keys(n):[];r.forEach(function(i){this.isUndefined(e[i])&&(e[i]=n[i])}.bind(this))},this),e},compose:function(){var e=ARR_SLICE.call(arguments);return function(){for(var n=ARR_SLICE.call(arguments),r=e.length-1;r>=0;r--)n=[e[r].apply(this,n)];return n[0]}},each:function(e,n,r){if(e){if(ARR_EACH&&e.forEach&&e.forEach===ARR_EACH)e.forEach(n,r);else if(e.length===e.length+0){var i=void 0,o=void 0;for(i=0,o=e.length;i<o;i++)if(i in e&&n.call(r,e[i],i)===this.BREAK)return}else for(var a in e)if(n.call(r,e[a],a)===this.BREAK)return}},defer:function(e){setTimeout(e,0)},debounce:function(e,n,r){var i=void 0;return function(){var o=this,a=arguments;function l(){i=null,r||e.apply(o,a)}var A=r||!i;clearTimeout(i),i=setTimeout(l,n),A&&e.apply(o,a)}},toArray:function(e){return e.toArray?e.toArray():ARR_SLICE.call(e)},isUndefined:function(e){return e===void 0},isNull:function(e){return e===null},isNaN:(function(t){function e(n){return t.apply(this,arguments)}return e.toString=function(){return t.toString()},e})(function(t){return isNaN(t)}),isArray:Array.isArray||function(t){return t.constructor===Array},isObject:function(e){return e===Object(e)},isNumber:function(e){return e===e+0},isString:function(e){return e===e+""},isBoolean:function(e){return e===!1||e===!0},isFunction:function(e){return e instanceof Function}},INTERPRETATIONS=[{litmus:Common.isString,conversions:{THREE_CHAR_HEX:{read:function(e){var n=e.match(/^#([A-F0-9])([A-F0-9])([A-F0-9])$/i);return n===null?!1:{space:"HEX",hex:parseInt("0x"+n[1].toString()+n[1].toString()+n[2].toString()+n[2].toString()+n[3].toString()+n[3].toString(),0)}},write:colorToString},SIX_CHAR_HEX:{read:function(e){var n=e.match(/^#([A-F0-9]{6})$/i);return n===null?!1:{space:"HEX",hex:parseInt("0x"+n[1].toString(),0)}},write:colorToString},CSS_RGB:{read:function(e){var n=e.match(/^rgb\(\s*(\S+)\s*,\s*(\S+)\s*,\s*(\S+)\s*\)/);return n===null?!1:{space:"RGB",r:parseFloat(n[1]),g:parseFloat(n[2]),b:parseFloat(n[3])}},write:colorToString},CSS_RGBA:{read:function(e){var n=e.match(/^rgba\(\s*(\S+)\s*,\s*(\S+)\s*,\s*(\S+)\s*,\s*(\S+)\s*\)/);return n===null?!1:{space:"RGB",r:parseFloat(n[1]),g:parseFloat(n[2]),b:parseFloat(n[3]),a:parseFloat(n[4])}},write:colorToString}}},{litmus:Common.isNumber,conversions:{HEX:{read:function(e){return{space:"HEX",hex:e,conversionName:"HEX"}},write:function(e){return e.hex}}}},{litmus:Common.isArray,conversions:{RGB_ARRAY:{read:function(e){return e.length!==3?!1:{space:"RGB",r:e[0],g:e[1],b:e[2]}},write:function(e){return[e.r,e.g,e.b]}},RGBA_ARRAY:{read:function(e){return e.length!==4?!1:{space:"RGB",r:e[0],g:e[1],b:e[2],a:e[3]}},write:function(e){return[e.r,e.g,e.b,e.a]}}}},{litmus:Common.isObject,conversions:{RGBA_OBJ:{read:function(e){return Common.isNumber(e.r)&&Common.isNumber(e.g)&&Common.isNumber(e.b)&&Common.isNumber(e.a)?{space:"RGB",r:e.r,g:e.g,b:e.b,a:e.a}:!1},write:function(e){return{r:e.r,g:e.g,b:e.b,a:e.a}}},RGB_OBJ:{read:function(e){return Common.isNumber(e.r)&&Common.isNumber(e.g)&&Common.isNumber(e.b)?{space:"RGB",r:e.r,g:e.g,b:e.b}:!1},write:function(e){return{r:e.r,g:e.g,b:e.b}}},HSVA_OBJ:{read:function(e){return Common.isNumber(e.h)&&Common.isNumber(e.s)&&Common.isNumber(e.v)&&Common.isNumber(e.a)?{space:"HSV",h:e.h,s:e.s,v:e.v,a:e.a}:!1},write:function(e){return{h:e.h,s:e.s,v:e.v,a:e.a}}},HSV_OBJ:{read:function(e){return Common.isNumber(e.h)&&Common.isNumber(e.s)&&Common.isNumber(e.v)?{space:"HSV",h:e.h,s:e.s,v:e.v}:!1},write:function(e){return{h:e.h,s:e.s,v:e.v}}}}}],result=void 0,toReturn=void 0,interpret=function(){toReturn=!1;var e=arguments.length>1?Common.toArray(arguments):arguments[0];return Common.each(INTERPRETATIONS,function(n){if(n.litmus(e))return Common.each(n.conversions,function(r,i){if(result=r.read(e),toReturn===!1&&result!==!1)return toReturn=result,result.conversionName=i,result.conversion=r,Common.BREAK}),Common.BREAK}),toReturn},tmpComponent=void 0,ColorMath={hsv_to_rgb:function(e,n,r){var i=Math.floor(e/60)%6,o=e/60-Math.floor(e/60),a=r*(1-n),l=r*(1-o*n),A=r*(1-(1-o)*n),E=[[r,A,a],[l,r,a],[a,r,A],[a,l,r],[A,a,r],[r,a,l]][i];return{r:E[0]*255,g:E[1]*255,b:E[2]*255}},rgb_to_hsv:function(e,n,r){var i=Math.min(e,n,r),o=Math.max(e,n,r),a=o-i,l=void 0,A=void 0;if(o!==0)A=a/o;else return{h:NaN,s:0,v:0};return e===o?l=(n-r)/a:n===o?l=2+(r-e)/a:l=4+(e-n)/a,l/=6,l<0&&(l+=1),{h:l*360,s:A,v:o/255}},rgb_to_hex:function(e,n,r){var i=this.hex_with_component(0,2,e);return i=this.hex_with_component(i,1,n),i=this.hex_with_component(i,0,r),i},component_from_hex:function(e,n){return e>>n*8&255},hex_with_component:function(e,n,r){return r<<(tmpComponent=n*8)|e&~(255<<tmpComponent)}},_typeof=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(t){return typeof t}:function(t){return t&&typeof Symbol=="function"&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},classCallCheck=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},createClass=(function(){function t(e,n){for(var r=0;r<n.length;r++){var i=n[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}})(),get=function t(e,n,r){e===null&&(e=Function.prototype);var i=Object.getOwnPropertyDescriptor(e,n);if(i===void 0){var o=Object.getPrototypeOf(e);return o===null?void 0:t(o,n,r)}else{if("value"in i)return i.value;var a=i.get;return a===void 0?void 0:a.call(r)}},inherits=function(t,e){if(typeof e!="function"&&e!==null)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)},possibleConstructorReturn=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e&&(typeof e=="object"||typeof e=="function")?e:t},Color=(function(){function t(){if(classCallCheck(this,t),this.__state=interpret.apply(this,arguments),this.__state===!1)throw new Error("Failed to interpret color arguments");this.__state.a=this.__state.a||1}return createClass(t,[{key:"toString",value:function(){return colorToString(this)}},{key:"toHexString",value:function(){return colorToString(this,!0)}},{key:"toOriginal",value:function(){return this.__state.conversion.write(this)}}]),t})();function defineRGBComponent(t,e,n){Object.defineProperty(t,e,{get:function(){return this.__state.space==="RGB"?this.__state[e]:(Color.recalculateRGB(this,e,n),this.__state[e])},set:function(i){this.__state.space!=="RGB"&&(Color.recalculateRGB(this,e,n),this.__state.space="RGB"),this.__state[e]=i}})}function defineHSVComponent(t,e){Object.defineProperty(t,e,{get:function(){return this.__state.space==="HSV"?this.__state[e]:(Color.recalculateHSV(this),this.__state[e])},set:function(r){this.__state.space!=="HSV"&&(Color.recalculateHSV(this),this.__state.space="HSV"),this.__state[e]=r}})}Color.recalculateRGB=function(t,e,n){if(t.__state.space==="HEX")t.__state[e]=ColorMath.component_from_hex(t.__state.hex,n);else if(t.__state.space==="HSV")Common.extend(t.__state,ColorMath.hsv_to_rgb(t.__state.h,t.__state.s,t.__state.v));else throw new Error("Corrupted color state")};Color.recalculateHSV=function(t){var e=ColorMath.rgb_to_hsv(t.r,t.g,t.b);Common.extend(t.__state,{s:e.s,v:e.v}),Common.isNaN(e.h)?Common.isUndefined(t.__state.h)&&(t.__state.h=0):t.__state.h=e.h};Color.COMPONENTS=["r","g","b","h","s","v","hex","a"];defineRGBComponent(Color.prototype,"r",2);defineRGBComponent(Color.prototype,"g",1);defineRGBComponent(Color.prototype,"b",0);defineHSVComponent(Color.prototype,"h");defineHSVComponent(Color.prototype,"s");defineHSVComponent(Color.prototype,"v");Object.defineProperty(Color.prototype,"a",{get:function(){return this.__state.a},set:function(e){this.__state.a=e}});Object.defineProperty(Color.prototype,"hex",{get:function(){return this.__state.space!=="HEX"&&(this.__state.hex=ColorMath.rgb_to_hex(this.r,this.g,this.b),this.__state.space="HEX"),this.__state.hex},set:function(e){this.__state.space="HEX",this.__state.hex=e}});var Controller=(function(){function t(e,n){classCallCheck(this,t),this.initialValue=e[n],this.domElement=document.createElement("div"),this.object=e,this.property=n,this.__onChange=void 0,this.__onFinishChange=void 0}return createClass(t,[{key:"onChange",value:function(n){return this.__onChange=n,this}},{key:"onFinishChange",value:function(n){return this.__onFinishChange=n,this}},{key:"setValue",value:function(n){return this.object[this.property]=n,this.__onChange&&this.__onChange.call(this,n),this.updateDisplay(),this}},{key:"getValue",value:function(){return this.object[this.property]}},{key:"updateDisplay",value:function(){return this}},{key:"isModified",value:function(){return this.initialValue!==this.getValue()}}]),t})(),EVENT_MAP={HTMLEvents:["change"],MouseEvents:["click","mousemove","mousedown","mouseup","mouseover"],KeyboardEvents:["keydown"]},EVENT_MAP_INV={};Common.each(EVENT_MAP,function(t,e){Common.each(t,function(n){EVENT_MAP_INV[n]=e})});var CSS_VALUE_PIXELS=/(\d+(\.\d+)?)px/;function cssValueToPixels(t){if(t==="0"||Common.isUndefined(t))return 0;var e=t.match(CSS_VALUE_PIXELS);return Common.isNull(e)?0:parseFloat(e[1])}var dom={makeSelectable:function(e,n){e===void 0||e.style===void 0||(e.onselectstart=n?function(){return!1}:function(){},e.style.MozUserSelect=n?"auto":"none",e.style.KhtmlUserSelect=n?"auto":"none",e.unselectable=n?"on":"off")},makeFullscreen:function(e,n,r){var i=r,o=n;Common.isUndefined(o)&&(o=!0),Common.isUndefined(i)&&(i=!0),e.style.position="absolute",o&&(e.style.left=0,e.style.right=0),i&&(e.style.top=0,e.style.bottom=0)},fakeEvent:function(e,n,r,i){var o=r||{},a=EVENT_MAP_INV[n];if(!a)throw new Error("Event type "+n+" not supported.");var l=document.createEvent(a);switch(a){case"MouseEvents":{var A=o.x||o.clientX||0,E=o.y||o.clientY||0;l.initMouseEvent(n,o.bubbles||!1,o.cancelable||!0,window,o.clickCount||1,0,0,A,E,!1,!1,!1,!1,0,null);break}case"KeyboardEvents":{var v=l.initKeyboardEvent||l.initKeyEvent;Common.defaults(o,{cancelable:!0,ctrlKey:!1,altKey:!1,shiftKey:!1,metaKey:!1,keyCode:void 0,charCode:void 0}),v(n,o.bubbles||!1,o.cancelable,window,o.ctrlKey,o.altKey,o.shiftKey,o.metaKey,o.keyCode,o.charCode);break}default:{l.initEvent(n,o.bubbles||!1,o.cancelable||!0);break}}Common.defaults(l,i),e.dispatchEvent(l)},bind:function(e,n,r,i){var o=i||!1;return e.addEventListener?e.addEventListener(n,r,o):e.attachEvent&&e.attachEvent("on"+n,r),dom},unbind:function(e,n,r,i){var o=i||!1;return e.removeEventListener?e.removeEventListener(n,r,o):e.detachEvent&&e.detachEvent("on"+n,r),dom},addClass:function(e,n){if(e.className===void 0)e.className=n;else if(e.className!==n){var r=e.className.split(/ +/);r.indexOf(n)===-1&&(r.push(n),e.className=r.join(" ").replace(/^\s+/,"").replace(/\s+$/,""))}return dom},removeClass:function(e,n){if(n)if(e.className===n)e.removeAttribute("class");else{var r=e.className.split(/ +/),i=r.indexOf(n);i!==-1&&(r.splice(i,1),e.className=r.join(" "))}else e.className=void 0;return dom},hasClass:function(e,n){return new RegExp("(?:^|\\s+)"+n+"(?:\\s+|$)").test(e.className)||!1},getWidth:function(e){var n=getComputedStyle(e);return cssValueToPixels(n["border-left-width"])+cssValueToPixels(n["border-right-width"])+cssValueToPixels(n["padding-left"])+cssValueToPixels(n["padding-right"])+cssValueToPixels(n.width)},getHeight:function(e){var n=getComputedStyle(e);return cssValueToPixels(n["border-top-width"])+cssValueToPixels(n["border-bottom-width"])+cssValueToPixels(n["padding-top"])+cssValueToPixels(n["padding-bottom"])+cssValueToPixels(n.height)},getOffset:function(e){var n=e,r={left:0,top:0};if(n.offsetParent)do r.left+=n.offsetLeft,r.top+=n.offsetTop,n=n.offsetParent;while(n);return r},isActive:function(e){return e===document.activeElement&&(e.type||e.href)}},BooleanController=(function(t){inherits(e,t);function e(n,r){classCallCheck(this,e);var i=possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,n,r)),o=i;i.__prev=i.getValue(),i.__checkbox=document.createElement("input"),i.__checkbox.setAttribute("type","checkbox");function a(){o.setValue(!o.__prev)}return dom.bind(i.__checkbox,"change",a,!1),i.domElement.appendChild(i.__checkbox),i.updateDisplay(),i}return createClass(e,[{key:"setValue",value:function(r){var i=get(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"setValue",this).call(this,r);return this.__onFinishChange&&this.__onFinishChange.call(this,this.getValue()),this.__prev=this.getValue(),i}},{key:"updateDisplay",value:function(){return this.getValue()===!0?(this.__checkbox.setAttribute("checked","checked"),this.__checkbox.checked=!0,this.__prev=!0):(this.__checkbox.checked=!1,this.__prev=!1),get(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"updateDisplay",this).call(this)}}]),e})(Controller),OptionController=(function(t){inherits(e,t);function e(n,r,i){classCallCheck(this,e);var o=possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,n,r)),a=i,l=o;if(o.__select=document.createElement("select"),Common.isArray(a)){var A={};Common.each(a,function(E){A[E]=E}),a=A}return Common.each(a,function(E,v){var x=document.createElement("option");x.innerHTML=v,x.setAttribute("value",E),l.__select.appendChild(x)}),o.updateDisplay(),dom.bind(o.__select,"change",function(){var E=this.options[this.selectedIndex].value;l.setValue(E)}),o.domElement.appendChild(o.__select),o}return createClass(e,[{key:"setValue",value:function(r){var i=get(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"setValue",this).call(this,r);return this.__onFinishChange&&this.__onFinishChange.call(this,this.getValue()),i}},{key:"updateDisplay",value:function(){return dom.isActive(this.__select)?this:(this.__select.value=this.getValue(),get(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"updateDisplay",this).call(this))}}]),e})(Controller),StringController=(function(t){inherits(e,t);function e(n,r){classCallCheck(this,e);var i=possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,n,r)),o=i;function a(){o.setValue(o.__input.value)}function l(){o.__onFinishChange&&o.__onFinishChange.call(o,o.getValue())}return i.__input=document.createElement("input"),i.__input.setAttribute("type","text"),dom.bind(i.__input,"keyup",a),dom.bind(i.__input,"change",a),dom.bind(i.__input,"blur",l),dom.bind(i.__input,"keydown",function(A){A.keyCode===13&&this.blur()}),i.updateDisplay(),i.domElement.appendChild(i.__input),i}return createClass(e,[{key:"updateDisplay",value:function(){return dom.isActive(this.__input)||(this.__input.value=this.getValue()),get(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"updateDisplay",this).call(this)}}]),e})(Controller);function numDecimals(t){var e=t.toString();return e.indexOf(".")>-1?e.length-e.indexOf(".")-1:0}var NumberController=(function(t){inherits(e,t);function e(n,r,i){classCallCheck(this,e);var o=possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,n,r)),a=i||{};return o.__min=a.min,o.__max=a.max,o.__step=a.step,Common.isUndefined(o.__step)?o.initialValue===0?o.__impliedStep=1:o.__impliedStep=Math.pow(10,Math.floor(Math.log(Math.abs(o.initialValue))/Math.LN10))/10:o.__impliedStep=o.__step,o.__precision=numDecimals(o.__impliedStep),o}return createClass(e,[{key:"setValue",value:function(r){var i=r;return this.__min!==void 0&&i<this.__min?i=this.__min:this.__max!==void 0&&i>this.__max&&(i=this.__max),this.__step!==void 0&&i%this.__step!==0&&(i=Math.round(i/this.__step)*this.__step),get(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"setValue",this).call(this,i)}},{key:"min",value:function(r){return this.__min=r,this}},{key:"max",value:function(r){return this.__max=r,this}},{key:"step",value:function(r){return this.__step=r,this.__impliedStep=r,this.__precision=numDecimals(r),this}}]),e})(Controller);function roundToDecimal(t,e){var n=Math.pow(10,e);return Math.round(t*n)/n}var NumberControllerBox=(function(t){inherits(e,t);function e(n,r,i){classCallCheck(this,e);var o=possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,n,r,i));o.__truncationSuspended=!1;var a=o,l=void 0;function A(){var O=parseFloat(a.__input.value);Common.isNaN(O)||a.setValue(O)}function E(){a.__onFinishChange&&a.__onFinishChange.call(a,a.getValue())}function v(){E()}function x(O){var U=l-O.clientY;a.setValue(a.getValue()+U*a.__impliedStep),l=O.clientY}function R(){dom.unbind(window,"mousemove",x),dom.unbind(window,"mouseup",R),E()}function D(O){dom.bind(window,"mousemove",x),dom.bind(window,"mouseup",R),l=O.clientY}return o.__input=document.createElement("input"),o.__input.setAttribute("type","text"),dom.bind(o.__input,"change",A),dom.bind(o.__input,"blur",v),dom.bind(o.__input,"mousedown",D),dom.bind(o.__input,"keydown",function(O){O.keyCode===13&&(a.__truncationSuspended=!0,this.blur(),a.__truncationSuspended=!1,E())}),o.updateDisplay(),o.domElement.appendChild(o.__input),o}return createClass(e,[{key:"updateDisplay",value:function(){return this.__input.value=this.__truncationSuspended?this.getValue():roundToDecimal(this.getValue(),this.__precision),get(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"updateDisplay",this).call(this)}}]),e})(NumberController);function map(t,e,n,r,i){return r+(i-r)*((t-e)/(n-e))}var NumberControllerSlider=(function(t){inherits(e,t);function e(n,r,i,o,a){classCallCheck(this,e);var l=possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,n,r,{min:i,max:o,step:a})),A=l;l.__background=document.createElement("div"),l.__foreground=document.createElement("div"),dom.bind(l.__background,"mousedown",E),dom.bind(l.__background,"touchstart",R),dom.addClass(l.__background,"slider"),dom.addClass(l.__foreground,"slider-fg");function E(U){document.activeElement.blur(),dom.bind(window,"mousemove",v),dom.bind(window,"mouseup",x),v(U)}function v(U){U.preventDefault();var H=A.__background.getBoundingClientRect();return A.setValue(map(U.clientX,H.left,H.right,A.__min,A.__max)),!1}function x(){dom.unbind(window,"mousemove",v),dom.unbind(window,"mouseup",x),A.__onFinishChange&&A.__onFinishChange.call(A,A.getValue())}function R(U){U.touches.length===1&&(dom.bind(window,"touchmove",D),dom.bind(window,"touchend",O),D(U))}function D(U){var H=U.touches[0].clientX,$=A.__background.getBoundingClientRect();A.setValue(map(H,$.left,$.right,A.__min,A.__max))}function O(){dom.unbind(window,"touchmove",D),dom.unbind(window,"touchend",O),A.__onFinishChange&&A.__onFinishChange.call(A,A.getValue())}return l.updateDisplay(),l.__background.appendChild(l.__foreground),l.domElement.appendChild(l.__background),l}return createClass(e,[{key:"updateDisplay",value:function(){var r=(this.getValue()-this.__min)/(this.__max-this.__min);return this.__foreground.style.width=r*100+"%",get(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"updateDisplay",this).call(this)}}]),e})(NumberController),FunctionController=(function(t){inherits(e,t);function e(n,r,i){classCallCheck(this,e);var o=possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,n,r)),a=o;return o.__button=document.createElement("div"),o.__button.innerHTML=i===void 0?"Fire":i,dom.bind(o.__button,"click",function(l){return l.preventDefault(),a.fire(),!1}),dom.addClass(o.__button,"button"),o.domElement.appendChild(o.__button),o}return createClass(e,[{key:"fire",value:function(){this.__onChange&&this.__onChange.call(this),this.getValue().call(this.object),this.__onFinishChange&&this.__onFinishChange.call(this,this.getValue())}}]),e})(Controller),ColorController=(function(t){inherits(e,t);function e(n,r){classCallCheck(this,e);var i=possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,n,r));i.__color=new Color(i.getValue()),i.__temp=new Color(0);var o=i;i.domElement=document.createElement("div"),dom.makeSelectable(i.domElement,!1),i.__selector=document.createElement("div"),i.__selector.className="selector",i.__saturation_field=document.createElement("div"),i.__saturation_field.className="saturation-field",i.__field_knob=document.createElement("div"),i.__field_knob.className="field-knob",i.__field_knob_border="2px solid ",i.__hue_knob=document.createElement("div"),i.__hue_knob.className="hue-knob",i.__hue_field=document.createElement("div"),i.__hue_field.className="hue-field",i.__input=document.createElement("input"),i.__input.type="text",i.__input_textShadow="0 1px 1px ",dom.bind(i.__input,"keydown",function(U){U.keyCode===13&&x.call(this)}),dom.bind(i.__input,"blur",x),dom.bind(i.__selector,"mousedown",function(){dom.addClass(this,"drag").bind(window,"mouseup",function(){dom.removeClass(o.__selector,"drag")})}),dom.bind(i.__selector,"touchstart",function(){dom.addClass(this,"drag").bind(window,"touchend",function(){dom.removeClass(o.__selector,"drag")})});var a=document.createElement("div");Common.extend(i.__selector.style,{width:"122px",height:"102px",padding:"3px",backgroundColor:"#222",boxShadow:"0px 1px 3px rgba(0,0,0,0.3)"}),Common.extend(i.__field_knob.style,{position:"absolute",width:"12px",height:"12px",border:i.__field_knob_border+(i.__color.v<.5?"#fff":"#000"),boxShadow:"0px 1px 3px rgba(0,0,0,0.5)",borderRadius:"12px",zIndex:1}),Common.extend(i.__hue_knob.style,{position:"absolute",width:"15px",height:"2px",borderRight:"4px solid #fff",zIndex:1}),Common.extend(i.__saturation_field.style,{width:"100px",height:"100px",border:"1px solid #555",marginRight:"3px",display:"inline-block",cursor:"pointer"}),Common.extend(a.style,{width:"100%",height:"100%",background:"none"}),linearGradient(a,"top","rgba(0,0,0,0)","#000"),Common.extend(i.__hue_field.style,{width:"15px",height:"100px",border:"1px solid #555",cursor:"ns-resize",position:"absolute",top:"3px",right:"3px"}),hueGradient(i.__hue_field),Common.extend(i.__input.style,{outline:"none",textAlign:"center",color:"#fff",border:0,fontWeight:"bold",textShadow:i.__input_textShadow+"rgba(0,0,0,0.7)"}),dom.bind(i.__saturation_field,"mousedown",l),dom.bind(i.__saturation_field,"touchstart",l),dom.bind(i.__field_knob,"mousedown",l),dom.bind(i.__field_knob,"touchstart",l),dom.bind(i.__hue_field,"mousedown",A),dom.bind(i.__hue_field,"touchstart",A);function l(U){D(U),dom.bind(window,"mousemove",D),dom.bind(window,"touchmove",D),dom.bind(window,"mouseup",E),dom.bind(window,"touchend",E)}function A(U){O(U),dom.bind(window,"mousemove",O),dom.bind(window,"touchmove",O),dom.bind(window,"mouseup",v),dom.bind(window,"touchend",v)}function E(){dom.unbind(window,"mousemove",D),dom.unbind(window,"touchmove",D),dom.unbind(window,"mouseup",E),dom.unbind(window,"touchend",E),R()}function v(){dom.unbind(window,"mousemove",O),dom.unbind(window,"touchmove",O),dom.unbind(window,"mouseup",v),dom.unbind(window,"touchend",v),R()}function x(){var U=interpret(this.value);U!==!1?(o.__color.__state=U,o.setValue(o.__color.toOriginal())):this.value=o.__color.toString()}function R(){o.__onFinishChange&&o.__onFinishChange.call(o,o.__color.toOriginal())}i.__saturation_field.appendChild(a),i.__selector.appendChild(i.__field_knob),i.__selector.appendChild(i.__saturation_field),i.__selector.appendChild(i.__hue_field),i.__hue_field.appendChild(i.__hue_knob),i.domElement.appendChild(i.__input),i.domElement.appendChild(i.__selector),i.updateDisplay();function D(U){U.type.indexOf("touch")===-1&&U.preventDefault();var H=o.__saturation_field.getBoundingClientRect(),$=U.touches&&U.touches[0]||U,X=$.clientX,V=$.clientY,q=(X-H.left)/(H.right-H.left),te=1-(V-H.top)/(H.bottom-H.top);return te>1?te=1:te<0&&(te=0),q>1?q=1:q<0&&(q=0),o.__color.v=te,o.__color.s=q,o.setValue(o.__color.toOriginal()),!1}function O(U){U.type.indexOf("touch")===-1&&U.preventDefault();var H=o.__hue_field.getBoundingClientRect(),$=U.touches&&U.touches[0]||U,X=$.clientY,V=1-(X-H.top)/(H.bottom-H.top);return V>1?V=1:V<0&&(V=0),o.__color.h=V*360,o.setValue(o.__color.toOriginal()),!1}return i}return createClass(e,[{key:"updateDisplay",value:function(){var r=interpret(this.getValue());if(r!==!1){var i=!1;Common.each(Color.COMPONENTS,function(l){if(!Common.isUndefined(r[l])&&!Common.isUndefined(this.__color.__state[l])&&r[l]!==this.__color.__state[l])return i=!0,{}},this),i&&Common.extend(this.__color.__state,r)}Common.extend(this.__temp.__state,this.__color.__state),this.__temp.a=1;var o=this.__color.v<.5||this.__color.s>.5?255:0,a=255-o;Common.extend(this.__field_knob.style,{marginLeft:100*this.__color.s-7+"px",marginTop:100*(1-this.__color.v)-7+"px",backgroundColor:this.__temp.toHexString(),border:this.__field_knob_border+"rgb("+o+","+o+","+o+")"}),this.__hue_knob.style.marginTop=(1-this.__color.h/360)*100+"px",this.__temp.s=1,this.__temp.v=1,linearGradient(this.__saturation_field,"left","#fff",this.__temp.toHexString()),this.__input.value=this.__color.toString(),Common.extend(this.__input.style,{backgroundColor:this.__color.toHexString(),color:"rgb("+o+","+o+","+o+")",textShadow:this.__input_textShadow+"rgba("+a+","+a+","+a+",.7)"})}}]),e})(Controller),vendors=["-moz-","-o-","-webkit-","-ms-",""];function linearGradient(t,e,n,r){t.style.background="",Common.each(vendors,function(i){t.style.cssText+="background: "+i+"linear-gradient("+e+", "+n+" 0%, "+r+" 100%); "})}function hueGradient(t){t.style.background="",t.style.cssText+="background: -moz-linear-gradient(top,  #ff0000 0%, #ff00ff 17%, #0000ff 34%, #00ffff 50%, #00ff00 67%, #ffff00 84%, #ff0000 100%);",t.style.cssText+="background: -webkit-linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);",t.style.cssText+="background: -o-linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);",t.style.cssText+="background: -ms-linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);",t.style.cssText+="background: linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);"}var css={load:function(e,n){var r=n||document,i=r.createElement("link");i.type="text/css",i.rel="stylesheet",i.href=e,r.getElementsByTagName("head")[0].appendChild(i)},inject:function(e,n){var r=n||document,i=document.createElement("style");i.type="text/css",i.innerHTML=e;var o=r.getElementsByTagName("head")[0];try{o.appendChild(i)}catch{}}},saveDialogContents=`<div id="dg-save" class="dg dialogue">

  Here's the new load parameter for your <code>GUI</code>'s constructor:

  <textarea id="dg-new-constructor"></textarea>

  <div id="dg-save-locally">

    <input id="dg-local-storage" type="checkbox"/> Automatically save
    values to <code>localStorage</code> on exit.

    <div id="dg-local-explain">The values saved to <code>localStorage</code> will
      override those passed to <code>dat.GUI</code>'s constructor. This makes it
      easier to work incrementally, but <code>localStorage</code> is fragile,
      and your friends may not see the same values you do.

    </div>

  </div>

</div>`,ControllerFactory=function(e,n){var r=e[n];return Common.isArray(arguments[2])||Common.isObject(arguments[2])?new OptionController(e,n,arguments[2]):Common.isNumber(r)?Common.isNumber(arguments[2])&&Common.isNumber(arguments[3])?Common.isNumber(arguments[4])?new NumberControllerSlider(e,n,arguments[2],arguments[3],arguments[4]):new NumberControllerSlider(e,n,arguments[2],arguments[3]):Common.isNumber(arguments[4])?new NumberControllerBox(e,n,{min:arguments[2],max:arguments[3],step:arguments[4]}):new NumberControllerBox(e,n,{min:arguments[2],max:arguments[3]}):Common.isString(r)?new StringController(e,n):Common.isFunction(r)?new FunctionController(e,n,""):Common.isBoolean(r)?new BooleanController(e,n):null};function requestAnimationFrame$1(t){setTimeout(t,1e3/60)}var requestAnimationFrame$1$1=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||requestAnimationFrame$1,CenteredDiv=(function(){function t(){classCallCheck(this,t),this.backgroundElement=document.createElement("div"),Common.extend(this.backgroundElement.style,{backgroundColor:"rgba(0,0,0,0.8)",top:0,left:0,display:"none",zIndex:"1000",opacity:0,WebkitTransition:"opacity 0.2s linear",transition:"opacity 0.2s linear"}),dom.makeFullscreen(this.backgroundElement),this.backgroundElement.style.position="fixed",this.domElement=document.createElement("div"),Common.extend(this.domElement.style,{position:"fixed",display:"none",zIndex:"1001",opacity:0,WebkitTransition:"-webkit-transform 0.2s ease-out, opacity 0.2s linear",transition:"transform 0.2s ease-out, opacity 0.2s linear"}),document.body.appendChild(this.backgroundElement),document.body.appendChild(this.domElement);var e=this;dom.bind(this.backgroundElement,"click",function(){e.hide()})}return createClass(t,[{key:"show",value:function(){var n=this;this.backgroundElement.style.display="block",this.domElement.style.display="block",this.domElement.style.opacity=0,this.domElement.style.webkitTransform="scale(1.1)",this.layout(),Common.defer(function(){n.backgroundElement.style.opacity=1,n.domElement.style.opacity=1,n.domElement.style.webkitTransform="scale(1)"})}},{key:"hide",value:function(){var n=this,r=function i(){n.domElement.style.display="none",n.backgroundElement.style.display="none",dom.unbind(n.domElement,"webkitTransitionEnd",i),dom.unbind(n.domElement,"transitionend",i),dom.unbind(n.domElement,"oTransitionEnd",i)};dom.bind(this.domElement,"webkitTransitionEnd",r),dom.bind(this.domElement,"transitionend",r),dom.bind(this.domElement,"oTransitionEnd",r),this.backgroundElement.style.opacity=0,this.domElement.style.opacity=0,this.domElement.style.webkitTransform="scale(1.1)"}},{key:"layout",value:function(){this.domElement.style.left=window.innerWidth/2-dom.getWidth(this.domElement)/2+"px",this.domElement.style.top=window.innerHeight/2-dom.getHeight(this.domElement)/2+"px"}}]),t})(),styleSheet=___$insertStyle(`.dg ul{list-style:none;margin:0;padding:0;width:100%;clear:both}.dg.ac{position:fixed;top:0;left:0;right:0;height:0;z-index:0}.dg:not(.ac) .main{overflow:hidden}.dg.main{-webkit-transition:opacity .1s linear;-o-transition:opacity .1s linear;-moz-transition:opacity .1s linear;transition:opacity .1s linear}.dg.main.taller-than-window{overflow-y:auto}.dg.main.taller-than-window .close-button{opacity:1;margin-top:-1px;border-top:1px solid #2c2c2c}.dg.main ul.closed .close-button{opacity:1 !important}.dg.main:hover .close-button,.dg.main .close-button.drag{opacity:1}.dg.main .close-button{-webkit-transition:opacity .1s linear;-o-transition:opacity .1s linear;-moz-transition:opacity .1s linear;transition:opacity .1s linear;border:0;line-height:19px;height:20px;cursor:pointer;text-align:center;background-color:#000}.dg.main .close-button.close-top{position:relative}.dg.main .close-button.close-bottom{position:absolute}.dg.main .close-button:hover{background-color:#111}.dg.a{float:right;margin-right:15px;overflow-y:visible}.dg.a.has-save>ul.close-top{margin-top:0}.dg.a.has-save>ul.close-bottom{margin-top:27px}.dg.a.has-save>ul.closed{margin-top:0}.dg.a .save-row{top:0;z-index:1002}.dg.a .save-row.close-top{position:relative}.dg.a .save-row.close-bottom{position:fixed}.dg li{-webkit-transition:height .1s ease-out;-o-transition:height .1s ease-out;-moz-transition:height .1s ease-out;transition:height .1s ease-out;-webkit-transition:overflow .1s linear;-o-transition:overflow .1s linear;-moz-transition:overflow .1s linear;transition:overflow .1s linear}.dg li:not(.folder){cursor:auto;height:27px;line-height:27px;padding:0 4px 0 5px}.dg li.folder{padding:0;border-left:4px solid rgba(0,0,0,0)}.dg li.title{cursor:pointer;margin-left:-4px}.dg .closed li:not(.title),.dg .closed ul li,.dg .closed ul li>*{height:0;overflow:hidden;border:0}.dg .cr{clear:both;padding-left:3px;height:27px;overflow:hidden}.dg .property-name{cursor:default;float:left;clear:left;width:40%;overflow:hidden;text-overflow:ellipsis}.dg .cr.function .property-name{width:100%}.dg .c{float:left;width:60%;position:relative}.dg .c input[type=text]{border:0;margin-top:4px;padding:3px;width:100%;float:right}.dg .has-slider input[type=text]{width:30%;margin-left:0}.dg .slider{float:left;width:66%;margin-left:-5px;margin-right:0;height:19px;margin-top:4px}.dg .slider-fg{height:100%}.dg .c input[type=checkbox]{margin-top:7px}.dg .c select{margin-top:5px}.dg .cr.function,.dg .cr.function .property-name,.dg .cr.function *,.dg .cr.boolean,.dg .cr.boolean *{cursor:pointer}.dg .cr.color{overflow:visible}.dg .selector{display:none;position:absolute;margin-left:-9px;margin-top:23px;z-index:10}.dg .c:hover .selector,.dg .selector.drag{display:block}.dg li.save-row{padding:0}.dg li.save-row .button{display:inline-block;padding:0px 6px}.dg.dialogue{background-color:#222;width:460px;padding:15px;font-size:13px;line-height:15px}#dg-new-constructor{padding:10px;color:#222;font-family:Monaco, monospace;font-size:10px;border:0;resize:none;box-shadow:inset 1px 1px 1px #888;word-wrap:break-word;margin:12px 0;display:block;width:440px;overflow-y:scroll;height:100px;position:relative}#dg-local-explain{display:none;font-size:11px;line-height:17px;border-radius:3px;background-color:#333;padding:8px;margin-top:10px}#dg-local-explain code{font-size:10px}#dat-gui-save-locally{display:none}.dg{color:#eee;font:11px 'Lucida Grande', sans-serif;text-shadow:0 -1px 0 #111}.dg.main::-webkit-scrollbar{width:5px;background:#1a1a1a}.dg.main::-webkit-scrollbar-corner{height:0;display:none}.dg.main::-webkit-scrollbar-thumb{border-radius:5px;background:#676767}.dg li:not(.folder){background:#1a1a1a;border-bottom:1px solid #2c2c2c}.dg li.save-row{line-height:25px;background:#dad5cb;border:0}.dg li.save-row select{margin-left:5px;width:108px}.dg li.save-row .button{margin-left:5px;margin-top:1px;border-radius:2px;font-size:9px;line-height:7px;padding:4px 4px 5px 4px;background:#c5bdad;color:#fff;text-shadow:0 1px 0 #b0a58f;box-shadow:0 -1px 0 #b0a58f;cursor:pointer}.dg li.save-row .button.gears{background:#c5bdad url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAsAAAANCAYAAAB/9ZQ7AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAQJJREFUeNpiYKAU/P//PwGIC/ApCABiBSAW+I8AClAcgKxQ4T9hoMAEUrxx2QSGN6+egDX+/vWT4e7N82AMYoPAx/evwWoYoSYbACX2s7KxCxzcsezDh3evFoDEBYTEEqycggWAzA9AuUSQQgeYPa9fPv6/YWm/Acx5IPb7ty/fw+QZblw67vDs8R0YHyQhgObx+yAJkBqmG5dPPDh1aPOGR/eugW0G4vlIoTIfyFcA+QekhhHJhPdQxbiAIguMBTQZrPD7108M6roWYDFQiIAAv6Aow/1bFwXgis+f2LUAynwoIaNcz8XNx3Dl7MEJUDGQpx9gtQ8YCueB+D26OECAAQDadt7e46D42QAAAABJRU5ErkJggg==) 2px 1px no-repeat;height:7px;width:8px}.dg li.save-row .button:hover{background-color:#bab19e;box-shadow:0 -1px 0 #b0a58f}.dg li.folder{border-bottom:0}.dg li.title{padding-left:16px;background:#000 url(data:image/gif;base64,R0lGODlhBQAFAJEAAP////Pz8////////yH5BAEAAAIALAAAAAAFAAUAAAIIlI+hKgFxoCgAOw==) 6px 10px no-repeat;cursor:pointer;border-bottom:1px solid rgba(255,255,255,0.2)}.dg .closed li.title{background-image:url(data:image/gif;base64,R0lGODlhBQAFAJEAAP////Pz8////////yH5BAEAAAIALAAAAAAFAAUAAAIIlGIWqMCbWAEAOw==)}.dg .cr.boolean{border-left:3px solid #806787}.dg .cr.color{border-left:3px solid}.dg .cr.function{border-left:3px solid #e61d5f}.dg .cr.number{border-left:3px solid #2FA1D6}.dg .cr.number input[type=text]{color:#2FA1D6}.dg .cr.string{border-left:3px solid #1ed36f}.dg .cr.string input[type=text]{color:#1ed36f}.dg .cr.function:hover,.dg .cr.boolean:hover{background:#111}.dg .c input[type=text]{background:#303030;outline:none}.dg .c input[type=text]:hover{background:#3c3c3c}.dg .c input[type=text]:focus{background:#494949;color:#fff}.dg .c .slider{background:#303030;cursor:ew-resize}.dg .c .slider-fg{background:#2FA1D6;max-width:100%}.dg .c .slider:hover{background:#3c3c3c}.dg .c .slider:hover .slider-fg{background:#44abda}
`);css.inject(styleSheet);var CSS_NAMESPACE="dg",HIDE_KEY_CODE=72,CLOSE_BUTTON_HEIGHT=20,DEFAULT_DEFAULT_PRESET_NAME="Default",SUPPORTS_LOCAL_STORAGE=(function(){try{return!!window.localStorage}catch{return!1}})(),SAVE_DIALOGUE=void 0,autoPlaceVirgin=!0,autoPlaceContainer=void 0,hide=!1,hideableGuis=[],GUI=function t(e){var n=this,r=e||{};this.domElement=document.createElement("div"),this.__ul=document.createElement("ul"),this.domElement.appendChild(this.__ul),dom.addClass(this.domElement,CSS_NAMESPACE),this.__folders={},this.__controllers=[],this.__rememberedObjects=[],this.__rememberedObjectIndecesToControllers=[],this.__listening=[],r=Common.defaults(r,{closeOnTop:!1,autoPlace:!0,width:t.DEFAULT_WIDTH}),r=Common.defaults(r,{resizable:r.autoPlace,hideable:r.autoPlace}),Common.isUndefined(r.load)?r.load={preset:DEFAULT_DEFAULT_PRESET_NAME}:r.preset&&(r.load.preset=r.preset),Common.isUndefined(r.parent)&&r.hideable&&hideableGuis.push(this),r.resizable=Common.isUndefined(r.parent)&&r.resizable,r.autoPlace&&Common.isUndefined(r.scrollable)&&(r.scrollable=!0);var i=SUPPORTS_LOCAL_STORAGE&&localStorage.getItem(getLocalStorageHash(this,"isLocal"))==="true",o=void 0,a=void 0;if(Object.defineProperties(this,{parent:{get:function(){return r.parent}},scrollable:{get:function(){return r.scrollable}},autoPlace:{get:function(){return r.autoPlace}},closeOnTop:{get:function(){return r.closeOnTop}},preset:{get:function(){return n.parent?n.getRoot().preset:r.load.preset},set:function(R){n.parent?n.getRoot().preset=R:r.load.preset=R,setPresetSelectIndex(this),n.revert()}},width:{get:function(){return r.width},set:function(R){r.width=R,setWidth(n,R)}},name:{get:function(){return r.name},set:function(R){r.name=R,a&&(a.innerHTML=r.name)}},closed:{get:function(){return r.closed},set:function(R){r.closed=R,r.closed?dom.addClass(n.__ul,t.CLASS_CLOSED):dom.removeClass(n.__ul,t.CLASS_CLOSED),this.onResize(),n.__closeButton&&(n.__closeButton.innerHTML=R?t.TEXT_OPEN:t.TEXT_CLOSED)}},load:{get:function(){return r.load}},useLocalStorage:{get:function(){return i},set:function(R){SUPPORTS_LOCAL_STORAGE&&(i=R,R?dom.bind(window,"unload",o):dom.unbind(window,"unload",o),localStorage.setItem(getLocalStorageHash(n,"isLocal"),R))}}}),Common.isUndefined(r.parent)){if(this.closed=r.closed||!1,dom.addClass(this.domElement,t.CLASS_MAIN),dom.makeSelectable(this.domElement,!1),SUPPORTS_LOCAL_STORAGE&&i){n.useLocalStorage=!0;var l=localStorage.getItem(getLocalStorageHash(this,"gui"));l&&(r.load=JSON.parse(l))}this.__closeButton=document.createElement("div"),this.__closeButton.innerHTML=t.TEXT_CLOSED,dom.addClass(this.__closeButton,t.CLASS_CLOSE_BUTTON),r.closeOnTop?(dom.addClass(this.__closeButton,t.CLASS_CLOSE_TOP),this.domElement.insertBefore(this.__closeButton,this.domElement.childNodes[0])):(dom.addClass(this.__closeButton,t.CLASS_CLOSE_BOTTOM),this.domElement.appendChild(this.__closeButton)),dom.bind(this.__closeButton,"click",function(){n.closed=!n.closed})}else{r.closed===void 0&&(r.closed=!0);var A=document.createTextNode(r.name);dom.addClass(A,"controller-name"),a=addRow(n,A);var E=function(R){return R.preventDefault(),n.closed=!n.closed,!1};dom.addClass(this.__ul,t.CLASS_CLOSED),dom.addClass(a,"title"),dom.bind(a,"click",E),r.closed||(this.closed=!1)}r.autoPlace&&(Common.isUndefined(r.parent)&&(autoPlaceVirgin&&(autoPlaceContainer=document.createElement("div"),dom.addClass(autoPlaceContainer,CSS_NAMESPACE),dom.addClass(autoPlaceContainer,t.CLASS_AUTO_PLACE_CONTAINER),document.body.appendChild(autoPlaceContainer),autoPlaceVirgin=!1),autoPlaceContainer.appendChild(this.domElement),dom.addClass(this.domElement,t.CLASS_AUTO_PLACE)),this.parent||setWidth(n,r.width)),this.__resizeHandler=function(){n.onResizeDebounced()},dom.bind(window,"resize",this.__resizeHandler),dom.bind(this.__ul,"webkitTransitionEnd",this.__resizeHandler),dom.bind(this.__ul,"transitionend",this.__resizeHandler),dom.bind(this.__ul,"oTransitionEnd",this.__resizeHandler),this.onResize(),r.resizable&&addResizeHandle(this),o=function(){SUPPORTS_LOCAL_STORAGE&&localStorage.getItem(getLocalStorageHash(n,"isLocal"))==="true"&&localStorage.setItem(getLocalStorageHash(n,"gui"),JSON.stringify(n.getSaveObject()))},this.saveToLocalStorageIfPossible=o;function v(){var x=n.getRoot();x.width+=1,Common.defer(function(){x.width-=1})}r.parent||v()};GUI.toggleHide=function(){hide=!hide,Common.each(hideableGuis,function(t){t.domElement.style.display=hide?"none":""})};GUI.CLASS_AUTO_PLACE="a";GUI.CLASS_AUTO_PLACE_CONTAINER="ac";GUI.CLASS_MAIN="main";GUI.CLASS_CONTROLLER_ROW="cr";GUI.CLASS_TOO_TALL="taller-than-window";GUI.CLASS_CLOSED="closed";GUI.CLASS_CLOSE_BUTTON="close-button";GUI.CLASS_CLOSE_TOP="close-top";GUI.CLASS_CLOSE_BOTTOM="close-bottom";GUI.CLASS_DRAG="drag";GUI.DEFAULT_WIDTH=245;GUI.TEXT_CLOSED="Close Controls";GUI.TEXT_OPEN="Open Controls";GUI._keydownHandler=function(t){document.activeElement.type!=="text"&&(t.which===HIDE_KEY_CODE||t.keyCode===HIDE_KEY_CODE)&&GUI.toggleHide()};dom.bind(window,"keydown",GUI._keydownHandler,!1);Common.extend(GUI.prototype,{add:function(e,n){return _add(this,e,n,{factoryArgs:Array.prototype.slice.call(arguments,2)})},addColor:function(e,n){return _add(this,e,n,{color:!0})},remove:function(e){this.__ul.removeChild(e.__li),this.__controllers.splice(this.__controllers.indexOf(e),1);var n=this;Common.defer(function(){n.onResize()})},destroy:function(){if(this.parent)throw new Error("Only the root GUI should be removed with .destroy(). For subfolders, use gui.removeFolder(folder) instead.");this.autoPlace&&autoPlaceContainer.removeChild(this.domElement);var e=this;Common.each(this.__folders,function(n){e.removeFolder(n)}),dom.unbind(window,"keydown",GUI._keydownHandler,!1),removeListeners(this)},addFolder:function(e){if(this.__folders[e]!==void 0)throw new Error('You already have a folder in this GUI by the name "'+e+'"');var n={name:e,parent:this};n.autoPlace=this.autoPlace,this.load&&this.load.folders&&this.load.folders[e]&&(n.closed=this.load.folders[e].closed,n.load=this.load.folders[e]);var r=new GUI(n);this.__folders[e]=r;var i=addRow(this,r.domElement);return dom.addClass(i,"folder"),r},removeFolder:function(e){this.__ul.removeChild(e.domElement.parentElement),delete this.__folders[e.name],this.load&&this.load.folders&&this.load.folders[e.name]&&delete this.load.folders[e.name],removeListeners(e);var n=this;Common.each(e.__folders,function(r){e.removeFolder(r)}),Common.defer(function(){n.onResize()})},open:function(){this.closed=!1},close:function(){this.closed=!0},hide:function(){this.domElement.style.display="none"},show:function(){this.domElement.style.display=""},onResize:function(){var e=this.getRoot();if(e.scrollable){var n=dom.getOffset(e.__ul).top,r=0;Common.each(e.__ul.childNodes,function(i){e.autoPlace&&i===e.__save_row||(r+=dom.getHeight(i))}),window.innerHeight-n-CLOSE_BUTTON_HEIGHT<r?(dom.addClass(e.domElement,GUI.CLASS_TOO_TALL),e.__ul.style.height=window.innerHeight-n-CLOSE_BUTTON_HEIGHT+"px"):(dom.removeClass(e.domElement,GUI.CLASS_TOO_TALL),e.__ul.style.height="auto")}e.__resize_handle&&Common.defer(function(){e.__resize_handle.style.height=e.__ul.offsetHeight+"px"}),e.__closeButton&&(e.__closeButton.style.width=e.width+"px")},onResizeDebounced:Common.debounce(function(){this.onResize()},50),remember:function(){if(Common.isUndefined(SAVE_DIALOGUE)&&(SAVE_DIALOGUE=new CenteredDiv,SAVE_DIALOGUE.domElement.innerHTML=saveDialogContents),this.parent)throw new Error("You can only call remember on a top level GUI.");var e=this;Common.each(Array.prototype.slice.call(arguments),function(n){e.__rememberedObjects.length===0&&addSaveMenu(e),e.__rememberedObjects.indexOf(n)===-1&&e.__rememberedObjects.push(n)}),this.autoPlace&&setWidth(this,this.width)},getRoot:function(){for(var e=this;e.parent;)e=e.parent;return e},getSaveObject:function(){var e=this.load;return e.closed=this.closed,this.__rememberedObjects.length>0&&(e.preset=this.preset,e.remembered||(e.remembered={}),e.remembered[this.preset]=getCurrentPreset(this)),e.folders={},Common.each(this.__folders,function(n,r){e.folders[r]=n.getSaveObject()}),e},save:function(){this.load.remembered||(this.load.remembered={}),this.load.remembered[this.preset]=getCurrentPreset(this),markPresetModified(this,!1),this.saveToLocalStorageIfPossible()},saveAs:function(e){this.load.remembered||(this.load.remembered={},this.load.remembered[DEFAULT_DEFAULT_PRESET_NAME]=getCurrentPreset(this,!0)),this.load.remembered[e]=getCurrentPreset(this),this.preset=e,addPresetOption(this,e,!0),this.saveToLocalStorageIfPossible()},revert:function(e){Common.each(this.__controllers,function(n){this.getRoot().load.remembered?recallSavedValue(e||this.getRoot(),n):n.setValue(n.initialValue),n.__onFinishChange&&n.__onFinishChange.call(n,n.getValue())},this),Common.each(this.__folders,function(n){n.revert(n)}),e||markPresetModified(this.getRoot(),!1)},listen:function(e){var n=this.__listening.length===0;this.__listening.push(e),n&&updateDisplays(this.__listening)},updateDisplay:function(){Common.each(this.__controllers,function(e){e.updateDisplay()}),Common.each(this.__folders,function(e){e.updateDisplay()})}});function addRow(t,e,n){var r=document.createElement("li");return e&&r.appendChild(e),n?t.__ul.insertBefore(r,n):t.__ul.appendChild(r),t.onResize(),r}function removeListeners(t){dom.unbind(window,"resize",t.__resizeHandler),t.saveToLocalStorageIfPossible&&dom.unbind(window,"unload",t.saveToLocalStorageIfPossible)}function markPresetModified(t,e){var n=t.__preset_select[t.__preset_select.selectedIndex];e?n.innerHTML=n.value+"*":n.innerHTML=n.value}function augmentController(t,e,n){if(n.__li=e,n.__gui=t,Common.extend(n,{options:function(a){if(arguments.length>1){var l=n.__li.nextElementSibling;return n.remove(),_add(t,n.object,n.property,{before:l,factoryArgs:[Common.toArray(arguments)]})}if(Common.isArray(a)||Common.isObject(a)){var A=n.__li.nextElementSibling;return n.remove(),_add(t,n.object,n.property,{before:A,factoryArgs:[a]})}},name:function(a){return n.__li.firstElementChild.firstElementChild.innerHTML=a,n},listen:function(){return n.__gui.listen(n),n},remove:function(){return n.__gui.remove(n),n}}),n instanceof NumberControllerSlider){var r=new NumberControllerBox(n.object,n.property,{min:n.__min,max:n.__max,step:n.__step});Common.each(["updateDisplay","onChange","onFinishChange","step","min","max"],function(o){var a=n[o],l=r[o];n[o]=r[o]=function(){var A=Array.prototype.slice.call(arguments);return l.apply(r,A),a.apply(n,A)}}),dom.addClass(e,"has-slider"),n.domElement.insertBefore(r.domElement,n.domElement.firstElementChild)}else if(n instanceof NumberControllerBox){var i=function(a){if(Common.isNumber(n.__min)&&Common.isNumber(n.__max)){var l=n.__li.firstElementChild.firstElementChild.innerHTML,A=n.__gui.__listening.indexOf(n)>-1;n.remove();var E=_add(t,n.object,n.property,{before:n.__li.nextElementSibling,factoryArgs:[n.__min,n.__max,n.__step]});return E.name(l),A&&E.listen(),E}return a};n.min=Common.compose(i,n.min),n.max=Common.compose(i,n.max)}else n instanceof BooleanController?(dom.bind(e,"click",function(){dom.fakeEvent(n.__checkbox,"click")}),dom.bind(n.__checkbox,"click",function(o){o.stopPropagation()})):n instanceof FunctionController?(dom.bind(e,"click",function(){dom.fakeEvent(n.__button,"click")}),dom.bind(e,"mouseover",function(){dom.addClass(n.__button,"hover")}),dom.bind(e,"mouseout",function(){dom.removeClass(n.__button,"hover")})):n instanceof ColorController&&(dom.addClass(e,"color"),n.updateDisplay=Common.compose(function(o){return e.style.borderLeftColor=n.__color.toString(),o},n.updateDisplay),n.updateDisplay());n.setValue=Common.compose(function(o){return t.getRoot().__preset_select&&n.isModified()&&markPresetModified(t.getRoot(),!0),o},n.setValue)}function recallSavedValue(t,e){var n=t.getRoot(),r=n.__rememberedObjects.indexOf(e.object);if(r!==-1){var i=n.__rememberedObjectIndecesToControllers[r];if(i===void 0&&(i={},n.__rememberedObjectIndecesToControllers[r]=i),i[e.property]=e,n.load&&n.load.remembered){var o=n.load.remembered,a=void 0;if(o[t.preset])a=o[t.preset];else if(o[DEFAULT_DEFAULT_PRESET_NAME])a=o[DEFAULT_DEFAULT_PRESET_NAME];else return;if(a[r]&&a[r][e.property]!==void 0){var l=a[r][e.property];e.initialValue=l,e.setValue(l)}}}}function _add(t,e,n,r){if(e[n]===void 0)throw new Error('Object "'+e+'" has no property "'+n+'"');var i=void 0;if(r.color)i=new ColorController(e,n);else{var o=[e,n].concat(r.factoryArgs);i=ControllerFactory.apply(t,o)}r.before instanceof Controller&&(r.before=r.before.__li),recallSavedValue(t,i),dom.addClass(i.domElement,"c");var a=document.createElement("span");dom.addClass(a,"property-name"),a.innerHTML=i.property;var l=document.createElement("div");l.appendChild(a),l.appendChild(i.domElement);var A=addRow(t,l,r.before);return dom.addClass(A,GUI.CLASS_CONTROLLER_ROW),i instanceof ColorController?dom.addClass(A,"color"):dom.addClass(A,_typeof(i.getValue())),augmentController(t,A,i),t.__controllers.push(i),i}function getLocalStorageHash(t,e){return document.location.href+"."+e}function addPresetOption(t,e,n){var r=document.createElement("option");r.innerHTML=e,r.value=e,t.__preset_select.appendChild(r),n&&(t.__preset_select.selectedIndex=t.__preset_select.length-1)}function showHideExplain(t,e){e.style.display=t.useLocalStorage?"block":"none"}function addSaveMenu(t){var e=t.__save_row=document.createElement("li");dom.addClass(t.domElement,"has-save"),t.__ul.insertBefore(e,t.__ul.firstChild),dom.addClass(e,"save-row");var n=document.createElement("span");n.innerHTML="&nbsp;",dom.addClass(n,"button gears");var r=document.createElement("span");r.innerHTML="Save",dom.addClass(r,"button"),dom.addClass(r,"save");var i=document.createElement("span");i.innerHTML="New",dom.addClass(i,"button"),dom.addClass(i,"save-as");var o=document.createElement("span");o.innerHTML="Revert",dom.addClass(o,"button"),dom.addClass(o,"revert");var a=t.__preset_select=document.createElement("select");if(t.load&&t.load.remembered?Common.each(t.load.remembered,function(x,R){addPresetOption(t,R,R===t.preset)}):addPresetOption(t,DEFAULT_DEFAULT_PRESET_NAME,!1),dom.bind(a,"change",function(){for(var x=0;x<t.__preset_select.length;x++)t.__preset_select[x].innerHTML=t.__preset_select[x].value;t.preset=this.value}),e.appendChild(a),e.appendChild(n),e.appendChild(r),e.appendChild(i),e.appendChild(o),SUPPORTS_LOCAL_STORAGE){var l=document.getElementById("dg-local-explain"),A=document.getElementById("dg-local-storage"),E=document.getElementById("dg-save-locally");E.style.display="block",localStorage.getItem(getLocalStorageHash(t,"isLocal"))==="true"&&A.setAttribute("checked","checked"),showHideExplain(t,l),dom.bind(A,"change",function(){t.useLocalStorage=!t.useLocalStorage,showHideExplain(t,l)})}var v=document.getElementById("dg-new-constructor");dom.bind(v,"keydown",function(x){x.metaKey&&(x.which===67||x.keyCode===67)&&SAVE_DIALOGUE.hide()}),dom.bind(n,"click",function(){v.innerHTML=JSON.stringify(t.getSaveObject(),void 0,2),SAVE_DIALOGUE.show(),v.focus(),v.select()}),dom.bind(r,"click",function(){t.save()}),dom.bind(i,"click",function(){var x=prompt("Enter a new preset name.");x&&t.saveAs(x)}),dom.bind(o,"click",function(){t.revert()})}function addResizeHandle(t){var e=void 0;t.__resize_handle=document.createElement("div"),Common.extend(t.__resize_handle.style,{width:"6px",marginLeft:"-3px",height:"200px",cursor:"ew-resize",position:"absolute"});function n(o){return o.preventDefault(),t.width+=e-o.clientX,t.onResize(),e=o.clientX,!1}function r(){dom.removeClass(t.__closeButton,GUI.CLASS_DRAG),dom.unbind(window,"mousemove",n),dom.unbind(window,"mouseup",r)}function i(o){return o.preventDefault(),e=o.clientX,dom.addClass(t.__closeButton,GUI.CLASS_DRAG),dom.bind(window,"mousemove",n),dom.bind(window,"mouseup",r),!1}dom.bind(t.__resize_handle,"mousedown",i),dom.bind(t.__closeButton,"mousedown",i),t.domElement.insertBefore(t.__resize_handle,t.domElement.firstElementChild)}function setWidth(t,e){t.domElement.style.width=e+"px",t.__save_row&&t.autoPlace&&(t.__save_row.style.width=e+"px"),t.__closeButton&&(t.__closeButton.style.width=e+"px")}function getCurrentPreset(t,e){var n={};return Common.each(t.__rememberedObjects,function(r,i){var o={},a=t.__rememberedObjectIndecesToControllers[i];Common.each(a,function(l,A){o[A]=e?l.initialValue:l.getValue()}),n[i]=o}),n}function setPresetSelectIndex(t){for(var e=0;e<t.__preset_select.length;e++)t.__preset_select[e].value===t.preset&&(t.__preset_select.selectedIndex=e)}function updateDisplays(t){t.length!==0&&requestAnimationFrame$1$1.call(window,function(){updateDisplays(t)}),Common.each(t,function(e){e.updateDisplay()})}var GUI$1=GUI,canvas,canvasFormat,context,device,aspectRatio;const fovYDegrees=45;var modelBindGroupLayout,materialBindGroupLayout;async function initWebGPU(){canvas=document.getElementById("mainCanvas");const t=window.devicePixelRatio;if(canvas.width=canvas.clientWidth*t,canvas.height=canvas.clientHeight*t,aspectRatio=canvas.width/canvas.height,!navigator.gpu){let n=document.createElement("h1");throw n.textContent="This browser doesn't support WebGPU! Try using Google Chrome.",n.style.paddingLeft="0.4em",document.body.innerHTML="",document.body.appendChild(n),new Error("WebGPU not supported on this browser")}const e=await navigator.gpu.requestAdapter();if(!e)throw new Error("no appropriate GPUAdapter found");device=await e.requestDevice(),context=canvas.getContext("webgpu"),canvasFormat="rgba8unorm",context.configure({device,format:canvasFormat,usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.STORAGE_BINDING}),console.log("WebGPU init successsful"),modelBindGroupLayout=device.createBindGroupLayout({label:"model bind group layout",entries:[{binding:0,visibility:GPUShaderStage.VERTEX,buffer:{type:"uniform"}}]}),materialBindGroupLayout=device.createBindGroupLayout({label:"material bind group layout",entries:[{binding:0,visibility:GPUShaderStage.FRAGMENT,texture:{}},{binding:1,visibility:GPUShaderStage.FRAGMENT,sampler:{}}]})}const vertexBufferLayout={arrayStride:32,attributes:[{format:"float32x3",offset:0,shaderLocation:0},{format:"float32x3",offset:12,shaderLocation:1},{format:"float32x2",offset:24,shaderLocation:2}]},fullscreenVertexBufferLayout={arrayStride:12,attributes:[{format:"float32x3",offset:0,shaderLocation:0}]};class Renderer{scene;lights;camera;stats;prevTime=0;frameRequestId;constructor(e){this.scene=e.scene,this.lights=e.lights,this.camera=e.camera,this.stats=e.stats,this.frameRequestId=requestAnimationFrame(n=>this.onFrame(n))}stop(){cancelAnimationFrame(this.frameRequestId)}onFrame(e){this.prevTime==0&&(this.prevTime=e);let n=e-this.prevTime;this.camera.onFrame(n),this.lights.onFrame(e),this.stats.begin(),this.draw(),this.stats.end(),this.prevTime=e,this.frameRequestId=requestAnimationFrame(r=>this.onFrame(r))}}const commonRaw=`// CHECKITOUT: code that you add here will be prepended to all shaders\r
\r
struct Light {\r
    pos: vec3f,\r
    color: vec3f\r
}\r
\r
struct LightSet {\r
    numLights: u32,\r
    lights: array<Light>\r
}\r
\r
// TODO-2: you may want to create a ClusterSet struct similar to LightSet\r
\r
struct CameraUniforms {\r
    viewProjMat : mat4x4f,\r
    viewMat: mat4x4f,\r
    viewportSize: vec2f,\r
    cameraParams: vec2f\r
}\r
\r
// CHECKITOUT: this special attenuation function ensures lights don't affect geometry outside the maximum light radius\r
fn rangeAttenuation(distance: f32) -> f32 {\r
    return clamp(1.f - pow(distance / \${lightRadius}, 4.f), 0.f, 1.f) / (distance * distance);\r
}\r
\r
fn calculateLightContrib(light: Light, posWorld: vec3f, nor: vec3f) -> vec3f {\r
    let vecToLight = light.pos - posWorld;\r
    let distToLight = length(vecToLight);\r
\r
    let lambert = max(dot(nor, normalize(vecToLight)), 0.f);\r
    return light.color * lambert  / distToLight / distToLight * rangeAttenuation(distToLight);\r
}\r
\r
fn calculateLightContrib_View(light: Light, light_pos_View: vec3f, pos_View: vec3f, nor: vec3f) -> vec3f {\r
    let vecToLight = light_pos_View - pos_View;\r
    let distToLight = length(vecToLight);\r
\r
    let lambert = max(dot(nor, normalize(vecToLight)), 0.f);\r
    return light.color * lambert  / distToLight / distToLight * rangeAttenuation(distToLight);\r
}\r
\r
fn getLightGridIndex(gridId: i32, gridCounts: i32, lightBatchId: i32, lightBatchSize: i32) -> i32{\r
    return 2*gridId + 2 * lightBatchId * gridCounts;\r
}`,naiveVertRaw=`// CHECKITOUT: you can use this vertex shader for all of the renderers\r
\r
// TODO-1.3: add a uniform variable here for camera uniforms (of type CameraUniforms)\r
// make sure to use \${bindGroup_scene} for the group\r
@group(\${bindGroup_scene}) @binding(0) var<uniform> u_Camera: CameraUniforms;\r
@group(\${bindGroup_model}) @binding(0) var<uniform> modelMat: mat4x4f;\r
\r
struct VertexInput\r
{\r
    @location(0) pos: vec3f,\r
    @location(1) nor: vec3f,\r
    @location(2) uv: vec2f\r
}\r
\r
struct VertexOutput\r
{\r
    @builtin(position) fragPos: vec4f,\r
    @location(0) pos: vec3f,\r
    @location(1) nor: vec3f,\r
    @location(2) uv: vec2f,\r
    @location(3) viewPos: vec3f\r
}\r
\r
@vertex\r
fn main(in: VertexInput) -> VertexOutput\r
{\r
    let modelPos = modelMat * vec4(in.pos, 1);\r
\r
    var out: VertexOutput;\r
    out.fragPos = u_Camera.viewProjMat * modelPos;\r
    out.pos = modelPos.xyz / modelPos.w;\r
    out.nor = in.nor;\r
    out.uv = in.uv;\r
    out.viewPos = (u_Camera.viewMat * modelPos).xyz;\r
    return out;\r
}\r
`,naiveFragRaw=`@group(\${bindGroup_scene}) @binding(1) var<storage, read> lightSet: LightSet;\r
\r
@group(\${bindGroup_material}) @binding(0) var diffuseTex: texture_2d<f32>;\r
@group(\${bindGroup_material}) @binding(1) var diffuseTexSampler: sampler;\r
\r
struct FragmentInput\r
{\r
    @location(0) pos: vec3f,\r
    @location(1) nor: vec3f,\r
    @location(2) uv: vec2f\r
}\r
\r
@fragment\r
fn main(in: FragmentInput) -> @location(0) vec4f\r
{\r
    let diffuseColor = textureSample(diffuseTex, diffuseTexSampler, in.uv);\r
    if (diffuseColor.a < 0.5f) {\r
        discard;\r
    }\r
\r
    var totalLightContrib = vec3f(0, 0, 0);\r
    for (var lightIdx = 0u; lightIdx < lightSet.numLights; lightIdx++) {\r
        let light = lightSet.lights[lightIdx];\r
        totalLightContrib += calculateLightContrib(light, in.pos, normalize(in.nor));\r
    }\r
\r
    var finalColor = diffuseColor.rgb * totalLightContrib;\r
    return vec4(finalColor, 1);\r
}\r
`,forwardPlusFragRaw=`// TODO-2: implement the Forward+ fragment shader\r
\r
// See naive.fs.wgsl for basic fragment shader setup; this shader should use light clusters instead of looping over all lights\r
\r
// ------------------------------------\r
// Shading process:\r
// ------------------------------------\r
// Determine which cluster contains the current fragment.\r
// Retrieve the number of lights that affect the current fragment from the clusters data.\r
// Initialize a variable to accumulate the total light contribution for the fragment.\r
// For each light in the cluster:\r
//     Access the light's properties using its index.\r
//     Calculate the contribution of the light based on its position, the fragments position, and the surface normal.\r
//     Add the calculated contribution to the total light accumulation.\r
// Multiply the fragments diffuse color by the accumulated light contribution.\r
// Return the final color, ensuring that the alpha component is set appropriately (typically to 1).\r
@group(\${bindGroup_scene}) @binding(0) var<uniform> u_Camera: CameraUniforms;\r
@group(\${bindGroup_scene}) @binding(1) var<storage, read> lightSet: LightSet;\r
@group(\${bindGroup_lightCull}) @binding(0) var depthTexture: texture_2d<f32>;\r
@group(\${bindGroup_lightCull}) @binding(2) var<storage, read_write> lightIndices: array<i32>;\r
@group(\${bindGroup_lightCull}) @binding(3) var<storage, read_write> lightGrid: array<i32>;\r
@group(\${bindGroup_lightCull}) @binding(4) var<storage, read_write> tileMinMax: array<i32>;\r
@group(\${bindGroup_lightCull}) @binding(5) var<storage, read_write> lightCountTotal: atomic<i32>;\r
@group(\${bindGroup_lightCull}) @binding(6) var<storage, read_write> gridSize: vec3i;\r
@group(\${bindGroup_material}) @binding(0) var diffuseTex: texture_2d<f32>;\r
@group(\${bindGroup_material}) @binding(1) var diffuseTexSampler: sampler;\r
\r
struct FragmentInput\r
{\r
    @builtin(position) fragPos: vec4f,\r
    @location(0) pos: vec3f,\r
    @location(1) nor: vec3f,\r
    @location(2) uv: vec2f,\r
    @location(3) viewPos: vec3f\r
}\r
\r
@fragment\r
fn main(in: FragmentInput) -> @location(0) vec4f\r
{\r
    var viewportSize = vec2f(u_Camera.viewportSize);\r
    var tile_x = viewportSize.x / \${X_SLICES};\r
    var tile_y = viewportSize.y / \${Y_SLICES};\r
    var invert_y_fragPos = in.fragPos.xy;\r
    invert_y_fragPos.y = viewportSize.y - invert_y_fragPos.y;\r
    var tileIndex = vec2i(i32(invert_y_fragPos.x / tile_x), i32(invert_y_fragPos.y / tile_y));\r
    var gridId = tileIndex.x + gridSize.x * tileIndex.y;\r
    var gridDimXY = i32(gridSize.x * gridSize.y);\r
    var tileMin = f32(tileMinMax[2*gridId]) / f32(\${DEPTH_INTEGER_SCALE});\r
    var tileMax = f32(tileMinMax[2*gridId+1]) / f32(\${DEPTH_INTEGER_SCALE});\r
    var tilePos_Pixel = vec4f(vec4i(i32(tileIndex.x)*\${TILESIZE_X},i32(tileIndex.y)*\${TILESIZE_Y},\r
        i32(tileIndex.x+1)*\${TILESIZE_X},i32(tileIndex.y+1)*\${TILESIZE_Y}));\r
    let diffuseColor = textureSample(diffuseTex, diffuseTexSampler, in.uv);\r
    if (diffuseColor.a < 0.5f) {\r
        discard;\r
    }\r
    var totalLightContrib = vec3f(0, 0, 0);\r
    var lightCount = lightGrid[2*gridId + 1];\r
    var lightIdxOffset = lightGrid[2*gridId];\r
    for (var lightIdx = lightIdxOffset; lightIdx < lightIdxOffset + lightCount; lightIdx++) {\r
        let light = lightSet.lights[lightIndices[lightIdx]];\r
        totalLightContrib += calculateLightContrib(light, in.pos, normalize(in.nor));\r
    }\r
    \r
\r
    var finalColor = diffuseColor.rgb * totalLightContrib;\r
    if((finalColor!=finalColor).x){\r
        finalColor = vec3f(1.,0.,1.);\r
    }\r
    //return vec4f(in.fragPos.xy / viewportSize, 0.0,1.0);\r
    //return vec4(f32(tileMax), 0.0, 0., 1);\r
\r
    // var ndc = in.fragPos.xy / u_Camera.viewportSize * 2. - 1.;\r
    // ndc.y *=-1;\r
    // var viewPos = normalize(vec3f(ndc * u_Camera.cameraParams, 1.f));\r
    // var viewPos2 = in.viewPos;\r
    // viewPos2.z *= -1;\r
    // return vec4(normalize(viewPos2).xy, 0., 1.);\r
    //return vec4(normalize(viewPos), 1.);\r
    \r
    return vec4(finalColor, 1);\r
}\r
`,zPrepassFragRaw=`struct FragmentInput\r
{\r
    @builtin(position) fragPos: vec4f,\r
    @location(0) pos: vec3f,\r
    @location(1) nor: vec3f,\r
    @location(2) uv: vec2f,\r
    @location(3) viewPos: vec3f\r
}\r
\r
@fragment\r
fn main(in: FragmentInput) -> @location(0) vec4f\r
{\r
    return vec4(in.viewPos.z, 0.,0., 1);\r
}\r
`,forwardPlusCSRaw=`\r
\r
@group(\${bindGroup_lightCull}) @binding(0) var depthTexture: texture_2d<f32>;\r
@group(\${bindGroup_lightCull}) @binding(1) var<storage, read> lightSet: LightSet;\r
@group(\${bindGroup_lightCull}) @binding(2) var<storage, read_write> lightIndices_ST: array<i32>;\r
@group(\${bindGroup_lightCull}) @binding(3) var<storage, read_write> lightGrid_ST: array<i32>;\r
@group(\${bindGroup_lightCull}) @binding(4) var<storage, read_write> tileMinMax: array<atomic<i32>>;\r
@group(\${bindGroup_lightCull}) @binding(5) var<storage, read_write> lightCountTotal_ST: atomic<i32>;\r
@group(\${bindGroup_lightCull}) @binding(6) var<storage, read_write> gridSize: vec3i;\r
@group(\${bindGroup_scene}) @binding(0) var<uniform> u_Camera: CameraUniforms;\r
\r
// workgroup shared mems\r
var<workgroup> lightIndexArray_WG: array<i32, \${MAX_LIGHTS_PER_TILE}>;\r
var<workgroup> lightCounter_WG: atomic<i32>;\r
\r
@compute @workgroup_size(16, 16, 1)\r
fn computeDepthMinMax(\r
    @builtin(global_invocation_id) index_u: vec3u, \r
    @builtin(local_invocation_id) tid_u: vec3u, \r
    @builtin(workgroup_id) blockId_u: vec3u\r
) {\r
    var index = vec3i(index_u);\r
    var tid = vec3i(tid_u);\r
    var blockId = vec3i(blockId_u);\r
    var gridId = blockId.x + gridSize.x * blockId.y;\r
    var viewportSize = vec2f(u_Camera.viewportSize);\r
    var tileSizeX = i32(ceil(viewportSize.x / \${X_SLICES}));\r
    var tileSizeY = i32(ceil(viewportSize.y / \${Y_SLICES}));\r
    var pos_pixel = vec2i(\r
        i32(f32(tid.x) + f32(blockId.x) / \${X_SLICES} * viewportSize.x), \r
        i32(f32(tid.y) + f32(blockId.y) / \${Y_SLICES} * viewportSize.y)\r
    );\r
    var pos_pixel_end = vec2i(\r
        (pos_pixel.x + tileSizeX), \r
        (pos_pixel.y + tileSizeY)\r
    );\r
    var tileCountX = i32(ceil(f32(tileSizeX) / 16));\r
    var tileCountY = i32(ceil(f32(tileSizeY) / 16));\r
    if(tid.x==0 && tid.y==0){\r
        atomicStore(&tileMinMax[2*gridId], 0xfffffff);\r
        atomicStore(&tileMinMax[2*gridId+1], -0xfffffff);\r
    }\r
    var minDepth = 0xfffffff;\r
    var maxDepth = -0xfffffff;\r
    for(var y = 0; y < tileSizeY; y+=16){\r
        // if(pos_pixel.y+y*16>pos_pixel_end.y || pos_pixel.y+y*16>i32(viewportSize.y)){\r
        //     continue;\r
        // }\r
        for(var x = 0; x < tileSizeX;x+=16){\r
            // if(pos_pixel.x+x*16>pos_pixel_end.x || pos_pixel.x+x*16>i32(viewportSize.x)){\r
            //     continue;\r
            // }\r
            var curPos_pixel = vec2i(pos_pixel.x+x, pos_pixel.y+y);\r
            curPos_pixel.y = i32(viewportSize.y) - curPos_pixel.y;\r
            let depthValue = i32(textureLoad(depthTexture, curPos_pixel, 0).x*\${DEPTH_INTEGER_SCALE});\r
            if(depthValue==0){\r
                continue;\r
            }\r
            if(depthValue>maxDepth){\r
                maxDepth = depthValue;\r
            }\r
            if(depthValue<minDepth){\r
                minDepth = depthValue;\r
            }\r
        }\r
        \r
    }\r
    workgroupBarrier();\r
    let minDepthValue = atomicMin(&tileMinMax[2*gridId], i32(minDepth));\r
    let maxDepthValue = atomicMax(&tileMinMax[2*gridId+1], i32(maxDepth));\r
    workgroupBarrier();\r
}\r
\r
fn planeDistance(p: vec3f, planePoint: vec3f, planeNormal: vec3f)-> f32{\r
    var v = p - planePoint;\r
    return dot(planeNormal, v);\r
}\r
\r
@compute @workgroup_size(\${LIGHTS_BATCH_SIZE})\r
fn computeTileVisibleLightIndex(\r
    @builtin(global_invocation_id) index_u: vec3u, \r
    @builtin(local_invocation_id) tid_u: vec3u, \r
    @builtin(workgroup_id) blockId_u: vec3u \r
) {\r
    \r
    var index = vec3i(index_u);\r
    var tid = vec3i(tid_u);\r
    var blockId = vec3i(blockId_u);\r
    \r
    // blockId.xy represents viewport grid coords, blockId.z is which batch of light we are currently appending\r
    let i = index.x;\r
    var gridId = blockId.x + gridSize.x * blockId.y;\r
    let gridCounts = gridSize.x * gridSize.y;\r
    var viewportSize = vec2f(u_Camera.viewportSize);\r
    var tile_x = viewportSize.x / \${X_SLICES};\r
    var tile_y = viewportSize.y / \${Y_SLICES};\r
    var tilePos_Pixel = vec4f(f32(blockId.x)*tile_x,f32(blockId.y)*tile_y,\r
        f32(blockId.x+1)*tile_x,f32(blockId.y+1)*tile_y);\r
    var tileDepthMin = f32(atomicLoad(&tileMinMax[2*gridId])) / f32(\${DEPTH_INTEGER_SCALE});\r
    var tileDepthMax = f32(atomicLoad(&tileMinMax[2*gridId+1])) / f32(\${DEPTH_INTEGER_SCALE});\r
    var isLightValid: bool = false;\r
    var debugVal: i32 = 0;\r
\r
    if(tid.x==0){\r
        atomicStore(&lightCounter_WG, 0);\r
        lightGrid_ST[2*gridId] = 0;\r
        lightGrid_ST[2*gridId + 1] = 0;\r
    }\r
    workgroupBarrier();\r
\r
    for(var lightIdx = i32(tid.x); lightIdx < i32(lightSet.numLights); lightIdx += \${LIGHTS_BATCH_SIZE}) {\r
        // do the culling\r
        let light = lightSet.lights[lightIdx];\r
    \r
        var lightPos_View = (u_Camera.viewMat * vec4f(light.pos, 1.)).xyz;\r
        var lightRadius = f32(\${lightRadius});\r
    \r
        isLightValid = \r
             lightPos_View.z - lightRadius< 0.\r
             && lightPos_View.z + lightRadius > tileDepthMin \r
             && lightPos_View.z - lightRadius < tileDepthMax;\r
        if(isLightValid){\r
            var p_bottomleft_ndc = vec2f(tilePos_Pixel.x / viewportSize.x, tilePos_Pixel.y / viewportSize.y)*2.-1.;\r
            var p_bottomright_ndc = vec2f(tilePos_Pixel.z / viewportSize.x, tilePos_Pixel.y / viewportSize.y)*2.-1.;\r
            var p_topleft_ndc = vec2f(tilePos_Pixel.x / viewportSize.x, tilePos_Pixel.w / viewportSize.y)*2.-1.;\r
            var p_topright_ndc = vec2f(tilePos_Pixel.z / viewportSize.x, tilePos_Pixel.w / viewportSize.y)*2.-1.;\r
            var p_bottomleft_View = vec3f(p_bottomleft_ndc * u_Camera.cameraParams, -1.) * -lightPos_View.z; \r
            var p_bottomright_View = vec3f(p_bottomright_ndc * u_Camera.cameraParams, -1.) * -lightPos_View.z; \r
            var p_topleft_View = vec3f(p_topleft_ndc * u_Camera.cameraParams, -1.) * -lightPos_View.z; \r
            var p_topright_View = vec3f(p_topright_ndc * u_Camera.cameraParams, -1.) * -lightPos_View.z;\r
            var viewPos_View = vec3f(0.,0.,0.);\r
\r
            if(planeDistance(lightPos_View, viewPos_View, normalize(cross(p_bottomleft_View, p_bottomright_View)))>lightRadius){\r
                isLightValid = false;\r
            }\r
            else if(planeDistance(lightPos_View, viewPos_View, normalize(cross(p_topright_View, p_topleft_View)))>lightRadius){\r
                isLightValid = false;\r
            }\r
            else if(planeDistance(lightPos_View, viewPos_View, normalize(cross(p_bottomright_View, p_topright_View)))>lightRadius){\r
                isLightValid = false;\r
            }\r
            else if(planeDistance(lightPos_View, viewPos_View, normalize(cross(p_topleft_View, p_bottomleft_View)))>lightRadius){\r
                isLightValid = false;\r
            }\r
        }\r
        if isLightValid {\r
            let arrayIndex = atomicAdd(&lightCounter_WG, 1);\r
            if arrayIndex < \${MAX_LIGHTS_PER_TILE} {\r
                lightIndexArray_WG[arrayIndex] = lightIdx;\r
            }\r
        }\r
    }\r
\r
    workgroupBarrier();\r
    if(tid.x==0){\r
        var totalLightCountInTile = min(i32(atomicLoad(&lightCounter_WG)), \${MAX_LIGHTS_PER_TILE});\r
        var lightOffset = atomicAdd(&lightCountTotal_ST, totalLightCountInTile);\r
        lightGrid_ST[2*gridId] = i32(lightOffset);\r
        lightGrid_ST[2*gridId + 1] = i32(totalLightCountInTile);\r
        for (var index = lightOffset;index<lightOffset + totalLightCountInTile;index++){\r
            lightIndices_ST[index] = lightIndexArray_WG[index - lightOffset];\r
        }\r
    }\r
}\r
\r
`,clusteredDeferredFragRaw=`@group(\${bindGroup_material}) @binding(0) var diffuseTex: texture_2d<f32>;\r
@group(\${bindGroup_material}) @binding(1) var diffuseTexSampler: sampler;\r
\r
struct FragmentInput\r
{\r
    @location(0) pos: vec3f,\r
    @location(1) nor: vec3f,\r
    @location(2) uv: vec2f,\r
    @location(3) viewPos: vec3f\r
}\r
\r
struct RenderTargets{\r
    @location(0) baseColor: vec4f,\r
    @location(1) normal: vec4f,\r
    @location(2) depth: vec4f,\r
}\r
\r
@fragment\r
fn main(in: FragmentInput) -> RenderTargets\r
{\r
    let diffuseColor = textureSample(diffuseTex, diffuseTexSampler, in.uv);\r
    if (diffuseColor.a < 0.5f) {\r
        discard;\r
    }\r
    var rt: RenderTargets;\r
    rt.baseColor = diffuseColor;\r
    var normal = vec4f(normalize(in.nor.xyz), in.viewPos.z / 16.);\r
    rt.normal = vec4f(in.nor.xyz, 1.);\r
    rt.depth = vec4f(in.viewPos.z, 0.,0., 1.);\r
    return rt;\r
}\r
`,clusteredDeferredPackedFragRaw=`@group(\${bindGroup_material}) @binding(0) var diffuseTex: texture_2d<f32>;\r
@group(\${bindGroup_material}) @binding(1) var diffuseTexSampler: sampler;\r
\r
struct FragmentInput\r
{\r
    @location(0) pos: vec3f,\r
    @location(1) nor: vec3f,\r
    @location(2) uv: vec2f,\r
    @location(3) viewPos: vec3f\r
}\r
\r
struct RenderTargets{\r
    @location(0) packedVal: vec4u,\r
}\r
\r
@fragment\r
fn main(in: FragmentInput) -> RenderTargets\r
{\r
    let diffuseColor = textureSample(diffuseTex, diffuseTexSampler, in.uv);\r
    if (diffuseColor.a < 0.5f) {\r
        discard;\r
    }\r
    var rt: RenderTargets;\r
    var normal = vec4(normalize(in.nor.xyz), in.viewPos.z / 16.);\r
    rt.packedVal = vec4u(pack4x8snorm(normal), pack4x8snorm(diffuseColor), u32(-in.viewPos.z*\${DEPTH_INTEGER_SCALE}) , 1u);\r
    return rt;\r
}\r
`,clusteredDeferredFullscreenVertRaw=`// TODO-3: implement the Clustered Deferred fullscreen vertex shader\r
\r
// This shader should be very simple as it does not need all of the information passed by the the naive vertex shader.\r
\r
struct VertexInput\r
{\r
    @location(0) pos: vec3f,\r
}\r
\r
struct VertexOutput\r
{\r
    @builtin(position) fragPos: vec4f,\r
}\r
\r
@vertex\r
fn main(in: VertexInput) -> VertexOutput\r
{\r
    var out: VertexOutput;\r
    out.fragPos = vec4f(in.pos, 1.);\r
    return out;\r
}\r
`,clusteredDeferredFullscreenFragRaw=`// TODO-3: implement the Clustered Deferred fullscreen fragment shader\r
\r
@group(\${bindGroup_scene}) @binding(0) var<uniform> u_Camera: CameraUniforms;\r
@group(\${bindGroup_scene}) @binding(1) var<storage, read> lightSet: LightSet;\r
// Similar to the Forward+ fragment shader, but with vertex information coming from the G-buffer instead.\r
@group(\${bindGroup_lightCull}) @binding(2) var<storage, read_write> lightIndices: array<i32>;\r
@group(\${bindGroup_lightCull}) @binding(3) var<storage, read_write> lightGrid: array<i32>;\r
@group(\${bindGroup_lightCull}) @binding(4) var<storage, read_write> tileMinMax: array<i32>;\r
@group(\${bindGroup_lightCull}) @binding(5) var<storage, read_write> lightCountTotal: atomic<i32>;\r
@group(\${bindGroup_lightCull}) @binding(6) var<storage, read_write> gridSize: vec3i;\r
\r
\r
@group(\${bindGroup_deferredLighting}) @binding(0) var gbufferBaseColor: texture_2d<f32>;\r
@group(\${bindGroup_deferredLighting}) @binding(1) var gbufferNormal: texture_2d<f32>;\r
@group(\${bindGroup_deferredLighting}) @binding(2) var gbufferDepth: texture_2d<f32>;\r
\r
\r
\r
struct FragmentInput\r
{\r
    @builtin(position) fragPos: vec4f,\r
}\r
\r
@fragment\r
fn main(in: FragmentInput) -> @location(0) vec4f\r
{\r
    var viewportSize = vec2f(u_Camera.viewportSize);\r
    var uv = in.fragPos.xy / viewportSize;\r
    var pixelPos = vec2u(in.fragPos.xy);\r
    var tile_x = viewportSize.x / \${X_SLICES};\r
    var tile_y = viewportSize.y / \${Y_SLICES};\r
    var invert_y_fragPos = in.fragPos.xy;\r
    invert_y_fragPos.y = viewportSize.y - invert_y_fragPos.y;\r
    var tileIndex = vec2i(i32(invert_y_fragPos.x / tile_x), i32(invert_y_fragPos.y / tile_y));\r
    var gridDimXY = i32(gridSize.x * gridSize.y);\r
    var tilePos_Pixel = vec4f(f32(tileIndex.x)*tile_x,f32(tileIndex.y)*tile_y,\r
        f32(tileIndex.x+1)*tile_x,f32(tileIndex.y+1)*tile_y);\r
    let baseColor = textureLoad(gbufferBaseColor, pixelPos, 0).xyz;\r
    let normal = textureLoad(gbufferNormal, pixelPos, 0).xyz;\r
    let depth = textureLoad(gbufferDepth, pixelPos, 0).x;\r
    var pos_ndc = uv*2.-1.;\r
    pos_ndc.y *=-1;\r
    var pos_view = vec3f(pos_ndc * u_Camera.cameraParams, -1.) * -depth; \r
    var normal_view = (u_Camera.viewMat * vec4f(normal, 0.)).xyz;\r
    var totalLightContrib = vec3f(0, 0, 0);\r
    var totalLightCount = 0;\r
    for(var z_index = 0; z_index < \${Z_SLICES};z_index++){\r
        var gridId = tileIndex.x + gridSize.x * tileIndex.y + z_index * \${Z_SLICES} * gridDimXY;\r
        var lightCount = lightGrid[2*gridId + 1];\r
        var lightIdxOffset = lightGrid[2*gridId];\r
        for (var lightIdx = lightIdxOffset; lightIdx < lightIdxOffset + lightCount; lightIdx++) {\r
            let light = lightSet.lights[lightIndices[lightIdx]];\r
            var light_pos_view = (u_Camera.viewMat * vec4f(light.pos, 1.)).xyz;\r
            totalLightContrib += calculateLightContrib_View(light, light_pos_view, pos_view, normalize(normal_view));\r
            totalLightCount+=1;\r
        }\r
    }\r
\r
    var finalColor = baseColor * totalLightContrib;\r
    if((finalColor!=finalColor).x){\r
        finalColor = vec3f(1.,0.,1.);\r
    }\r
    //return vec4f(abs(pos_view)*0.1, 1.);\r
    //return vec4f(vec2f(tileIndex)/18., 0.0,1.0);\r
    //return vec4(f32(totalLightCount)*0.01, 0.0, 0., 1);\r
\r
    // var ndc = in.fragPos.xy / u_Camera.viewportSize * 2. - 1.;\r
    // ndc.y *=-1;\r
    // var viewPos = normalize(vec3f(ndc * u_Camera.cameraParams, 1.f));\r
    // var viewPos2 = in.viewPos;\r
    // viewPos2.z *= -1;\r
    // return vec4(normalize(viewPos2).xy, 0., 1.);\r
    //return vec4(normalize(viewPos), 1.);\r
    \r
    \r
    // var p_bottomleft_ndc = vec2f(tilePos_Pixel.x / viewportSize.x, tilePos_Pixel.y / viewportSize.y)*2.-1.;\r
    // var p_bottomright_ndc = vec2f(tilePos_Pixel.z / viewportSize.x, tilePos_Pixel.y / viewportSize.y)*2.-1.;\r
    // var p_topleft_ndc = vec2f(tilePos_Pixel.x / viewportSize.x, tilePos_Pixel.w / viewportSize.y)*2.-1.;\r
    // var p_topright_ndc = vec2f(tilePos_Pixel.z / viewportSize.x, tilePos_Pixel.w / viewportSize.y)*2.-1.;\r
    // var tile_size_ndc = vec2f(1./\${X_SLICES}., 1./\${Y_SLICES}.) * 2;\r
    // var display = (pos_ndc - p_bottomleft_ndc) / tile_size_ndc;\r
    // if(display.x!=display.x){\r
    //     return vec4(0.,0.,1.,1.);\r
    // }\r
    // return vec4(vec2f(display), 0., 1);\r
    return vec4(finalColor, 1);\r
}\r
`,clusteredDeferredFullscreenCSRaw=`// TODO-3: implement the Clustered Deferred fullscreen fragment shader\r
\r
@group(\${bindGroup_scene}) @binding(0) var<uniform> u_Camera: CameraUniforms;\r
@group(\${bindGroup_scene}) @binding(1) var<storage, read> lightSet: LightSet;\r
// Similar to the Forward+ fragment shader, but with vertex information coming from the G-buffer instead.\r
@group(\${bindGroup_lightCull}) @binding(2) var<storage, read_write> lightIndices: array<i32>;\r
@group(\${bindGroup_lightCull}) @binding(3) var<storage, read_write> lightGrid: array<i32>;\r
@group(\${bindGroup_lightCull}) @binding(4) var<storage, read_write> tileMinMax: array<i32>;\r
@group(\${bindGroup_lightCull}) @binding(5) var<storage, read_write> lightCountTotal: atomic<i32>;\r
@group(\${bindGroup_lightCull}) @binding(6) var<storage, read_write> gridSize: vec3i;\r
\r
@group(\${bindGroup_deferredLighting}) @binding(0) var gbufferBaseColor: texture_2d<f32>;\r
@group(\${bindGroup_deferredLighting}) @binding(1) var gbufferNormal: texture_2d<f32>;\r
@group(\${bindGroup_deferredLighting}) @binding(2) var gbufferDepth: texture_2d<f32>;\r
@group(\${bindGroup_deferredLighting}) @binding(3) var frameBuffer: texture_storage_2d<rgba8unorm, write>;\r
\r
@compute @workgroup_size(16, 16, 1)\r
fn deferredShadingCS(\r
    @builtin(global_invocation_id) index_u: vec3u, \r
    @builtin(local_invocation_id) tid_u: vec3u, \r
    @builtin(workgroup_id) blockId_u: vec3u \r
)\r
{\r
    var index = vec3i(index_u);\r
    var tid = vec3i(tid_u);\r
    var blockId = vec3i(blockId_u);\r
    var viewportSize = vec2f(u_Camera.viewportSize);\r
    var fragPos = vec2f(f32(blockId.x*16+tid.x), f32(blockId.y*16+tid.y));\r
    var uv = fragPos.xy / viewportSize;\r
    var pixelPos = vec2u(fragPos.xy);\r
    var tile_x = viewportSize.x / \${X_SLICES};\r
    var tile_y = viewportSize.y / \${Y_SLICES};\r
    var invert_y_fragPos = fragPos.xy;\r
    invert_y_fragPos.y = viewportSize.y - invert_y_fragPos.y;\r
    var tileIndex = vec2i(i32(invert_y_fragPos.x / tile_x), i32(invert_y_fragPos.y / tile_y));\r
    var gridDimXY = i32(gridSize.x * gridSize.y);\r
    var tilePos_Pixel = vec4f(f32(tileIndex.x)*tile_x,f32(tileIndex.y)*tile_y,\r
        f32(tileIndex.x+1)*tile_x,f32(tileIndex.y+1)*tile_y);\r
    let baseColor = textureLoad(gbufferBaseColor, pixelPos, 0).xyz;\r
    var normal = textureLoad(gbufferNormal, pixelPos, 0).xyz;\r
    let depth = textureLoad(gbufferDepth, pixelPos, 0).x;\r
    var pos_ndc = uv*2.-1.;\r
    pos_ndc.y *=-1;\r
    var pos_view = vec3f(pos_ndc * u_Camera.cameraParams, -1.) * -depth; \r
    var normal_view = (u_Camera.viewMat * vec4f(normal, 0.)).xyz;\r
    var totalLightContrib = vec3f(0, 0, 0);\r
    var totalLightCount = 0;\r
    for(var z_index = 0; z_index < \${Z_SLICES};z_index++){\r
        var gridId = tileIndex.x + gridSize.x * tileIndex.y + z_index * \${Z_SLICES} * gridDimXY;\r
        var lightCount = lightGrid[2*gridId + 1];\r
        var lightIdxOffset = lightGrid[2*gridId];\r
        for (var lightIdx = lightIdxOffset; lightIdx < lightIdxOffset + lightCount; lightIdx++) {\r
            let light = lightSet.lights[lightIndices[lightIdx]];\r
            var light_pos_view = (u_Camera.viewMat * vec4f(light.pos, 1.)).xyz;\r
            totalLightContrib += calculateLightContrib_View(light, light_pos_view, pos_view, normalize(normal_view));\r
            totalLightCount+=1;\r
        }\r
    }\r
\r
    var finalColor = baseColor * totalLightContrib;\r
    if((finalColor!=finalColor).x){\r
        finalColor = vec3f(1.,0.,1.);\r
    }\r
    //return vec4f(abs(pos_view)*0.1, 1.);\r
    //return vec4f(in.fragPos.xy / viewportSize, 0.0,1.0);\r
    //return vec4(f32(totalLightCount)*0.05, 0.0, 0., 1);\r
\r
    // var ndc = in.fragPos.xy / u_Camera.viewportSize * 2. - 1.;\r
    // ndc.y *=-1;\r
    // var viewPos = normalize(vec3f(ndc * u_Camera.cameraParams, 1.f));\r
    // var viewPos2 = in.viewPos;\r
    // viewPos2.z *= -1;\r
    // return vec4(normalize(viewPos2).xy, 0., 1.);\r
    //return vec4(normalize(viewPos), 1.);\r
    //textureStore(frameBuffer, pixelPos, vec4f(normal, 1.));\r
    textureStore(frameBuffer, pixelPos, vec4f(finalColor, 1.));\r
}\r
`,clusteredDeferredFullscreenPackedCSRaw=`// TODO-3: implement the Clustered Deferred fullscreen fragment shader\r
\r
@group(\${bindGroup_scene}) @binding(0) var<uniform> u_Camera: CameraUniforms;\r
@group(\${bindGroup_scene}) @binding(1) var<storage, read> lightSet: LightSet;\r
// Similar to the Forward+ fragment shader, but with vertex information coming from the G-buffer instead.\r
@group(\${bindGroup_lightCull}) @binding(2) var<storage, read_write> lightIndices: array<i32>;\r
@group(\${bindGroup_lightCull}) @binding(3) var<storage, read_write> lightGrid: array<i32>;\r
@group(\${bindGroup_lightCull}) @binding(4) var<storage, read_write> tileMinMax: array<i32>;\r
@group(\${bindGroup_lightCull}) @binding(5) var<storage, read_write> lightCountTotal: atomic<i32>;\r
@group(\${bindGroup_lightCull}) @binding(6) var<storage, read_write> gridSize: vec3i;\r
\r
@group(\${bindGroup_deferredLighting}) @binding(0) var gbufferPacked: texture_2d<u32>;\r
@group(\${bindGroup_deferredLighting}) @binding(1) var frameBuffer: texture_storage_2d<rgba8unorm, write>;\r
\r
@compute @workgroup_size(16, 16, 1)\r
fn deferredShadingCS(\r
    @builtin(global_invocation_id) index_u: vec3u, \r
    @builtin(local_invocation_id) tid_u: vec3u, \r
    @builtin(workgroup_id) blockId_u: vec3u \r
)\r
{\r
    var index = vec3i(index_u);\r
    var tid = vec3i(tid_u);\r
    var blockId = vec3i(blockId_u);\r
    var viewportSize = vec2f(u_Camera.viewportSize);\r
    var fragPos = vec2f(f32(blockId.x*16+tid.x), f32(blockId.y*16+tid.y));\r
    var uv = fragPos.xy / viewportSize;\r
    var pixelPos = vec2u(fragPos.xy);\r
    var tile_x = viewportSize.x / \${X_SLICES};\r
    var tile_y = viewportSize.y / \${Y_SLICES};\r
    var invert_y_fragPos = fragPos.xy;\r
    invert_y_fragPos.y = viewportSize.y - invert_y_fragPos.y;\r
    var tileIndex = vec2i(i32(invert_y_fragPos.x / tile_x), i32(invert_y_fragPos.y / tile_y));\r
    var gridDimXY = i32(gridSize.x * gridSize.y);\r
    var tilePos_Pixel = vec4f(f32(tileIndex.x)*tile_x,f32(tileIndex.y)*tile_y,\r
        f32(tileIndex.x+1)*tile_x,f32(tileIndex.y+1)*tile_y);\r
    let packedNormalDepth = textureLoad(gbufferPacked, pixelPos, 0);\r
    let baseColor = unpack4x8snorm(packedNormalDepth.y).xyz;\r
    var unpackedNormalDepth = unpack4x8snorm(packedNormalDepth.x);\r
    var normal = unpackedNormalDepth.xyz;\r
    let depth = -f32(packedNormalDepth.z)/\${DEPTH_INTEGER_SCALE};\r
    var pos_ndc = uv*2.-1.;\r
    pos_ndc.y *=-1;\r
    var pos_view = vec3f(pos_ndc * u_Camera.cameraParams, -1.) * -depth; \r
    var normal_view = (u_Camera.viewMat * vec4f(normal, 0.)).xyz;\r
    var totalLightContrib = vec3f(0, 0, 0);\r
    var totalLightCount = 0;\r
    for(var z_index = 0; z_index < \${Z_SLICES};z_index++){\r
        var gridId = tileIndex.x + gridSize.x * tileIndex.y + z_index * \${Z_SLICES} * gridDimXY;\r
        var lightCount = lightGrid[2*gridId + 1];\r
        var lightIdxOffset = lightGrid[2*gridId];\r
        for (var lightIdx = lightIdxOffset; lightIdx < lightIdxOffset + lightCount; lightIdx++) {\r
            let light = lightSet.lights[lightIndices[lightIdx]];\r
            var light_pos_view = (u_Camera.viewMat * vec4f(light.pos, 1.)).xyz;\r
            totalLightContrib += calculateLightContrib_View(light, light_pos_view, pos_view, normalize(normal_view));\r
            totalLightCount+=1;\r
        }\r
    }\r
\r
    var finalColor = baseColor * totalLightContrib;\r
    if((finalColor!=finalColor).x){\r
        finalColor = vec3f(1.,0.,1.);\r
    }\r
    //return vec4f(abs(pos_view)*0.1, 1.);\r
    //return vec4f(in.fragPos.xy / viewportSize, 0.0,1.0);\r
    //return vec4(f32(totalLightCount)*0.05, 0.0, 0., 1);\r
\r
    // var ndc = in.fragPos.xy / u_Camera.viewportSize * 2. - 1.;\r
    // ndc.y *=-1;\r
    // var viewPos = normalize(vec3f(ndc * u_Camera.cameraParams, 1.f));\r
    // var viewPos2 = in.viewPos;\r
    // viewPos2.z *= -1;\r
    // return vec4(normalize(viewPos2).xy, 0., 1.);\r
    //return vec4(normalize(viewPos), 1.);\r
    //textureStore(frameBuffer, pixelPos, vec4f(normal, 1.));\r
    textureStore(frameBuffer, pixelPos, vec4f(finalColor, 1.));\r
}\r
`,moveLightsComputeRaw=`@group(\${bindGroup_scene}) @binding(0) var<storage, read_write> lightSet: LightSet;\r
@group(\${bindGroup_scene}) @binding(1) var<uniform> time: f32;\r
\r
// https://gist.github.com/munrocket/236ed5ba7e409b8bdf1ff6eca5dcdc39\r
// MIT License.  Stefan Gustavson, Munrocket\r
fn permute4(x: vec4f) -> vec4f { return ((x * 34. + 1.) * x) % vec4f(289.); }\r
fn fade2(t: vec2f) -> vec2f { return t * t * t * (t * (t * 6. - 15.) + 10.); }\r
\r
fn perlin(P: vec2f) -> f32 {\r
    var Pi: vec4f = floor(P.xyxy) + vec4f(0., 0., 1., 1.);\r
    let Pf = fract(P.xyxy) - vec4f(0., 0., 1., 1.);\r
    Pi = Pi % vec4f(289.); // To avoid truncation effects in permutation\r
    let ix = Pi.xzxz;\r
    let iy = Pi.yyww;\r
    let fx = Pf.xzxz;\r
    let fy = Pf.yyww;\r
    let i = permute4(permute4(ix) + iy);\r
    var gx: vec4f = 2. * fract(i * 0.0243902439) - 1.; // 1/41 = 0.024...\r
    let gy = abs(gx) - 0.5;\r
    let tx = floor(gx + 0.5);\r
    gx = gx - tx;\r
    var g00: vec2f = vec2f(gx.x, gy.x);\r
    var g10: vec2f = vec2f(gx.y, gy.y);\r
    var g01: vec2f = vec2f(gx.z, gy.z);\r
    var g11: vec2f = vec2f(gx.w, gy.w);\r
    let norm = 1.79284291400159 - 0.85373472095314 *\r
        vec4f(dot(g00, g00), dot(g01, g01), dot(g10, g10), dot(g11, g11));\r
    g00 = g00 * norm.x;\r
    g01 = g01 * norm.y;\r
    g10 = g10 * norm.z;\r
    g11 = g11 * norm.w;\r
    let n00 = dot(g00, vec2f(fx.x, fy.x));\r
    let n10 = dot(g10, vec2f(fx.y, fy.y));\r
    let n01 = dot(g01, vec2f(fx.z, fy.z));\r
    let n11 = dot(g11, vec2f(fx.w, fy.w));\r
    let fade_xy = fade2(Pf.xy);\r
    let n_x = mix(vec2f(n00, n01), vec2f(n10, n11), vec2f(fade_xy.x));\r
    let n_xy = mix(n_x.x, n_x.y, fade_xy.y);\r
    return 2.3 * n_xy;\r
}\r
\r
fn perlin3(lightIdx: u32, scaledTime: f32) -> vec3f {\r
    let seedPos = vec2f(f32(lightIdx) * 163.81f, scaledTime);\r
    return vec3f(perlin(seedPos), perlin(seedPos + 110.93), perlin(seedPos + 350.51));\r
}\r
\r
const bboxMin = vec3f(-10, 0, -5);\r
const bboxMax = vec3f(10, 8, 5);\r
\r
// CHECKITOUT: this is an example of a compute shader entry point function\r
@compute\r
@workgroup_size(\${moveLightsWorkgroupSize})\r
fn main(@builtin(global_invocation_id) globalIdx: vec3u) {\r
    let lightIdx = globalIdx.x;\r
    if (lightIdx >= lightSet.numLights) {\r
        return;\r
    }\r
\r
    let scaledTime = 0.f;//time / 5000.f;\r
\r
    let noise = perlin3(lightIdx, scaledTime);\r
    // perlin noise rarely reaches the extremes (-1 and 1), so scale accordingly here to ensure lights reach\r
    // the bounding box's sides\r
    let scaledNoise = (noise + 0.5) * 0.8;\r
    lightSet.lights[lightIdx].pos = mix(bboxMin, bboxMax, scaledNoise);\r
}\r
`,clusteringComputeRaw=`@group(\${bindGroup_lightCull}) @binding(1) var<storage, read> lightSet: LightSet;\r
@group(\${bindGroup_lightCull}) @binding(2) var<storage, read_write> lightIndices_ST: array<i32>;\r
@group(\${bindGroup_lightCull}) @binding(3) var<storage, read_write> lightGrid_ST: array<i32>;\r
@group(\${bindGroup_lightCull}) @binding(5) var<storage, read_write> lightCountTotal_ST: atomic<i32>;\r
@group(\${bindGroup_lightCull}) @binding(6) var<storage, read_write> gridSize: vec3i;\r
@group(\${bindGroup_scene}) @binding(0) var<uniform> u_Camera: CameraUniforms;\r
\r
// workgroup shared mems\r
var<workgroup> lightIndexArray_WG: array<i32, \${MAX_LIGHTS_PER_CLUSTER}>;\r
var<workgroup> lightCounter_WG: atomic<i32>;\r
\r
fn planeDistance(p: vec3f, planePoint: vec3f, planeNormal: vec3f)-> f32{\r
    var v = p - planePoint;\r
    return dot(planeNormal, v);\r
}\r
\r
@compute @workgroup_size(\${LIGHTS_BATCH_SIZE})\r
fn computeTileVisibleLightIndex(\r
    @builtin(global_invocation_id) index_u: vec3u, \r
    @builtin(local_invocation_id) tid_u: vec3u, \r
    @builtin(workgroup_id) blockId_u: vec3u \r
) {\r
    var index = vec3i(index_u);\r
    var tid = vec3i(tid_u);\r
    var blockId = vec3i(blockId_u);\r
    // blockId.xy represents viewport grid coords, blockId.z is which batch of light we are currently appending\r
    let i = index.x;\r
    let gridCounts = gridSize.x * gridSize.y;\r
    var gridId = i32(blockId.x + gridSize.x * blockId.y + blockId.z* \${Z_SLICES} * gridCounts);\r
    var viewportSize = vec2f(u_Camera.viewportSize);\r
    var tile_x = viewportSize.x / \${X_SLICES};\r
    var tile_y = viewportSize.y / \${Y_SLICES};\r
    var tilePos_Pixel = vec4f(f32(blockId.x)*tile_x,f32(blockId.y)*tile_y,\r
        f32(blockId.x+1)*tile_x,f32(blockId.y+1)*tile_y);\r
    var minZ = -0.1;\r
    var maxZ = -2000.;\r
    var tileDepthMin = maxZ / \${Z_SLICES} * f32(blockId.z+1);\r
    var tileDepthMax = maxZ / \${Z_SLICES} * f32(blockId.z);\r
    var isLightValid: bool = false;\r
    var debugVal: i32 = 0;\r
\r
    if(tid.x==0){\r
        atomicStore(&lightCounter_WG, 0);\r
        lightGrid_ST[2*gridId] = 0;\r
        lightGrid_ST[2*gridId + 1] = 0;\r
    }\r
    workgroupBarrier();\r
\r
    for(var lightIdx = i32(tid.x); lightIdx < i32(lightSet.numLights); lightIdx += \${LIGHTS_BATCH_SIZE}) {\r
        // do the culling\r
        let light = lightSet.lights[lightIdx];\r
    \r
        var lightPos_View = (u_Camera.viewMat * vec4f(light.pos, 1.)).xyz;\r
        var lightRadius = f32(\${lightRadius});\r
    \r
        isLightValid = \r
             lightPos_View.z - lightRadius< 0.\r
             && lightPos_View.z + lightRadius > tileDepthMin \r
             && lightPos_View.z - lightRadius < tileDepthMax;\r
        if(isLightValid){\r
            var p_bottomleft_ndc = vec2f(tilePos_Pixel.x / viewportSize.x, tilePos_Pixel.y / viewportSize.y)*2.-1.;\r
            var p_bottomright_ndc = vec2f(tilePos_Pixel.z / viewportSize.x, tilePos_Pixel.y / viewportSize.y)*2.-1.;\r
            var p_topleft_ndc = vec2f(tilePos_Pixel.x / viewportSize.x, tilePos_Pixel.w / viewportSize.y)*2.-1.;\r
            var p_topright_ndc = vec2f(tilePos_Pixel.z / viewportSize.x, tilePos_Pixel.w / viewportSize.y)*2.-1.;\r
            var p_bottomleft_View = vec3f(p_bottomleft_ndc * u_Camera.cameraParams, -1.) * -lightPos_View.z; \r
            var p_bottomright_View = vec3f(p_bottomright_ndc * u_Camera.cameraParams, -1.) * -lightPos_View.z; \r
            var p_topleft_View = vec3f(p_topleft_ndc * u_Camera.cameraParams, -1.) * -lightPos_View.z; \r
            var p_topright_View = vec3f(p_topright_ndc * u_Camera.cameraParams, -1.) * -lightPos_View.z;\r
            var viewPos_View = vec3f(0.,0.,0.);\r
\r
            if(planeDistance(lightPos_View, viewPos_View, normalize(cross(p_bottomleft_View, p_bottomright_View)))>lightRadius){\r
                isLightValid = false;\r
            }\r
            else if(planeDistance(lightPos_View, viewPos_View, normalize(cross(p_topright_View, p_topleft_View)))>lightRadius){\r
                isLightValid = false;\r
            }\r
            else if(planeDistance(lightPos_View, viewPos_View, normalize(cross(p_bottomright_View, p_topright_View)))>lightRadius){\r
                isLightValid = false;\r
            }\r
            else if(planeDistance(lightPos_View, viewPos_View, normalize(cross(p_topleft_View, p_bottomleft_View)))>lightRadius){\r
                isLightValid = false;\r
            }\r
        }\r
        if isLightValid {\r
            let arrayIndex = atomicAdd(&lightCounter_WG, 1);\r
            if arrayIndex < 2048 {\r
                lightIndexArray_WG[arrayIndex] = lightIdx;\r
            }\r
        }\r
    }\r
\r
    workgroupBarrier();\r
    if(tid.x==0){\r
        var totalLightCountInTile = min(i32(atomicLoad(&lightCounter_WG)), \${MAX_LIGHTS_PER_CLUSTER});\r
        var lightOffset = atomicAdd(&lightCountTotal_ST, totalLightCountInTile);\r
        lightGrid_ST[2*gridId] = i32(lightOffset);\r
        lightGrid_ST[2*gridId + 1] = i32(totalLightCountInTile);\r
        for (var index = lightOffset;index<lightOffset + totalLightCountInTile;index++){\r
            lightIndices_ST[index] = lightIndexArray_WG[index - lightOffset];\r
        }\r
    }\r
}\r
\r
`,constants={bindGroup_scene:0,bindGroup_model:1,bindGroup_lightCull:2,bindGroup_material:3,bindGroup_deferredLighting:3,moveLightsWorkgroupSize:128,lightRadius:2,TILESIZE_X:16,TILESIZE_Y:16,AVG_LIGHTS_PER_TILE:256,X_SLICES:32,Y_SLICES:32,Z_SLICES:8,AVG_LIGHTS_PER_CLUSTER:512};function evalShaderRaw(raw){return console.log("lr",constants.lightRadius),eval("`"+raw.replaceAll("${","${constants.")+"`")}const commonSrc=evalShaderRaw(commonRaw);function processShaderRaw(t){return commonSrc+evalShaderRaw(t)}const naiveVertSrc=processShaderRaw(naiveVertRaw),naiveFragSrc=processShaderRaw(naiveFragRaw),forwardPlusFragSrc=processShaderRaw(forwardPlusFragRaw),zPrepassFragSrc=processShaderRaw(zPrepassFragRaw),forwardPlusCSRawSrc=processShaderRaw(forwardPlusCSRaw),clusteredDeferredFragSrc=processShaderRaw(clusteredDeferredFragRaw),clusteredDeferredPackedFragSrc=processShaderRaw(clusteredDeferredPackedFragRaw),clusteredDeferredFullscreenVertSrc=processShaderRaw(clusteredDeferredFullscreenVertRaw),clusteredDeferredFullscreenFragSrc=processShaderRaw(clusteredDeferredFullscreenFragRaw),clusteredDeferredFullscreenCSSrc=processShaderRaw(clusteredDeferredFullscreenCSRaw),clusteredDeferredFullscreenPackedCSSrc=processShaderRaw(clusteredDeferredFullscreenPackedCSRaw),moveLightsComputeSrc=processShaderRaw(moveLightsComputeRaw),clusteringComputeSrc=processShaderRaw(clusteringComputeRaw);class NaiveRenderer extends Renderer{sceneUniformsBindGroupLayout;sceneUniformsBindGroup;depthTexture;depthTextureView;pipeline;constructor(e){super(e),this.sceneUniformsBindGroupLayout=device.createBindGroupLayout({label:"scene uniforms bind group layout",entries:[{binding:0,visibility:GPUShaderStage.VERTEX,buffer:{type:"uniform"}},{binding:1,visibility:GPUShaderStage.FRAGMENT,buffer:{type:"read-only-storage"}}]}),this.sceneUniformsBindGroup=device.createBindGroup({label:"scene uniforms bind group",layout:this.sceneUniformsBindGroupLayout,entries:[{binding:0,resource:{buffer:e.camera.uniformsBuffer}},{binding:1,resource:{buffer:this.lights.lightSetStorageBuffer}}]}),this.depthTexture=device.createTexture({size:[canvas.width,canvas.height],format:"depth24plus",usage:GPUTextureUsage.RENDER_ATTACHMENT}),this.depthTextureView=this.depthTexture.createView(),this.pipeline=device.createRenderPipeline({layout:device.createPipelineLayout({label:"naive pipeline layout",bindGroupLayouts:[this.sceneUniformsBindGroupLayout,modelBindGroupLayout,null,materialBindGroupLayout]}),depthStencil:{depthWriteEnabled:!0,depthCompare:"less",format:"depth24plus"},vertex:{module:device.createShaderModule({label:"naive vert shader",code:naiveVertSrc}),buffers:[vertexBufferLayout]},fragment:{module:device.createShaderModule({label:"naive frag shader",code:naiveFragSrc}),targets:[{format:canvasFormat}]}})}draw(){const e=device.createCommandEncoder(),n=context.getCurrentTexture().createView(),r=e.beginRenderPass({label:"naive render pass",colorAttachments:[{view:n,clearValue:[0,0,0,0],loadOp:"clear",storeOp:"store"}],depthStencilAttachment:{view:this.depthTextureView,depthClearValue:1,depthLoadOp:"clear",depthStoreOp:"store"}});r.setPipeline(this.pipeline),r.setBindGroup(constants.bindGroup_scene,this.sceneUniformsBindGroup),this.sceneUniformsBindGroup,this.scene.iterate(i=>{r.setBindGroup(constants.bindGroup_model,i.modelBindGroup)},i=>{r.setBindGroup(constants.bindGroup_material,i.materialBindGroup)},i=>{r.setVertexBuffer(0,i.vertexBuffer),r.setIndexBuffer(i.indexBuffer,"uint32"),r.drawIndexed(i.numIndices)}),r.end(),device.queue.submit([e.finish()])}}class ForwardPlusRenderer extends Renderer{sceneUniformsBindGroupLayout;sceneUniformsBindGroup;lightCullingBindGroupLayout;lightCullingBindGroup;depthRTTexture;depthRTTextureView;depthTexture;depthTextureView;lightIndices;lightIndicesArray;lightGrid;lightGridArray;tileMinMax;tileMinMaxArray;lightCountTotalArray;lightCountTotal;gridSizeArray;gridSize;zPrepassGraphicsPipeline;computeDepthMinMaxComputePipeline;computeTileVisibleLightIndexComputePipeline;forwardPlusGraphicsPipeline;forwardPlusCSModule;lightCullingBatchSize=64;avgLightsPerTile=constants.AVG_LIGHTS_PER_TILE;constructor(e){super(e);var n=canvas.width,r=canvas.height,i=Math.floor((n+constants.TILESIZE_X-1)/constants.TILESIZE_X),o=Math.floor((r+constants.TILESIZE_Y-1)/constants.TILESIZE_Y),a=i*o;this.lightIndicesArray=new Int32Array(a*this.avgLightsPerTile),this.lightIndicesArray.set(Array(a*this.avgLightsPerTile).fill(0)),this.lightIndices=device.createBuffer({label:"lightIndices",size:this.lightIndicesArray.byteLength,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST}),this.lightGridArray=new Int32Array(2*a),this.lightGridArray.set(Array(2*a).fill(0)),this.lightGrid=device.createBuffer({label:"lightGrid",size:this.lightGridArray.byteLength,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST}),this.tileMinMaxArray=new Int32Array(2*a),this.tileMinMax=device.createBuffer({label:"tileMinMax",size:this.tileMinMaxArray.byteLength,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC}),this.lightCountTotalArray=new Int32Array(1),this.lightCountTotalArray.set([0],0),this.lightCountTotal=device.createBuffer({label:"lightCountTotal",size:this.lightCountTotalArray.byteLength,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST|GPUBufferUsage.COPY_SRC}),this.gridSizeArray=new Int32Array(3),this.gridSize=device.createBuffer({label:"gridSize",size:16,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST}),this.depthRTTexture=device.createTexture({size:[canvas.width,canvas.height],format:"r32float",usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING}),this.depthRTTextureView=this.depthRTTexture.createView(),this.depthTexture=device.createTexture({size:[canvas.width,canvas.height],format:"depth24plus",usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING}),this.depthTextureView=this.depthTexture.createView(),this.sceneUniformsBindGroupLayout=device.createBindGroupLayout({label:"scene uniforms bind group layout",entries:[{binding:0,visibility:GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT|GPUShaderStage.COMPUTE,buffer:{type:"uniform"}},{binding:1,visibility:GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT|GPUShaderStage.COMPUTE,buffer:{type:"read-only-storage"}}]}),this.sceneUniformsBindGroup=device.createBindGroup({label:"scene uniforms bind group",layout:this.sceneUniformsBindGroupLayout,entries:[{binding:0,resource:{buffer:e.camera.uniformsBuffer}},{binding:1,resource:{buffer:this.lights.lightSetStorageBuffer}}]}),this.lightCullingBindGroupLayout=device.createBindGroupLayout({label:"Light Culling CS Layout",entries:[{binding:0,visibility:GPUShaderStage.COMPUTE|GPUShaderStage.FRAGMENT,texture:{sampleType:"unfilterable-float",viewDimension:"2d",multisampled:!1}},{binding:1,visibility:GPUShaderStage.COMPUTE|GPUShaderStage.FRAGMENT,buffer:{type:"read-only-storage"}},{binding:2,visibility:GPUShaderStage.COMPUTE|GPUShaderStage.FRAGMENT,buffer:{type:"storage"}},{binding:3,visibility:GPUShaderStage.COMPUTE|GPUShaderStage.FRAGMENT,buffer:{type:"storage"}},{binding:4,visibility:GPUShaderStage.COMPUTE|GPUShaderStage.FRAGMENT,buffer:{type:"storage"}},{binding:5,visibility:GPUShaderStage.COMPUTE|GPUShaderStage.FRAGMENT,buffer:{type:"storage"}},{binding:6,visibility:GPUShaderStage.COMPUTE|GPUShaderStage.FRAGMENT,buffer:{type:"storage"}}]}),this.lightCullingBindGroup=device.createBindGroup({label:"Light Culling CS Bind",layout:this.lightCullingBindGroupLayout,entries:[{binding:0,resource:this.depthRTTextureView},{binding:1,resource:{buffer:this.lights.lightSetStorageBuffer}},{binding:2,resource:{buffer:this.lightIndices}},{binding:3,resource:{buffer:this.lightGrid}},{binding:4,resource:{buffer:this.tileMinMax}},{binding:5,resource:{buffer:this.lightCountTotal}},{binding:6,resource:{buffer:this.gridSize}}]}),this.zPrepassGraphicsPipeline=device.createRenderPipeline({layout:device.createPipelineLayout({label:"forward plus z prepass pipeline layout",bindGroupLayouts:[this.sceneUniformsBindGroupLayout,modelBindGroupLayout]}),depthStencil:{depthWriteEnabled:!0,depthCompare:"less",format:"depth24plus"},vertex:{module:device.createShaderModule({label:"forward plus vert shader",code:naiveVertSrc}),buffers:[vertexBufferLayout]},fragment:{module:device.createShaderModule({label:"forward plus z prepass frag shader",code:zPrepassFragSrc}),targets:[{format:"r32float"}]}}),this.forwardPlusCSModule=device.createShaderModule({label:"Light Culling CS shader",code:forwardPlusCSRawSrc}),this.computeDepthMinMaxComputePipeline=device.createComputePipeline({label:"Light Culling CS Pipeline",layout:device.createPipelineLayout({label:"Compute Shader Pipeline Layout",bindGroupLayouts:[this.sceneUniformsBindGroupLayout,null,this.lightCullingBindGroupLayout]}),compute:{module:this.forwardPlusCSModule,entryPoint:"computeDepthMinMax"}}),this.computeTileVisibleLightIndexComputePipeline=device.createComputePipeline({label:"Light Culling CS Pipeline",layout:device.createPipelineLayout({label:"Compute Shader Pipeline Layout",bindGroupLayouts:[this.sceneUniformsBindGroupLayout,null,this.lightCullingBindGroupLayout]}),compute:{module:this.forwardPlusCSModule,entryPoint:"computeTileVisibleLightIndex"}}),this.forwardPlusGraphicsPipeline=device.createRenderPipeline({layout:device.createPipelineLayout({label:"forward plus shading pipeline layout",bindGroupLayouts:[this.sceneUniformsBindGroupLayout,modelBindGroupLayout,this.lightCullingBindGroupLayout,materialBindGroupLayout]}),depthStencil:{depthWriteEnabled:!0,depthCompare:"less",format:"depth24plus"},vertex:{module:device.createShaderModule({label:"forward plus vert shader",code:naiveVertSrc}),buffers:[vertexBufferLayout]},fragment:{module:device.createShaderModule({label:"forward plus frag shader",code:forwardPlusFragSrc}),targets:[{format:canvasFormat}]}})}createLayouts(){}async LightCulling(){const e=device.createCommandEncoder();var n=constants.X_SLICES,r=constants.Y_SLICES;device.queue.writeBuffer(this.lightCountTotal,0,this.lightCountTotalArray.buffer),device.queue.writeBuffer(this.lightIndices,0,this.lightIndicesArray.buffer),device.queue.writeBuffer(this.lightGrid,0,this.lightGridArray.buffer);const i=e.beginComputePass();i.setPipeline(this.computeDepthMinMaxComputePipeline),i.setBindGroup(constants.bindGroup_lightCull,this.lightCullingBindGroup),i.setBindGroup(constants.bindGroup_scene,this.sceneUniformsBindGroup),i.dispatchWorkgroups(n,r,1),i.end();const o=e.beginComputePass();o.setPipeline(this.computeTileVisibleLightIndexComputePipeline),o.setBindGroup(constants.bindGroup_lightCull,this.lightCullingBindGroup),o.setBindGroup(constants.bindGroup_scene,this.sceneUniformsBindGroup),o.dispatchWorkgroups(n,r,1),o.end();var a=device.createBuffer({size:this.lightCountTotalArray.byteLength,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ});e.copyBufferToBuffer(this.lightCountTotal,0,a,0,this.lightCountTotalArray.byteLength),device.queue.submit([e.finish()]),await a.mapAsync(GPUMapMode.READ);const l=new Int32Array(a.getMappedRange());console.log("Active lights all grids: "+l[0]),l[0]>this.lightIndicesArray.length&&console.warn("Light Index cannot hold all light instances. Black tile may appear"),a.unmap(),a.destroy()}zPrepass(){const e=device.createCommandEncoder(),n=e.beginRenderPass({label:"forward p render pass",colorAttachments:[{view:this.depthRTTextureView,clearValue:[0,0,0,0],loadOp:"clear",storeOp:"store"}],depthStencilAttachment:{view:this.depthTextureView,depthClearValue:1,depthLoadOp:"clear",depthStoreOp:"store"}});n.setPipeline(this.zPrepassGraphicsPipeline),n.setBindGroup(constants.bindGroup_scene,this.sceneUniformsBindGroup),this.sceneUniformsBindGroup,this.scene.iterate(r=>{n.setBindGroup(constants.bindGroup_model,r.modelBindGroup)},r=>{n.setBindGroup(constants.bindGroup_material,r.materialBindGroup)},r=>{n.setVertexBuffer(0,r.vertexBuffer),n.setIndexBuffer(r.indexBuffer,"uint32"),n.drawIndexed(r.numIndices)}),n.end(),device.queue.submit([e.finish()])}draw(){var e=canvas.width,n=canvas.height,r=Math.floor((e+constants.TILESIZE_X-1)/constants.TILESIZE_X),i=Math.floor((n+constants.TILESIZE_Y-1)/constants.TILESIZE_Y);this.gridSizeArray[0]=r,this.gridSizeArray[1]=i,this.gridSizeArray[2]=1,device.queue.writeBuffer(this.gridSize,0,this.gridSizeArray.buffer),device.queue.writeBuffer(this.lightCountTotal,0,this.lightCountTotalArray.buffer);var o=r*i;console.log("Index length "+o*this.avgLightsPerTile),this.zPrepass();var a=this.LightCulling();a.then(()=>{{const l=context.getCurrentTexture().createView(),A=device.createCommandEncoder(),E=A.beginRenderPass({label:"forward p render pass",colorAttachments:[{view:l,clearValue:[0,0,0,0],loadOp:"clear",storeOp:"store"}],depthStencilAttachment:{view:this.depthTextureView,depthClearValue:1,depthLoadOp:"clear",depthStoreOp:"store"}});E.setPipeline(this.forwardPlusGraphicsPipeline),E.setBindGroup(constants.bindGroup_scene,this.sceneUniformsBindGroup),E.setBindGroup(constants.bindGroup_lightCull,this.lightCullingBindGroup),this.scene.iterate(v=>{E.setBindGroup(constants.bindGroup_model,v.modelBindGroup)},v=>{E.setBindGroup(constants.bindGroup_material,v.materialBindGroup)},v=>{E.setVertexBuffer(0,v.vertexBuffer),E.setIndexBuffer(v.indexBuffer,"uint32"),E.drawIndexed(v.numIndices)}),E.end(),device.queue.submit([A.finish()])}})}}class ClusteredDeferredRenderer extends Renderer{sceneUniformsBindGroupLayout;sceneUniformsBindGroup;lightCullingBindGroupLayout;lightCullingBindGroup;gbuffersBindGroupLayout;gbuffersBindGroup;gbuffersPackedBindGroupLayout;gbuffersPackedBindGroup;GBufferBaseColor;GBufferBaseColorView;GBufferNormal;GBufferNormalView;GBufferDepth;GBufferDepthView;GBufferPacked;GBufferPackedView;depthTexture;depthTextureView;FrameBuffer;FrameBufferView;useCSPipeline=!0;usePackedGBuffer=!0;lightIndices;lightIndicesArray;lightGrid;lightGridArray;tileMinMax;tileMinMaxArray;fullscreenTriangleArray;fullscreenTriangleBuffer;lightCountTotalArray;lightCountTotal;gridSizeArray;gridSize;BasepassGraphicsPipeline;BasepassPackedGraphicsPipeline;computeTileVisibleLightIndexComputePipeline;deferredLightingGraphicsPipeline;deferredLightingComputePipeline;deferredLightingPackedComputePipeline;forwardPlusCSModule;lightCullingBatchSize=64;avgLightsPerCluster=constants.AVG_LIGHTS_PER_CLUSTER;constructor(e){super(e);var n=constants.X_SLICES,r=constants.Y_SLICES,i=constants.Z_SLICES,o=n*r*i;this.fullscreenTriangleArray=new Float32Array([-1,3,0,-1,-1,0,3,-1,0]),this.fullscreenTriangleBuffer=device.createBuffer({label:"Fullscreen Triangle",size:this.fullscreenTriangleArray.byteLength,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST}),device.queue.writeBuffer(this.fullscreenTriangleBuffer,0,this.fullscreenTriangleArray.buffer),this.lightIndicesArray=new Int32Array(o*this.avgLightsPerCluster),this.lightIndicesArray.set(Array(o*this.avgLightsPerCluster).fill(0)),this.lightIndices=device.createBuffer({label:"lightIndices",size:this.lightIndicesArray.byteLength,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST}),this.lightGridArray=new Int32Array(2*o),this.lightGridArray.set(Array(2*o).fill(0)),this.lightGrid=device.createBuffer({label:"lightGrid",size:this.lightGridArray.byteLength,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST}),this.tileMinMaxArray=new Int32Array(2*o),this.tileMinMax=device.createBuffer({label:"tileMinMax",size:this.tileMinMaxArray.byteLength,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC}),this.lightCountTotalArray=new Int32Array(1),this.lightCountTotalArray.set([0],0),this.lightCountTotal=device.createBuffer({label:"lightCountTotal",size:this.lightCountTotalArray.byteLength,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST|GPUBufferUsage.COPY_SRC}),this.gridSizeArray=new Int32Array(3),this.gridSize=device.createBuffer({label:"gridSize",size:16,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST}),this.gridSizeArray[0]=constants.X_SLICES,this.gridSizeArray[1]=constants.Y_SLICES,this.gridSizeArray[2]=constants.Z_SLICES,device.queue.writeBuffer(this.gridSize,0,this.gridSizeArray.buffer),this.GBufferBaseColor=device.createTexture({size:[canvas.width,canvas.height],format:"rgba16float",usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING}),this.GBufferBaseColorView=this.GBufferBaseColor.createView(),this.GBufferNormal=device.createTexture({size:[canvas.width,canvas.height],format:"rgba16float",usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING}),this.GBufferNormalView=this.GBufferNormal.createView(),this.GBufferDepth=device.createTexture({size:[canvas.width,canvas.height],format:"r32float",usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING}),this.GBufferDepthView=this.GBufferDepth.createView(),this.GBufferPacked=device.createTexture({size:[canvas.width,canvas.height],format:"rgba32uint",usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING}),this.GBufferPackedView=this.GBufferPacked.createView(),this.depthTexture=device.createTexture({size:[canvas.width,canvas.height],format:"depth24plus",usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING}),this.depthTextureView=this.depthTexture.createView(),this.FrameBuffer=device.createTexture({size:[canvas.width,canvas.height],format:"rgba32float",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.STORAGE_BINDING}),this.FrameBufferView=this.FrameBuffer.createView(),this.sceneUniformsBindGroupLayout=device.createBindGroupLayout({label:"scene uniforms bind group layout",entries:[{binding:0,visibility:GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT|GPUShaderStage.COMPUTE,buffer:{type:"uniform"}},{binding:1,visibility:GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT|GPUShaderStage.COMPUTE,buffer:{type:"read-only-storage"}}]}),this.sceneUniformsBindGroup=device.createBindGroup({label:"scene uniforms bind group",layout:this.sceneUniformsBindGroupLayout,entries:[{binding:0,resource:{buffer:e.camera.uniformsBuffer}},{binding:1,resource:{buffer:this.lights.lightSetStorageBuffer}}]}),this.lightCullingBindGroupLayout=device.createBindGroupLayout({label:"Light Culling CS Layout",entries:[{binding:1,visibility:GPUShaderStage.COMPUTE|GPUShaderStage.FRAGMENT,buffer:{type:"read-only-storage"}},{binding:2,visibility:GPUShaderStage.COMPUTE|GPUShaderStage.FRAGMENT,buffer:{type:"storage"}},{binding:3,visibility:GPUShaderStage.COMPUTE|GPUShaderStage.FRAGMENT,buffer:{type:"storage"}},{binding:4,visibility:GPUShaderStage.COMPUTE|GPUShaderStage.FRAGMENT,buffer:{type:"storage"}},{binding:5,visibility:GPUShaderStage.COMPUTE|GPUShaderStage.FRAGMENT,buffer:{type:"storage"}},{binding:6,visibility:GPUShaderStage.COMPUTE|GPUShaderStage.FRAGMENT,buffer:{type:"storage"}}]}),this.lightCullingBindGroup=device.createBindGroup({label:"Light Culling CS Bind",layout:this.lightCullingBindGroupLayout,entries:[{binding:1,resource:{buffer:this.lights.lightSetStorageBuffer}},{binding:2,resource:{buffer:this.lightIndices}},{binding:3,resource:{buffer:this.lightGrid}},{binding:4,resource:{buffer:this.tileMinMax}},{binding:5,resource:{buffer:this.lightCountTotal}},{binding:6,resource:{buffer:this.gridSize}}]}),this.gbuffersBindGroupLayout=device.createBindGroupLayout({label:"GBuffer Layout",entries:[{binding:0,visibility:GPUShaderStage.COMPUTE|GPUShaderStage.FRAGMENT,texture:{sampleType:"unfilterable-float",viewDimension:"2d",multisampled:!1}},{binding:1,visibility:GPUShaderStage.COMPUTE|GPUShaderStage.FRAGMENT,texture:{sampleType:"unfilterable-float",viewDimension:"2d",multisampled:!1}},{binding:2,visibility:GPUShaderStage.COMPUTE|GPUShaderStage.FRAGMENT,texture:{sampleType:"unfilterable-float",viewDimension:"2d",multisampled:!1}},{binding:3,visibility:GPUShaderStage.COMPUTE,storageTexture:{access:"write-only",format:"rgba8unorm",viewDimension:"2d"}}]}),this.gbuffersBindGroup=device.createBindGroup({label:"GBuffer Bind",layout:this.gbuffersBindGroupLayout,entries:[{binding:0,resource:this.GBufferBaseColorView},{binding:1,resource:this.GBufferNormalView},{binding:2,resource:this.GBufferDepthView},{binding:3,resource:context.getCurrentTexture().createView()}]}),this.gbuffersPackedBindGroupLayout=device.createBindGroupLayout({label:"GBufferPacked Layout",entries:[{binding:0,visibility:GPUShaderStage.COMPUTE|GPUShaderStage.FRAGMENT,texture:{sampleType:"uint",viewDimension:"2d",multisampled:!1}},{binding:1,visibility:GPUShaderStage.COMPUTE,storageTexture:{access:"write-only",format:"rgba8unorm",viewDimension:"2d"}}]}),this.gbuffersPackedBindGroup=device.createBindGroup({label:"GBufferPacked Bind",layout:this.gbuffersPackedBindGroupLayout,entries:[{binding:0,resource:this.GBufferPackedView},{binding:1,resource:context.getCurrentTexture().createView()}]}),this.BasepassGraphicsPipeline=device.createRenderPipeline({layout:device.createPipelineLayout({label:"basepass pipeline layout",bindGroupLayouts:[this.sceneUniformsBindGroupLayout,modelBindGroupLayout,null,materialBindGroupLayout]}),depthStencil:{depthWriteEnabled:!0,depthCompare:"less",format:"depth24plus"},vertex:{module:device.createShaderModule({label:"deferred basepass vert shader",code:naiveVertSrc}),entryPoint:"main",buffers:[vertexBufferLayout]},fragment:{module:device.createShaderModule({label:"deferred basepass frag shader",code:clusteredDeferredFragSrc}),entryPoint:"main",targets:[{format:"rgba16float"},{format:"rgba16float"},{format:"r32float"}]}}),this.BasepassPackedGraphicsPipeline=device.createRenderPipeline({layout:device.createPipelineLayout({label:"basepass packed pipeline layout",bindGroupLayouts:[this.sceneUniformsBindGroupLayout,modelBindGroupLayout,null,materialBindGroupLayout]}),depthStencil:{depthWriteEnabled:!0,depthCompare:"less",format:"depth24plus"},vertex:{module:device.createShaderModule({label:"deferred basepass vert shader",code:naiveVertSrc}),entryPoint:"main",buffers:[vertexBufferLayout]},fragment:{module:device.createShaderModule({label:"deferred packed basepass frag shader",code:clusteredDeferredPackedFragSrc}),entryPoint:"main",targets:[{format:"rgba32uint"}]}}),this.forwardPlusCSModule=device.createShaderModule({label:"Light Culling CS shader",code:clusteringComputeSrc}),this.computeTileVisibleLightIndexComputePipeline=device.createComputePipeline({label:"Light Culling CS Pipeline",layout:device.createPipelineLayout({label:"Compute Shader Pipeline Layout",bindGroupLayouts:[this.sceneUniformsBindGroupLayout,null,this.lightCullingBindGroupLayout]}),compute:{module:this.forwardPlusCSModule,entryPoint:"computeTileVisibleLightIndex"}}),this.deferredLightingComputePipeline=device.createComputePipeline({label:"Deferred Lighting CS Pipeline",layout:device.createPipelineLayout({label:"Compute Shader Pipeline Layout",bindGroupLayouts:[this.sceneUniformsBindGroupLayout,null,this.lightCullingBindGroupLayout,this.gbuffersBindGroupLayout]}),compute:{module:device.createShaderModule({label:"Deferred lighting cs shader",code:clusteredDeferredFullscreenCSSrc}),entryPoint:"deferredShadingCS"}}),this.deferredLightingPackedComputePipeline=device.createComputePipeline({label:"Deferred Lighting Packed CS Pipeline",layout:device.createPipelineLayout({label:"Packed Compute Shader Pipeline Layout",bindGroupLayouts:[this.sceneUniformsBindGroupLayout,null,this.lightCullingBindGroupLayout,this.gbuffersPackedBindGroupLayout]}),compute:{module:device.createShaderModule({label:"Deferred lighting cs shader",code:clusteredDeferredFullscreenPackedCSSrc}),entryPoint:"deferredShadingCS"}}),this.deferredLightingGraphicsPipeline=device.createRenderPipeline({layout:device.createPipelineLayout({label:"deferred lighting pipeline layout",bindGroupLayouts:[this.sceneUniformsBindGroupLayout,null,this.lightCullingBindGroupLayout,this.gbuffersBindGroupLayout]}),depthStencil:{depthWriteEnabled:!0,depthCompare:"less",format:"depth24plus"},vertex:{module:device.createShaderModule({label:"Lighting full screen vert shader",code:clusteredDeferredFullscreenVertSrc}),entryPoint:"main",buffers:[fullscreenVertexBufferLayout]},fragment:{module:device.createShaderModule({label:"Lighting full screen frag shader",code:clusteredDeferredFullscreenFragSrc}),entryPoint:"main",targets:[{format:canvasFormat}]}})}createLayouts(){}async LightCulling(){const e=device.createCommandEncoder();var n=constants.X_SLICES,r=constants.Y_SLICES,i=constants.Z_SLICES;device.queue.writeBuffer(this.lightCountTotal,0,this.lightCountTotalArray.buffer),device.queue.writeBuffer(this.lightIndices,0,this.lightIndicesArray.buffer),device.queue.writeBuffer(this.lightGrid,0,this.lightGridArray.buffer);const o=e.beginComputePass();o.setPipeline(this.computeTileVisibleLightIndexComputePipeline),o.setBindGroup(constants.bindGroup_lightCull,this.lightCullingBindGroup),o.setBindGroup(constants.bindGroup_scene,this.sceneUniformsBindGroup),o.dispatchWorkgroups(n,r,i),o.end();var a=device.createBuffer({size:this.lightCountTotalArray.byteLength,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ});e.copyBufferToBuffer(this.lightCountTotal,0,a,0,this.lightCountTotalArray.byteLength),device.queue.submit([e.finish()]),await a.mapAsync(GPUMapMode.READ);const l=new Int32Array(a.getMappedRange());console.log("Active lights all grids: "+l[0]);var A=l[0];A/this.gridSizeArray[0]/this.gridSizeArray[1]>constants.AVG_LIGHTS_PER_CLUSTER&&console.warn("AVG_LIGHTS_PER_CLUSTER cannot support all lights, screen may flicker"),A>this.lightIndicesArray.length&&console.warn("Light Index cannot hold all light instances. Black tile may appear"),a.unmap(),a.destroy()}BasePass(){const e=device.createCommandEncoder();var n;this.usePackedGBuffer?n={label:"forward p base pass",colorAttachments:[{view:this.GBufferPackedView,clearValue:[0,0,0,0],loadOp:"clear",storeOp:"store"}],depthStencilAttachment:{view:this.depthTextureView,depthClearValue:1,depthLoadOp:"clear",depthStoreOp:"store"}}:n={label:"forward p base pass",colorAttachments:[{view:this.GBufferBaseColorView,clearValue:[0,0,0,0],loadOp:"clear",storeOp:"store"},{view:this.GBufferNormalView,clearValue:[0,0,0,0],loadOp:"clear",storeOp:"store"},{view:this.GBufferDepthView,clearValue:[0,0,0,0],loadOp:"clear",storeOp:"store"}],depthStencilAttachment:{view:this.depthTextureView,depthClearValue:1,depthLoadOp:"clear",depthStoreOp:"store"}};const r=e.beginRenderPass(n);this.usePackedGBuffer?r.setPipeline(this.BasepassPackedGraphicsPipeline):r.setPipeline(this.BasepassGraphicsPipeline),r.setBindGroup(constants.bindGroup_scene,this.sceneUniformsBindGroup),this.sceneUniformsBindGroup,this.scene.iterate(i=>{r.setBindGroup(constants.bindGroup_model,i.modelBindGroup)},i=>{r.setBindGroup(constants.bindGroup_material,i.materialBindGroup)},i=>{r.setVertexBuffer(0,i.vertexBuffer),r.setIndexBuffer(i.indexBuffer,"uint32"),r.drawIndexed(i.numIndices)}),r.end(),device.queue.submit([e.finish()])}draw(){device.queue.writeBuffer(this.lightCountTotal,0,this.lightCountTotalArray.buffer),this.BasePass();var e=this.LightCulling();e.then(()=>{if(this.usePackedGBuffer){const i=device.createCommandEncoder();var n=Math.ceil(canvas.width/16),r=Math.ceil(canvas.height/16);const o=i.beginComputePass();o.setPipeline(this.deferredLightingPackedComputePipeline),o.setBindGroup(constants.bindGroup_scene,this.sceneUniformsBindGroup),o.setBindGroup(constants.bindGroup_lightCull,this.lightCullingBindGroup),this.gbuffersPackedBindGroup=device.createBindGroup({label:"GBuffer Packed Bind",layout:this.gbuffersPackedBindGroupLayout,entries:[{binding:0,resource:this.GBufferPackedView},{binding:1,resource:context.getCurrentTexture().createView()}]}),o.setBindGroup(constants.bindGroup_deferredLighting,this.gbuffersPackedBindGroup),o.dispatchWorkgroups(n,r,1),o.end(),device.queue.submit([i.finish()])}else if(this.useCSPipeline){const i=device.createCommandEncoder();var n=Math.ceil(canvas.width/16),r=Math.ceil(canvas.height/16);const l=i.beginComputePass();l.setPipeline(this.deferredLightingComputePipeline),l.setBindGroup(constants.bindGroup_scene,this.sceneUniformsBindGroup),l.setBindGroup(constants.bindGroup_lightCull,this.lightCullingBindGroup),this.gbuffersBindGroup=device.createBindGroup({label:"GBuffer Bind",layout:this.gbuffersBindGroupLayout,entries:[{binding:0,resource:this.GBufferBaseColorView},{binding:1,resource:this.GBufferNormalView},{binding:2,resource:this.GBufferDepthView},{binding:3,resource:context.getCurrentTexture().createView()}]}),l.setBindGroup(constants.bindGroup_deferredLighting,this.gbuffersBindGroup),l.dispatchWorkgroups(n,r,1),l.end(),device.queue.submit([i.finish()])}else{const i=context.getCurrentTexture().createView(),o=device.createCommandEncoder(),a=o.beginRenderPass({label:"deferred shading pass",colorAttachments:[{view:i,clearValue:[0,0,0,0],loadOp:"clear",storeOp:"store"}],depthStencilAttachment:{view:this.depthTextureView,depthClearValue:1,depthLoadOp:"clear",depthStoreOp:"store"}});a.setPipeline(this.deferredLightingGraphicsPipeline),a.setBindGroup(constants.bindGroup_scene,this.sceneUniformsBindGroup),a.setBindGroup(constants.bindGroup_lightCull,this.lightCullingBindGroup),a.setBindGroup(constants.bindGroup_deferredLighting,this.gbuffersBindGroup),a.setVertexBuffer(0,this.fullscreenTriangleBuffer),a.draw(3,1,0,0),a.end(),device.queue.submit([o.finish()])}})}}async function parseFromContext(t,e,n,r){return r._parse(t,e,n,r)}function assert$4(t,e){if(!t)throw new Error(e||"loader assertion failed.")}const isBrowser$2=!!(typeof process!="object"||String(process)!=="[object process]"||process.browser),matches$1=typeof process<"u"&&process.version&&/v([0-9]*)/.exec(process.version);matches$1&&parseFloat(matches$1[1]);const window_=globalThis,process_=globalThis.process||{};function isElectron(t){if(typeof window<"u"&&window.process?.type==="renderer"||typeof process<"u"&&process.versions?.electron)return!0;const n=typeof navigator<"u"&&navigator.userAgent;return!!(n&&n.indexOf("Electron")>=0)}function isBrowser$1(){return!(typeof process=="object"&&String(process)==="[object process]"&&!process?.browser)||isElectron()}const VERSION$6="4.1.0";function getStorage(t){try{const e=window[t],n="__storage_test__";return e.setItem(n,n),e.removeItem(n),e}catch{return null}}class LocalStorage{constructor(e,n,r="sessionStorage"){this.storage=getStorage(r),this.id=e,this.config=n,this._loadConfiguration()}getConfiguration(){return this.config}setConfiguration(e){if(Object.assign(this.config,e),this.storage){const n=JSON.stringify(this.config);this.storage.setItem(this.id,n)}}_loadConfiguration(){let e={};if(this.storage){const n=this.storage.getItem(this.id);e=n?JSON.parse(n):{}}return Object.assign(this.config,e),this}}function formatTime(t){let e;return t<10?e=`${t.toFixed(2)}ms`:t<100?e=`${t.toFixed(1)}ms`:t<1e3?e=`${t.toFixed(0)}ms`:e=`${(t/1e3).toFixed(2)}s`,e}function leftPad(t,e=8){const n=Math.max(e-t.length,0);return`${" ".repeat(n)}${t}`}var COLOR;(function(t){t[t.BLACK=30]="BLACK",t[t.RED=31]="RED",t[t.GREEN=32]="GREEN",t[t.YELLOW=33]="YELLOW",t[t.BLUE=34]="BLUE",t[t.MAGENTA=35]="MAGENTA",t[t.CYAN=36]="CYAN",t[t.WHITE=37]="WHITE",t[t.BRIGHT_BLACK=90]="BRIGHT_BLACK",t[t.BRIGHT_RED=91]="BRIGHT_RED",t[t.BRIGHT_GREEN=92]="BRIGHT_GREEN",t[t.BRIGHT_YELLOW=93]="BRIGHT_YELLOW",t[t.BRIGHT_BLUE=94]="BRIGHT_BLUE",t[t.BRIGHT_MAGENTA=95]="BRIGHT_MAGENTA",t[t.BRIGHT_CYAN=96]="BRIGHT_CYAN",t[t.BRIGHT_WHITE=97]="BRIGHT_WHITE"})(COLOR||(COLOR={}));const BACKGROUND_INCREMENT=10;function getColor(t){return typeof t!="string"?t:(t=t.toUpperCase(),COLOR[t]||COLOR.WHITE)}function addColor(t,e,n){return!isBrowser$1&&typeof t=="string"&&(e&&(t=`\x1B[${getColor(e)}m${t}\x1B[39m`),n&&(t=`\x1B[${getColor(n)+BACKGROUND_INCREMENT}m${t}\x1B[49m`)),t}function autobind(t,e=["constructor"]){const n=Object.getPrototypeOf(t),r=Object.getOwnPropertyNames(n),i=t;for(const o of r){const a=i[o];typeof a=="function"&&(e.find(l=>o===l)||(i[o]=a.bind(t)))}}function assert$3(t,e){if(!t)throw new Error("Assertion failed")}function getHiResTimestamp(){let t;if(isBrowser$1()&&window_.performance)t=window_?.performance?.now?.();else if("hrtime"in process_){const e=process_?.hrtime?.();t=e[0]*1e3+e[1]/1e6}else t=Date.now();return t}const originalConsole={debug:isBrowser$1()&&console.debug||console.log,log:console.log,info:console.info,warn:console.warn,error:console.error},DEFAULT_LOG_CONFIGURATION={enabled:!0,level:0};function noop(){}const cache$6={},ONCE={once:!0};class Log{constructor({id:e}={id:""}){this.VERSION=VERSION$6,this._startTs=getHiResTimestamp(),this._deltaTs=getHiResTimestamp(),this.userData={},this.LOG_THROTTLE_TIMEOUT=0,this.id=e,this.userData={},this._storage=new LocalStorage(`__probe-${this.id}__`,DEFAULT_LOG_CONFIGURATION),this.timeStamp(`${this.id} started`),autobind(this),Object.seal(this)}set level(e){this.setLevel(e)}get level(){return this.getLevel()}isEnabled(){return this._storage.config.enabled}getLevel(){return this._storage.config.level}getTotal(){return Number((getHiResTimestamp()-this._startTs).toPrecision(10))}getDelta(){return Number((getHiResTimestamp()-this._deltaTs).toPrecision(10))}set priority(e){this.level=e}get priority(){return this.level}getPriority(){return this.level}enable(e=!0){return this._storage.setConfiguration({enabled:e}),this}setLevel(e){return this._storage.setConfiguration({level:e}),this}get(e){return this._storage.config[e]}set(e,n){this._storage.setConfiguration({[e]:n})}settings(){console.table?console.table(this._storage.config):console.log(this._storage.config)}assert(e,n){if(!e)throw new Error(n||"Assertion failed")}warn(e){return this._getLogFunction(0,e,originalConsole.warn,arguments,ONCE)}error(e){return this._getLogFunction(0,e,originalConsole.error,arguments)}deprecated(e,n){return this.warn(`\`${e}\` is deprecated and will be removed in a later version. Use \`${n}\` instead`)}removed(e,n){return this.error(`\`${e}\` has been removed. Use \`${n}\` instead`)}probe(e,n){return this._getLogFunction(e,n,originalConsole.log,arguments,{time:!0,once:!0})}log(e,n){return this._getLogFunction(e,n,originalConsole.debug,arguments)}info(e,n){return this._getLogFunction(e,n,console.info,arguments)}once(e,n){return this._getLogFunction(e,n,originalConsole.debug||originalConsole.info,arguments,ONCE)}table(e,n,r){return n?this._getLogFunction(e,n,console.table||noop,r&&[r],{tag:getTableHeader(n)}):noop}time(e,n){return this._getLogFunction(e,n,console.time?console.time:console.info)}timeEnd(e,n){return this._getLogFunction(e,n,console.timeEnd?console.timeEnd:console.info)}timeStamp(e,n){return this._getLogFunction(e,n,console.timeStamp||noop)}group(e,n,r={collapsed:!1}){const i=normalizeArguments({logLevel:e,message:n,opts:r}),{collapsed:o}=r;return i.method=(o?console.groupCollapsed:console.group)||console.info,this._getLogFunction(i)}groupCollapsed(e,n,r={}){return this.group(e,n,Object.assign({},r,{collapsed:!0}))}groupEnd(e){return this._getLogFunction(e,"",console.groupEnd||noop)}withGroup(e,n,r){this.group(e,n)();try{r()}finally{this.groupEnd(e)()}}trace(){console.trace&&console.trace()}_shouldLog(e){return this.isEnabled()&&this.getLevel()>=normalizeLogLevel(e)}_getLogFunction(e,n,r,i,o){if(this._shouldLog(e)){o=normalizeArguments({logLevel:e,message:n,args:i,opts:o}),r=r||o.method,assert$3(r),o.total=this.getTotal(),o.delta=this.getDelta(),this._deltaTs=getHiResTimestamp();const a=o.tag||o.message;if(o.once&&a)if(!cache$6[a])cache$6[a]=getHiResTimestamp();else return noop;return n=decorateMessage(this.id,o.message,o),r.bind(console,n,...o.args)}return noop}}Log.VERSION=VERSION$6;function normalizeLogLevel(t){if(!t)return 0;let e;switch(typeof t){case"number":e=t;break;case"object":e=t.logLevel||t.priority||0;break;default:return 0}return assert$3(Number.isFinite(e)&&e>=0),e}function normalizeArguments(t){const{logLevel:e,message:n}=t;t.logLevel=normalizeLogLevel(e);const r=t.args?Array.from(t.args):[];for(;r.length&&r.shift()!==n;);switch(typeof e){case"string":case"function":n!==void 0&&r.unshift(n),t.message=e;break;case"object":Object.assign(t,e);break}typeof t.message=="function"&&(t.message=t.message());const i=typeof t.message;return assert$3(i==="string"||i==="object"),Object.assign(t,{args:r},t.opts)}function decorateMessage(t,e,n){if(typeof e=="string"){const r=n.time?leftPad(formatTime(n.total)):"";e=n.time?`${t}: ${r}  ${e}`:`${t}: ${e}`,e=addColor(e,n.color,n.background)}return e}function getTableHeader(t){for(const e in t)for(const n in t[e])return n||"untitled";return"empty"}const VERSION$5="4.3.3",version=VERSION$5[0]>="0"&&VERSION$5[0]<="9"?`v${VERSION$5}`:"";function createLog(){const t=new Log({id:"loaders.gl"});return globalThis.loaders=globalThis.loaders||{},globalThis.loaders.log=t,globalThis.loaders.version=version,globalThis.probe=globalThis.probe||{},globalThis.probe.loaders=t,t}const log=createLog();function mergeLoaderOptions(t,e){return mergeOptionsRecursively(t||{},e)}function mergeOptionsRecursively(t,e,n=0){if(n>3)return e;const r={...t};for(const[i,o]of Object.entries(e))o&&typeof o=="object"&&!Array.isArray(o)?r[i]=mergeOptionsRecursively(r[i]||{},e[i],n+1):r[i]=e[i];return r}function registerJSModules(t){globalThis.loaders||={},globalThis.loaders.modules||={},Object.assign(globalThis.loaders.modules,t)}function getJSModuleOrNull(t){return globalThis.loaders?.modules?.[t]||null}const NPM_TAG="latest";function getVersion(){return globalThis._loadersgl_?.version||(globalThis._loadersgl_=globalThis._loadersgl_||{},globalThis._loadersgl_.version="4.3.3"),globalThis._loadersgl_.version}const VERSION$4=getVersion();function assert$2(t,e){if(!t)throw new Error(e||"loaders.gl assertion failed.")}const isBrowser=typeof process!="object"||String(process)!=="[object process]"||process.browser,isWorker=typeof importScripts=="function",isMobile=typeof window<"u"&&typeof window.orientation<"u",matches=typeof process<"u"&&process.version&&/v([0-9]*)/.exec(process.version);matches&&parseFloat(matches[1]);class WorkerJob{name;workerThread;isRunning=!0;result;_resolve=()=>{};_reject=()=>{};constructor(e,n){this.name=e,this.workerThread=n,this.result=new Promise((r,i)=>{this._resolve=r,this._reject=i})}postMessage(e,n){this.workerThread.postMessage({source:"loaders.gl",type:e,payload:n})}done(e){assert$2(this.isRunning),this.isRunning=!1,this._resolve(e)}error(e){assert$2(this.isRunning),this.isRunning=!1,this._reject(e)}}class NodeWorker{terminate(){}}const workerURLCache=new Map;function getLoadableWorkerURL(t){assert$2(t.source&&!t.url||!t.source&&t.url);let e=workerURLCache.get(t.source||t.url);return e||(t.url&&(e=getLoadableWorkerURLFromURL(t.url),workerURLCache.set(t.url,e)),t.source&&(e=getLoadableWorkerURLFromSource(t.source),workerURLCache.set(t.source,e))),assert$2(e),e}function getLoadableWorkerURLFromURL(t){if(!t.startsWith("http"))return t;const e=buildScriptSource(t);return getLoadableWorkerURLFromSource(e)}function getLoadableWorkerURLFromSource(t){const e=new Blob([t],{type:"application/javascript"});return URL.createObjectURL(e)}function buildScriptSource(t){return`try {
  importScripts('${t}');
} catch (error) {
  console.error(error);
  throw error;
}`}function getTransferList(t,e=!0,n){const r=n||new Set;if(t){if(isTransferable(t))r.add(t);else if(isTransferable(t.buffer))r.add(t.buffer);else if(!ArrayBuffer.isView(t)){if(e&&typeof t=="object")for(const i in t)getTransferList(t[i],e,r)}}return n===void 0?Array.from(r):[]}function isTransferable(t){return t?t instanceof ArrayBuffer||typeof MessagePort<"u"&&t instanceof MessagePort||typeof ImageBitmap<"u"&&t instanceof ImageBitmap||typeof OffscreenCanvas<"u"&&t instanceof OffscreenCanvas:!1}const NOOP=()=>{};class WorkerThread{name;source;url;terminated=!1;worker;onMessage;onError;_loadableURL="";static isSupported(){return typeof Worker<"u"&&isBrowser||typeof NodeWorker<"u"&&!isBrowser}constructor(e){const{name:n,source:r,url:i}=e;assert$2(r||i),this.name=n,this.source=r,this.url=i,this.onMessage=NOOP,this.onError=o=>console.log(o),this.worker=isBrowser?this._createBrowserWorker():this._createNodeWorker()}destroy(){this.onMessage=NOOP,this.onError=NOOP,this.worker.terminate(),this.terminated=!0}get isRunning(){return!!this.onMessage}postMessage(e,n){n=n||getTransferList(e),this.worker.postMessage(e,n)}_getErrorFromErrorEvent(e){let n="Failed to load ";return n+=`worker ${this.name} from ${this.url}. `,e.message&&(n+=`${e.message} in `),e.lineno&&(n+=`:${e.lineno}:${e.colno}`),new Error(n)}_createBrowserWorker(){this._loadableURL=getLoadableWorkerURL({source:this.source,url:this.url});const e=new Worker(this._loadableURL,{name:this.name});return e.onmessage=n=>{n.data?this.onMessage(n.data):this.onError(new Error("No data received"))},e.onerror=n=>{this.onError(this._getErrorFromErrorEvent(n)),this.terminated=!0},e.onmessageerror=n=>console.error(n),e}_createNodeWorker(){let e;if(this.url){const r=this.url.includes(":/")||this.url.startsWith("/")?this.url:`./${this.url}`;e=new NodeWorker(r,{eval:!1})}else if(this.source)e=new NodeWorker(this.source,{eval:!0});else throw new Error("no worker");return e.on("message",n=>{this.onMessage(n)}),e.on("error",n=>{this.onError(n)}),e.on("exit",n=>{}),e}}class WorkerPool{name="unnamed";source;url;maxConcurrency=1;maxMobileConcurrency=1;onDebug=()=>{};reuseWorkers=!0;props={};jobQueue=[];idleQueue=[];count=0;isDestroyed=!1;static isSupported(){return WorkerThread.isSupported()}constructor(e){this.source=e.source,this.url=e.url,this.setProps(e)}destroy(){this.idleQueue.forEach(e=>e.destroy()),this.isDestroyed=!0}setProps(e){this.props={...this.props,...e},e.name!==void 0&&(this.name=e.name),e.maxConcurrency!==void 0&&(this.maxConcurrency=e.maxConcurrency),e.maxMobileConcurrency!==void 0&&(this.maxMobileConcurrency=e.maxMobileConcurrency),e.reuseWorkers!==void 0&&(this.reuseWorkers=e.reuseWorkers),e.onDebug!==void 0&&(this.onDebug=e.onDebug)}async startJob(e,n=(i,o,a)=>i.done(a),r=(i,o)=>i.error(o)){const i=new Promise(o=>(this.jobQueue.push({name:e,onMessage:n,onError:r,onStart:o}),this));return this._startQueuedJob(),await i}async _startQueuedJob(){if(!this.jobQueue.length)return;const e=this._getAvailableWorker();if(!e)return;const n=this.jobQueue.shift();if(n){this.onDebug({message:"Starting job",name:n.name,workerThread:e,backlog:this.jobQueue.length});const r=new WorkerJob(n.name,e);e.onMessage=i=>n.onMessage(r,i.type,i.payload),e.onError=i=>n.onError(r,i),n.onStart(r);try{await r.result}catch(i){console.error(`Worker exception: ${i}`)}finally{this.returnWorkerToQueue(e)}}}returnWorkerToQueue(e){!isBrowser||this.isDestroyed||!this.reuseWorkers||this.count>this._getMaxConcurrency()?(e.destroy(),this.count--):this.idleQueue.push(e),this.isDestroyed||this._startQueuedJob()}_getAvailableWorker(){if(this.idleQueue.length>0)return this.idleQueue.shift()||null;if(this.count<this._getMaxConcurrency()){this.count++;const e=`${this.name.toLowerCase()} (#${this.count} of ${this.maxConcurrency})`;return new WorkerThread({name:e,source:this.source,url:this.url})}return null}_getMaxConcurrency(){return isMobile?this.maxMobileConcurrency:this.maxConcurrency}}const DEFAULT_PROPS={maxConcurrency:3,maxMobileConcurrency:1,reuseWorkers:!0,onDebug:()=>{}};class WorkerFarm{props;workerPools=new Map;static _workerFarm;static isSupported(){return WorkerThread.isSupported()}static getWorkerFarm(e={}){return WorkerFarm._workerFarm=WorkerFarm._workerFarm||new WorkerFarm({}),WorkerFarm._workerFarm.setProps(e),WorkerFarm._workerFarm}constructor(e){this.props={...DEFAULT_PROPS},this.setProps(e),this.workerPools=new Map}destroy(){for(const e of this.workerPools.values())e.destroy();this.workerPools=new Map}setProps(e){this.props={...this.props,...e};for(const n of this.workerPools.values())n.setProps(this._getWorkerPoolProps())}getWorkerPool(e){const{name:n,source:r,url:i}=e;let o=this.workerPools.get(n);return o||(o=new WorkerPool({name:n,source:r,url:i}),o.setProps(this._getWorkerPoolProps()),this.workerPools.set(n,o)),o}_getWorkerPoolProps(){return{maxConcurrency:this.props.maxConcurrency,maxMobileConcurrency:this.props.maxMobileConcurrency,reuseWorkers:this.props.reuseWorkers,onDebug:this.props.onDebug}}}function getWorkerURL(t,e={}){const n=e[t.id]||{},r=isBrowser?`${t.id}-worker.js`:`${t.id}-worker-node.js`;let i=n.workerUrl;if(!i&&t.id==="compression"&&(i=e.workerUrl),e._workerType==="test"&&(isBrowser?i=`modules/${t.module}/dist/${r}`:i=`modules/${t.module}/src/workers/${t.id}-worker-node.ts`),!i){let o=t.version;o==="latest"&&(o=NPM_TAG);const a=o?`@${o}`:"";i=`https://unpkg.com/@loaders.gl/${t.module}${a}/dist/${r}`}return assert$2(i),i}function validateWorkerVersion(t,e=VERSION$4){assert$2(t,"no worker provided");const n=t.version;return!(!e||!n)}const loadLibraryPromises={};async function loadLibrary(t,e=null,n={},r=null){return e&&(t=getLibraryUrl(t,e,n,r)),loadLibraryPromises[t]=loadLibraryPromises[t]||loadLibraryFromFile(t),await loadLibraryPromises[t]}function getLibraryUrl(t,e,n={},r=null){if(!n.useLocalLibraries&&t.startsWith("http"))return t;r=r||t;const i=n.modules||{};return i[r]?i[r]:isBrowser?n.CDN?(assert$2(n.CDN.startsWith("http")),`${n.CDN}/${e}@${VERSION$4}/dist/libs/${r}`):isWorker?`../src/libs/${r}`:`modules/${e}/src/libs/${r}`:`modules/${e}/dist/libs/${r}`}async function loadLibraryFromFile(t){if(t.endsWith("wasm"))return await loadAsArrayBuffer(t);if(!isBrowser)try{const{requireFromFile:n}=globalThis.loaders||{};return await n?.(t)}catch(n){return console.error(n),null}if(isWorker)return importScripts(t);const e=await loadAsText(t);return loadLibraryFromString(e,t)}function loadLibraryFromString(t,e){if(!isBrowser){const{requireFromString:r}=globalThis.loaders||{};return r?.(t,e)}if(isWorker)return eval.call(globalThis,t),null;const n=document.createElement("script");n.id=e;try{n.appendChild(document.createTextNode(t))}catch{n.text=t}return document.body.appendChild(n),null}async function loadAsArrayBuffer(t){const{readFileAsArrayBuffer:e}=globalThis.loaders||{};return isBrowser||!e||t.startsWith("http")?await(await fetch(t)).arrayBuffer():await e(t)}async function loadAsText(t){const{readFileAsText:e}=globalThis.loaders||{};return isBrowser||!e||t.startsWith("http")?await(await fetch(t)).text():await e(t)}function canParseWithWorker(t,e){return!WorkerFarm.isSupported()||!isBrowser&&!e?._nodeWorkers?!1:t.worker&&e?.worker}async function parseWithWorker(t,e,n,r,i){const o=t.id,a=getWorkerURL(t,n),A=WorkerFarm.getWorkerFarm(n).getWorkerPool({name:o,url:a});n=JSON.parse(JSON.stringify(n)),r=JSON.parse(JSON.stringify(r||{}));const E=await A.startJob("process-on-worker",onMessage.bind(null,i));return E.postMessage("process",{input:e,options:n,context:r}),await(await E.result).result}async function onMessage(t,e,n,r){switch(n){case"done":e.done(r);break;case"error":e.error(new Error(r.error));break;case"process":const{id:i,input:o,options:a}=r;try{const l=await t(o,a);e.postMessage("done",{id:i,result:l})}catch(l){const A=l instanceof Error?l.message:"unknown error";e.postMessage("error",{id:i,error:A})}break;default:console.warn(`parse-with-worker unknown message ${n}`)}}function getFirstCharacters$1(t,e=5){return typeof t=="string"?t.slice(0,e):ArrayBuffer.isView(t)?getMagicString$2(t.buffer,t.byteOffset,e):t instanceof ArrayBuffer?getMagicString$2(t,0,e):""}function getMagicString$2(t,e,n){if(t.byteLength<=e+n)return"";const r=new DataView(t);let i="";for(let o=0;o<n;o++)i+=String.fromCharCode(r.getUint8(e+o));return i}function parseJSON(t){try{return JSON.parse(t)}catch{throw new Error(`Failed to parse JSON from data starting with "${getFirstCharacters$1(t)}"`)}}function compareArrayBuffers(t,e,n){if(n=n||t.byteLength,t.byteLength<n||e.byteLength<n)return!1;const r=new Uint8Array(t),i=new Uint8Array(e);for(let o=0;o<r.length;++o)if(r[o]!==i[o])return!1;return!0}function concatenateArrayBuffers(...t){return concatenateArrayBuffersFromArray(t)}function concatenateArrayBuffersFromArray(t){const e=t.map(o=>o instanceof ArrayBuffer?new Uint8Array(o):o),n=e.reduce((o,a)=>o+a.byteLength,0),r=new Uint8Array(n);let i=0;for(const o of e)r.set(o,i),i+=o.byteLength;return r.buffer}function sliceArrayBuffer(t,e,n){const r=n!==void 0?new Uint8Array(t).subarray(e,e+n):new Uint8Array(t).subarray(e);return new Uint8Array(r).buffer}function padToNBytes(t,e){return assert$4(t>=0),assert$4(e>0),t+(e-1)&-4}function copyToArray(t,e,n){let r;if(t instanceof ArrayBuffer)r=new Uint8Array(t);else{const i=t.byteOffset,o=t.byteLength;r=new Uint8Array(t.buffer||t.arrayBuffer,i,o)}return e.set(r,n),n+padToNBytes(r.byteLength,4)}async function concatenateArrayBuffersAsync(t){const e=[];for await(const n of t)e.push(n);return concatenateArrayBuffers(...e)}let pathPrefix="";const fileAliases={};function resolvePath(t){for(const e in fileAliases)if(t.startsWith(e)){const n=fileAliases[e];t=t.replace(e,n)}return!t.startsWith("http://")&&!t.startsWith("https://")&&(t=`${pathPrefix}${t}`),t}function toArrayBuffer$1(t){return t}function isBuffer$1(t){return t&&typeof t=="object"&&t.isBuffer}function toArrayBuffer(t){if(isBuffer$1(t))return t;if(t instanceof ArrayBuffer)return t;if(ArrayBuffer.isView(t))return t.byteOffset===0&&t.byteLength===t.buffer.byteLength?t.buffer:t.buffer.slice(t.byteOffset,t.byteOffset+t.byteLength);if(typeof t=="string"){const e=t;return new TextEncoder().encode(e).buffer}if(t&&typeof t=="object"&&t._toArrayBuffer)return t._toArrayBuffer();throw new Error("toArrayBuffer")}function filename(t){const e=t?t.lastIndexOf("/"):-1;return e>=0?t.substr(e+1):""}function dirname(t){const e=t?t.lastIndexOf("/"):-1;return e>=0?t.substr(0,e):""}const isBoolean=t=>typeof t=="boolean",isFunction=t=>typeof t=="function",isObject=t=>t!==null&&typeof t=="object",isPureObject=t=>isObject(t)&&t.constructor==={}.constructor,isIterable=t=>!!t&&typeof t[Symbol.iterator]=="function",isAsyncIterable=t=>t&&typeof t[Symbol.asyncIterator]=="function",isResponse=t=>typeof Response<"u"&&t instanceof Response||t&&t.arrayBuffer&&t.text&&t.json,isBlob=t=>typeof Blob<"u"&&t instanceof Blob,isBuffer=t=>t&&typeof t=="object"&&t.isBuffer,isReadableDOMStream=t=>typeof ReadableStream<"u"&&t instanceof ReadableStream||isObject(t)&&isFunction(t.tee)&&isFunction(t.cancel)&&isFunction(t.getReader),isReadableNodeStream=t=>isObject(t)&&isFunction(t.read)&&isFunction(t.pipe)&&isBoolean(t.readable),isReadableStream=t=>isReadableDOMStream(t)||isReadableNodeStream(t);class FetchError extends Error{constructor(e,n){super(e),this.reason=n.reason,this.url=n.url,this.response=n.response}reason;url;response}const DATA_URL_PATTERN=/^data:([-\w.]+\/[-\w.+]+)(;|,)/,MIME_TYPE_PATTERN=/^([-\w.]+\/[-\w.+]+)/;function compareMIMETypes(t,e){return t.toLowerCase()===e.toLowerCase()}function parseMIMEType(t){const e=MIME_TYPE_PATTERN.exec(t);return e?e[1]:t}function parseMIMETypeFromURL(t){const e=DATA_URL_PATTERN.exec(t);return e?e[1]:""}const QUERY_STRING_PATTERN=/\?.*/;function extractQueryString(t){const e=t.match(QUERY_STRING_PATTERN);return e&&e[0]}function stripQueryString(t){return t.replace(QUERY_STRING_PATTERN,"")}function shortenUrlForDisplay(t){if(t.length<50)return t;const e=t.slice(t.length-15);return`${t.substr(0,32)}...${e}`}function getResourceUrl(t){return isResponse(t)?t.url:isBlob(t)?t.name||"":typeof t=="string"?t:""}function getResourceMIMEType(t){if(isResponse(t)){const e=t,n=e.headers.get("content-type")||"",r=stripQueryString(e.url);return parseMIMEType(n)||parseMIMETypeFromURL(r)}return isBlob(t)?t.type||"":typeof t=="string"?parseMIMETypeFromURL(t):""}function getResourceContentLength(t){return isResponse(t)?t.headers["content-length"]||-1:isBlob(t)?t.size:typeof t=="string"?t.length:t instanceof ArrayBuffer||ArrayBuffer.isView(t)?t.byteLength:-1}async function makeResponse(t){if(isResponse(t))return t;const e={},n=getResourceContentLength(t);n>=0&&(e["content-length"]=String(n));const r=getResourceUrl(t),i=getResourceMIMEType(t);i&&(e["content-type"]=i);const o=await getInitialDataUrl(t);o&&(e["x-first-bytes"]=o),typeof t=="string"&&(t=new TextEncoder().encode(t));const a=new Response(t,{headers:e});return Object.defineProperty(a,"url",{value:r}),a}async function checkResponse(t){if(!t.ok)throw await getResponseError(t)}async function getResponseError(t){const e=shortenUrlForDisplay(t.url);let n=`Failed to fetch resource (${t.status}) ${t.statusText}: ${e}`;n=n.length>100?`${n.slice(0,100)}...`:n;const r={reason:t.statusText,url:t.url,response:t};try{const i=t.headers.get("Content-Type");r.reason=!t.bodyUsed&&i?.includes("application/json")?await t.json():await t.text()}catch{}return new FetchError(n,r)}async function getInitialDataUrl(t){if(typeof t=="string")return`data:,${t.slice(0,5)}`;if(t instanceof Blob){const n=t.slice(0,5);return await new Promise(r=>{const i=new FileReader;i.onload=o=>r(o?.target?.result),i.readAsDataURL(n)})}if(t instanceof ArrayBuffer){const n=t.slice(0,5);return`data:base64,${arrayBufferToBase64(n)}`}return null}function arrayBufferToBase64(t){let e="";const n=new Uint8Array(t);for(let r=0;r<n.byteLength;r++)e+=String.fromCharCode(n[r]);return btoa(e)}function isNodePath(t){return!isRequestURL(t)&&!isDataURL(t)}function isRequestURL(t){return t.startsWith("http:")||t.startsWith("https:")}function isDataURL(t){return t.startsWith("data:")}async function fetchFile(t,e){if(typeof t=="string"){const n=resolvePath(t);return isNodePath(n)&&globalThis.loaders?.fetchNode?globalThis.loaders?.fetchNode(n,e):await fetch(n,e)}return await makeResponse(t)}const probeLog=new Log({id:"loaders.gl"});class NullLog{log(){return()=>{}}info(){return()=>{}}warn(){return()=>{}}error(){return()=>{}}}class ConsoleLog{console;constructor(){this.console=console}log(...e){return this.console.log.bind(this.console,...e)}info(...e){return this.console.info.bind(this.console,...e)}warn(...e){return this.console.warn.bind(this.console,...e)}error(...e){return this.console.error.bind(this.console,...e)}}const DEFAULT_LOADER_OPTIONS={fetch:null,mimeType:void 0,nothrow:!1,log:new ConsoleLog,useLocalLibraries:!1,CDN:"https://unpkg.com/@loaders.gl",worker:!0,maxConcurrency:3,maxMobileConcurrency:1,reuseWorkers:isBrowser$2,_nodeWorkers:!1,_workerType:"",limit:0,_limitMB:0,batchSize:"auto",batchDebounceMs:0,metadata:!1,transforms:[]},REMOVED_LOADER_OPTIONS={throws:"nothrow",dataType:"(no longer used)",uri:"baseUri",method:"fetch.method",headers:"fetch.headers",body:"fetch.body",mode:"fetch.mode",credentials:"fetch.credentials",cache:"fetch.cache",redirect:"fetch.redirect",referrer:"fetch.referrer",referrerPolicy:"fetch.referrerPolicy",integrity:"fetch.integrity",keepalive:"fetch.keepalive",signal:"fetch.signal"};function getGlobalLoaderState(){globalThis.loaders=globalThis.loaders||{};const{loaders:t}=globalThis;return t._state||(t._state={}),t._state}function getGlobalLoaderOptions(){const t=getGlobalLoaderState();return t.globalOptions=t.globalOptions||{...DEFAULT_LOADER_OPTIONS},t.globalOptions}function normalizeOptions(t,e,n,r){return n=n||[],n=Array.isArray(n)?n:[n],validateOptions(t,n),normalizeOptionsInternal(e,t,r)}function validateOptions(t,e){validateOptionsObject(t,null,DEFAULT_LOADER_OPTIONS,REMOVED_LOADER_OPTIONS,e);for(const n of e){const r=t&&t[n.id]||{},i=n.options&&n.options[n.id]||{},o=n.deprecatedOptions&&n.deprecatedOptions[n.id]||{};validateOptionsObject(r,n.id,i,o,e)}}function validateOptionsObject(t,e,n,r,i){const o=e||"Top level",a=e?`${e}.`:"";for(const l in t){const A=!e&&isObject(t[l]),E=l==="baseUri"&&!e,v=l==="workerUrl"&&e;if(!(l in n)&&!E&&!v){if(l in r)probeLog.warn(`${o} loader option '${a}${l}' no longer supported, use '${r[l]}'`)();else if(!A){const x=findSimilarOption(l,i);probeLog.warn(`${o} loader option '${a}${l}' not recognized. ${x}`)()}}}}function findSimilarOption(t,e){const n=t.toLowerCase();let r="";for(const i of e)for(const o in i.options){if(t===o)return`Did you mean '${i.id}.${o}'?`;const a=o.toLowerCase();(n.startsWith(a)||a.startsWith(n))&&(r=r||`Did you mean '${i.id}.${o}'?`)}return r}function normalizeOptionsInternal(t,e,n){const i={...t.options||{}};return addUrlOptions(i,n),i.log===null&&(i.log=new NullLog),mergeNestedFields(i,getGlobalLoaderOptions()),mergeNestedFields(i,e),i}function mergeNestedFields(t,e){for(const n in e)if(n in e){const r=e[n];isPureObject(r)&&isPureObject(t[n])?t[n]={...t[n],...e[n]}:t[n]=e[n]}}function addUrlOptions(t,e){e&&!("baseUri"in t)&&(t.baseUri=e)}function isLoaderObject(t){return t?(Array.isArray(t)&&(t=t[0]),Array.isArray(t?.extensions)):!1}function normalizeLoader(t){assert$4(t,"null loader"),assert$4(isLoaderObject(t),"invalid loader");let e;return Array.isArray(t)&&(e=t[1],t=t[0],t={...t,options:{...t.options,...e}}),(t?.parseTextSync||t?.parseText)&&(t.text=!0),t.text||(t.binary=!0),t}const getGlobalLoaderRegistry=()=>{const t=getGlobalLoaderState();return t.loaderRegistry=t.loaderRegistry||[],t.loaderRegistry};function registerLoaders(t){const e=getGlobalLoaderRegistry();t=Array.isArray(t)?t:[t];for(const n of t){const r=normalizeLoader(n);e.find(i=>r===i)||e.unshift(r)}}function getRegisteredLoaders(){return getGlobalLoaderRegistry()}const EXT_PATTERN=/\.([^.]+)$/;async function selectLoader(t,e=[],n,r){if(!validHTTPResponse(t))return null;let i=selectLoaderSync(t,e,{...n,nothrow:!0},r);if(i)return i;if(isBlob(t)&&(t=await t.slice(0,10).arrayBuffer(),i=selectLoaderSync(t,e,n,r)),!i&&!n?.nothrow)throw new Error(getNoValidLoaderMessage(t));return i}function selectLoaderSync(t,e=[],n,r){if(!validHTTPResponse(t))return null;if(e&&!Array.isArray(e))return normalizeLoader(e);let i=[];e&&(i=i.concat(e)),n?.ignoreRegisteredLoaders||i.push(...getRegisteredLoaders()),normalizeLoaders(i);const o=selectLoaderInternal(t,i,n,r);if(!o&&!n?.nothrow)throw new Error(getNoValidLoaderMessage(t));return o}function selectLoaderInternal(t,e,n,r){const i=getResourceUrl(t),o=getResourceMIMEType(t),a=stripQueryString(i)||r?.url;let l=null,A="";return n?.mimeType&&(l=findLoaderByMIMEType(e,n?.mimeType),A=`match forced by supplied MIME type ${n?.mimeType}`),l=l||findLoaderByUrl(e,a),A=A||(l?`matched url ${a}`:""),l=l||findLoaderByMIMEType(e,o),A=A||(l?`matched MIME type ${o}`:""),l=l||findLoaderByInitialBytes(e,t),A=A||(l?`matched initial data ${getFirstCharacters(t)}`:""),n?.fallbackMimeType&&(l=l||findLoaderByMIMEType(e,n?.fallbackMimeType),A=A||(l?`matched fallback MIME type ${o}`:"")),A&&log.log(1,`selectLoader selected ${l?.name}: ${A}.`),l}function validHTTPResponse(t){return!(t instanceof Response&&t.status===204)}function getNoValidLoaderMessage(t){const e=getResourceUrl(t),n=getResourceMIMEType(t);let r="No valid loader found (";r+=e?`${filename(e)}, `:"no url provided, ",r+=`MIME type: ${n?`"${n}"`:"not provided"}, `;const i=t?getFirstCharacters(t):"";return r+=i?` first bytes: "${i}"`:"first bytes: not available",r+=")",r}function normalizeLoaders(t){for(const e of t)normalizeLoader(e)}function findLoaderByUrl(t,e){const n=e&&EXT_PATTERN.exec(e),r=n&&n[1];return r?findLoaderByExtension(t,r):null}function findLoaderByExtension(t,e){e=e.toLowerCase();for(const n of t)for(const r of n.extensions)if(r.toLowerCase()===e)return n;return null}function findLoaderByMIMEType(t,e){for(const n of t)if(n.mimeTypes?.some(r=>compareMIMETypes(e,r))||compareMIMETypes(e,`application/x.${n.id}`))return n;return null}function findLoaderByInitialBytes(t,e){if(!e)return null;for(const n of t)if(typeof e=="string"){if(testDataAgainstText(e,n))return n}else if(ArrayBuffer.isView(e)){if(testDataAgainstBinary(e.buffer,e.byteOffset,n))return n}else if(e instanceof ArrayBuffer&&testDataAgainstBinary(e,0,n))return n;return null}function testDataAgainstText(t,e){return e.testText?e.testText(t):(Array.isArray(e.tests)?e.tests:[e.tests]).some(r=>t.startsWith(r))}function testDataAgainstBinary(t,e,n){return(Array.isArray(n.tests)?n.tests:[n.tests]).some(i=>testBinary(t,e,n,i))}function testBinary(t,e,n,r){if(r instanceof ArrayBuffer)return compareArrayBuffers(r,t,r.byteLength);switch(typeof r){case"function":return r(t);case"string":const i=getMagicString$1(t,e,r.length);return r===i;default:return!1}}function getFirstCharacters(t,e=5){return typeof t=="string"?t.slice(0,e):ArrayBuffer.isView(t)?getMagicString$1(t.buffer,t.byteOffset,e):t instanceof ArrayBuffer?getMagicString$1(t,0,e):""}function getMagicString$1(t,e,n){if(t.byteLength<e+n)return"";const r=new DataView(t);let i="";for(let o=0;o<n;o++)i+=String.fromCharCode(r.getUint8(e+o));return i}const DEFAULT_CHUNK_SIZE$2=256*1024;function*makeStringIterator(t,e){const n=e?.chunkSize||DEFAULT_CHUNK_SIZE$2;let r=0;const i=new TextEncoder;for(;r<t.length;){const o=Math.min(t.length-r,n),a=t.slice(r,r+o);r+=o,yield i.encode(a)}}const DEFAULT_CHUNK_SIZE$1=256*1024;function*makeArrayBufferIterator(t,e={}){const{chunkSize:n=DEFAULT_CHUNK_SIZE$1}=e;let r=0;for(;r<t.byteLength;){const i=Math.min(t.byteLength-r,n),o=new ArrayBuffer(i),a=new Uint8Array(t,r,i);new Uint8Array(o).set(a),r+=i,yield o}}const DEFAULT_CHUNK_SIZE=1024*1024;async function*makeBlobIterator(t,e){const n=e?.chunkSize||DEFAULT_CHUNK_SIZE;let r=0;for(;r<t.size;){const i=r+n,o=await t.slice(r,i).arrayBuffer();r=i,yield o}}function makeStreamIterator(t,e){return isBrowser$2?makeBrowserStreamIterator(t,e):makeNodeStreamIterator(t)}async function*makeBrowserStreamIterator(t,e){const n=t.getReader();let r;try{for(;;){const i=r||n.read();e?._streamReadAhead&&(r=n.read());const{done:o,value:a}=await i;if(o)return;yield toArrayBuffer(a)}}catch{n.releaseLock()}}async function*makeNodeStreamIterator(t,e){for await(const n of t)yield toArrayBuffer(n)}function makeIterator(t,e){if(typeof t=="string")return makeStringIterator(t,e);if(t instanceof ArrayBuffer)return makeArrayBufferIterator(t,e);if(isBlob(t))return makeBlobIterator(t,e);if(isReadableStream(t))return makeStreamIterator(t,e);if(isResponse(t))return makeStreamIterator(t.body,e);throw new Error("makeIterator")}const ERR_DATA="Cannot convert supplied data type";function getArrayBufferOrStringFromDataSync(t,e,n){if(e.text&&typeof t=="string")return t;if(isBuffer(t)&&(t=t.buffer),t instanceof ArrayBuffer){const r=t;return e.text&&!e.binary?new TextDecoder("utf8").decode(r):r}if(ArrayBuffer.isView(t)){if(e.text&&!e.binary)return new TextDecoder("utf8").decode(t);let r=t.buffer;const i=t.byteLength||t.length;return(t.byteOffset!==0||i!==r.byteLength)&&(r=r.slice(t.byteOffset,t.byteOffset+i)),r}throw new Error(ERR_DATA)}async function getArrayBufferOrStringFromData(t,e,n){const r=t instanceof ArrayBuffer||ArrayBuffer.isView(t);if(typeof t=="string"||r)return getArrayBufferOrStringFromDataSync(t,e);if(isBlob(t)&&(t=await makeResponse(t)),isResponse(t)){const i=t;return await checkResponse(i),e.binary?await i.arrayBuffer():await i.text()}if(isReadableStream(t)&&(t=makeIterator(t,n)),isIterable(t)||isAsyncIterable(t))return concatenateArrayBuffersAsync(t);throw new Error(ERR_DATA)}function getFetchFunction(t,e){const n=getGlobalLoaderOptions(),r=t||n;return typeof r.fetch=="function"?r.fetch:isObject(r.fetch)?i=>fetchFile(i,r.fetch):e?.fetch?e?.fetch:fetchFile}function getLoaderContext(t,e,n){if(n)return n;const r={fetch:getFetchFunction(e,t),...t};if(r.url){const i=stripQueryString(r.url);r.baseUrl=i,r.queryString=extractQueryString(r.url),r.filename=filename(i),r.baseUrl=dirname(i)}return Array.isArray(r.loaders)||(r.loaders=null),r}function getLoadersFromContext(t,e){if(t&&!Array.isArray(t))return t;let n;if(t&&(n=Array.isArray(t)?t:[t]),e&&e.loaders){const r=Array.isArray(e.loaders)?e.loaders:[e.loaders];n=n?[...n,...r]:r}return n&&n.length?n:void 0}async function parse$2(t,e,n,r){e&&!Array.isArray(e)&&!isLoaderObject(e)&&(r=void 0,n=e,e=void 0),t=await t,n=n||{};const i=getResourceUrl(t),a=getLoadersFromContext(e,r),l=await selectLoader(t,a,n);return l?(n=normalizeOptions(n,l,a,i),r=getLoaderContext({url:i,_parse:parse$2,loaders:a},n,r||null),await parseWithLoader(l,t,n,r)):null}async function parseWithLoader(t,e,n,r){if(validateWorkerVersion(t),n=mergeLoaderOptions(t.options,n),isResponse(e)){const o=e,{ok:a,redirected:l,status:A,statusText:E,type:v,url:x}=o,R=Object.fromEntries(o.headers.entries());r.response={headers:R,ok:a,redirected:l,status:A,statusText:E,type:v,url:x}}e=await getArrayBufferOrStringFromData(e,t,n);const i=t;if(i.parseTextSync&&typeof e=="string")return i.parseTextSync(e,n,r);if(canParseWithWorker(t,n))return await parseWithWorker(t,e,n,r,parse$2);if(i.parseText&&typeof e=="string")return await i.parseText(e,n,r);if(i.parse)return await i.parse(e,n,r);throw assert$2(!i.parseSync),new Error(`${t.id} loader - no parser found and worker is disabled`)}function getDataTypeFromTypedArray(t){switch(t.constructor){case Int8Array:return"int8";case Uint8Array:case Uint8ClampedArray:return"uint8";case Int16Array:return"int16";case Uint16Array:return"uint16";case Int32Array:return"int32";case Uint32Array:return"uint32";case Float32Array:return"float32";case Float64Array:return"float64";default:return"null"}}function getMeshBoundingBox(t){let e=1/0,n=1/0,r=1/0,i=-1/0,o=-1/0,a=-1/0;const l=t.POSITION?t.POSITION.value:[],A=l&&l.length;for(let E=0;E<A;E+=3){const v=l[E],x=l[E+1],R=l[E+2];e=v<e?v:e,n=x<n?x:n,r=R<r?R:r,i=v>i?v:i,o=x>o?x:o,a=R>a?R:a}return[[e,n,r],[i,o,a]]}function deduceMeshField(t,e,n){const r=getDataTypeFromTypedArray(e.value),i=n||makeMeshAttributeMetadata(e);return{name:t,type:{type:"fixed-size-list",listSize:e.size,children:[{name:"value",type:r}]},nullable:!1,metadata:i}}function makeMeshAttributeMetadata(t){const e={};return"byteOffset"in t&&(e.byteOffset=t.byteOffset.toString(10)),"byteStride"in t&&(e.byteStride=t.byteStride.toString(10)),"normalized"in t&&(e.normalized=t.normalized.toString()),e}async function load(t,e,n,r){let i,o;!Array.isArray(e)&&!isLoaderObject(e)?(i=[],o=e):(i=e,o=n);const a=getFetchFunction(o);let l=t;return typeof t=="string"&&(l=await a(t)),isBlob(t)&&(l=await a(t)),Array.isArray(i)?await parse$2(l,i,o):await parse$2(l,i,o)}const VERSION$3="4.3.3",parseImageNode=globalThis.loaders?.parseImageNode,IMAGE_SUPPORTED=typeof Image<"u",IMAGE_BITMAP_SUPPORTED=typeof ImageBitmap<"u",NODE_IMAGE_SUPPORTED=!!parseImageNode,DATA_SUPPORTED=isBrowser$2?!0:NODE_IMAGE_SUPPORTED;function isImageTypeSupported(t){switch(t){case"auto":return IMAGE_BITMAP_SUPPORTED||IMAGE_SUPPORTED||DATA_SUPPORTED;case"imagebitmap":return IMAGE_BITMAP_SUPPORTED;case"image":return IMAGE_SUPPORTED;case"data":return DATA_SUPPORTED;default:throw new Error(`@loaders.gl/images: image ${t} not supported in this environment`)}}function getDefaultImageType(){if(IMAGE_BITMAP_SUPPORTED)return"imagebitmap";if(IMAGE_SUPPORTED)return"image";if(DATA_SUPPORTED)return"data";throw new Error("Install '@loaders.gl/polyfills' to parse images under Node.js")}function getImageType(t){const e=getImageTypeOrNull(t);if(!e)throw new Error("Not an image");return e}function getImageData(t){switch(getImageType(t)){case"data":return t;case"image":case"imagebitmap":const e=document.createElement("canvas"),n=e.getContext("2d");if(!n)throw new Error("getImageData");return e.width=t.width,e.height=t.height,n.drawImage(t,0,0),n.getImageData(0,0,t.width,t.height);default:throw new Error("getImageData")}}function getImageTypeOrNull(t){return typeof ImageBitmap<"u"&&t instanceof ImageBitmap?"imagebitmap":typeof Image<"u"&&t instanceof Image?"image":t&&typeof t=="object"&&t.data&&t.width&&t.height?"data":null}const SVG_DATA_URL_PATTERN=/^data:image\/svg\+xml/,SVG_URL_PATTERN=/\.svg((\?|#).*)?$/;function isSVG(t){return t&&(SVG_DATA_URL_PATTERN.test(t)||SVG_URL_PATTERN.test(t))}function getBlobOrSVGDataUrl(t,e){if(isSVG(e)){let r=new TextDecoder().decode(t);try{typeof unescape=="function"&&typeof encodeURIComponent=="function"&&(r=unescape(encodeURIComponent(r)))}catch(o){throw new Error(o.message)}return`data:image/svg+xml;base64,${btoa(r)}`}return getBlob(t,e)}function getBlob(t,e){if(isSVG(e))throw new Error("SVG cannot be parsed directly to imagebitmap");return new Blob([new Uint8Array(t)])}async function parseToImage(t,e,n){const r=getBlobOrSVGDataUrl(t,n),i=self.URL||self.webkitURL,o=typeof r!="string"&&i.createObjectURL(r);try{return await loadToImage(o||r,e)}finally{o&&i.revokeObjectURL(o)}}async function loadToImage(t,e){const n=new Image;return n.src=t,e.image&&e.image.decode&&n.decode?(await n.decode(),n):await new Promise((r,i)=>{try{n.onload=()=>r(n),n.onerror=o=>{const a=o instanceof Error?o.message:"error";i(new Error(a))}}catch(o){i(o)}})}const EMPTY_OBJECT={};let imagebitmapOptionsSupported=!0;async function parseToImageBitmap(t,e,n){let r;isSVG(n)?r=await parseToImage(t,e,n):r=getBlob(t,n);const i=e&&e.imagebitmap;return await safeCreateImageBitmap(r,i)}async function safeCreateImageBitmap(t,e=null){if((isEmptyObject(e)||!imagebitmapOptionsSupported)&&(e=null),e)try{return await createImageBitmap(t,e)}catch(n){console.warn(n),imagebitmapOptionsSupported=!1}return await createImageBitmap(t)}function isEmptyObject(t){for(const e in t||EMPTY_OBJECT)return!1;return!0}function getISOBMFFMediaType(t){return!checkString(t,"ftyp",4)||(t[8]&96)===0?null:decodeMajorBrand(t)}function decodeMajorBrand(t){switch(getUTF8String(t,8,12).replace("\0"," ").trim()){case"avif":case"avis":return{extension:"avif",mimeType:"image/avif"};default:return null}}function getUTF8String(t,e,n){return String.fromCharCode(...t.slice(e,n))}function stringToBytes(t){return[...t].map(e=>e.charCodeAt(0))}function checkString(t,e,n=0){const r=stringToBytes(e);for(let i=0;i<r.length;++i)if(r[i]!==t[i+n])return!1;return!0}const BIG_ENDIAN=!1,LITTLE_ENDIAN$1=!0;function getBinaryImageMetadata(t){const e=toDataView(t);return getPngMetadata(e)||getJpegMetadata(e)||getGifMetadata(e)||getBmpMetadata(e)||getISOBMFFMetadata(e)}function getISOBMFFMetadata(t){const e=new Uint8Array(t instanceof DataView?t.buffer:t),n=getISOBMFFMediaType(e);return n?{mimeType:n.mimeType,width:0,height:0}:null}function getPngMetadata(t){const e=toDataView(t);return e.byteLength>=24&&e.getUint32(0,BIG_ENDIAN)===2303741511?{mimeType:"image/png",width:e.getUint32(16,BIG_ENDIAN),height:e.getUint32(20,BIG_ENDIAN)}:null}function getGifMetadata(t){const e=toDataView(t);return e.byteLength>=10&&e.getUint32(0,BIG_ENDIAN)===1195984440?{mimeType:"image/gif",width:e.getUint16(6,LITTLE_ENDIAN$1),height:e.getUint16(8,LITTLE_ENDIAN$1)}:null}function getBmpMetadata(t){const e=toDataView(t);return e.byteLength>=14&&e.getUint16(0,BIG_ENDIAN)===16973&&e.getUint32(2,LITTLE_ENDIAN$1)===e.byteLength?{mimeType:"image/bmp",width:e.getUint32(18,LITTLE_ENDIAN$1),height:e.getUint32(22,LITTLE_ENDIAN$1)}:null}function getJpegMetadata(t){const e=toDataView(t);if(!(e.byteLength>=3&&e.getUint16(0,BIG_ENDIAN)===65496&&e.getUint8(2)===255))return null;const{tableMarkers:r,sofMarkers:i}=getJpegMarkers();let o=2;for(;o+9<e.byteLength;){const a=e.getUint16(o,BIG_ENDIAN);if(i.has(a))return{mimeType:"image/jpeg",height:e.getUint16(o+5,BIG_ENDIAN),width:e.getUint16(o+7,BIG_ENDIAN)};if(!r.has(a))return null;o+=2,o+=e.getUint16(o,BIG_ENDIAN)}return null}function getJpegMarkers(){const t=new Set([65499,65476,65484,65501,65534]);for(let n=65504;n<65520;++n)t.add(n);return{tableMarkers:t,sofMarkers:new Set([65472,65473,65474,65475,65477,65478,65479,65481,65482,65483,65485,65486,65487,65502])}}function toDataView(t){if(t instanceof DataView)return t;if(ArrayBuffer.isView(t))return new DataView(t.buffer);if(t instanceof ArrayBuffer)return new DataView(t);throw new Error("toDataView")}async function parseToNodeImage(t,e){const{mimeType:n}=getBinaryImageMetadata(t)||{},r=globalThis.loaders?.parseImageNode;return assert$4(r),await r(t,n)}async function parseImage(t,e,n){e=e||{};const i=(e.image||{}).type||"auto",{url:o}=n||{},a=getLoadableImageType(i);let l;switch(a){case"imagebitmap":l=await parseToImageBitmap(t,e,o);break;case"image":l=await parseToImage(t,e,o);break;case"data":l=await parseToNodeImage(t);break;default:assert$4(!1)}return i==="data"&&(l=getImageData(l)),l}function getLoadableImageType(t){switch(t){case"auto":case"data":return getDefaultImageType();default:return isImageTypeSupported(t),t}}const EXTENSIONS$1=["png","jpg","jpeg","gif","webp","bmp","ico","svg","avif"],MIME_TYPES=["image/png","image/jpeg","image/gif","image/webp","image/avif","image/bmp","image/vnd.microsoft.icon","image/svg+xml"],DEFAULT_IMAGE_LOADER_OPTIONS={image:{type:"auto",decode:!0}},ImageLoader={dataType:null,batchType:null,id:"image",module:"images",name:"Images",version:VERSION$3,mimeTypes:MIME_TYPES,extensions:EXTENSIONS$1,parse:parseImage,tests:[t=>!!getBinaryImageMetadata(new DataView(t))],options:DEFAULT_IMAGE_LOADER_OPTIONS},mimeTypeSupportedSync={};function isImageFormatSupported(t){if(mimeTypeSupportedSync[t]===void 0){const e=isBrowser$2?checkBrowserImageFormatSupport(t):checkNodeImageFormatSupport(t);mimeTypeSupportedSync[t]=e}return mimeTypeSupportedSync[t]}function checkNodeImageFormatSupport(t){const e=["image/png","image/jpeg","image/gif"],n=globalThis.loaders?.imageFormatsNode||e;return!!globalThis.loaders?.parseImageNode&&n.includes(t)}function checkBrowserImageFormatSupport(t){switch(t){case"image/avif":case"image/webp":return testBrowserImageFormatSupport(t);default:return!0}}function testBrowserImageFormatSupport(t){try{return document.createElement("canvas").toDataURL(t).indexOf(`data:${t}`)===0}catch{return!1}}function assert$1(t,e){if(!t)throw new Error(e||"assert failed: gltf")}const COMPONENTS={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},BYTES={5120:1,5121:1,5122:2,5123:2,5125:4,5126:4},TYPES=["SCALAR","VEC2","VEC3","VEC4"],ARRAY_CONSTRUCTOR_TO_WEBGL_CONSTANT=[[Int8Array,5120],[Uint8Array,5121],[Int16Array,5122],[Uint16Array,5123],[Uint32Array,5125],[Float32Array,5126],[Float64Array,5130]],ARRAY_TO_COMPONENT_TYPE=new Map(ARRAY_CONSTRUCTOR_TO_WEBGL_CONSTANT),ATTRIBUTE_TYPE_TO_COMPONENTS$1={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},ATTRIBUTE_COMPONENT_TYPE_TO_BYTE_SIZE$1={5120:1,5121:1,5122:2,5123:2,5125:4,5126:4},ATTRIBUTE_COMPONENT_TYPE_TO_ARRAY$1={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array};function getAccessorTypeFromSize(t){return TYPES[t-1]||TYPES[0]}function getComponentTypeFromArray(t){const e=ARRAY_TO_COMPONENT_TYPE.get(t.constructor);if(!e)throw new Error("Illegal typed array");return e}function getAccessorArrayTypeAndLength(t,e){const n=ATTRIBUTE_COMPONENT_TYPE_TO_ARRAY$1[t.componentType],r=ATTRIBUTE_TYPE_TO_COMPONENTS$1[t.type],i=ATTRIBUTE_COMPONENT_TYPE_TO_BYTE_SIZE$1[t.componentType],o=t.count*r,a=t.count*r*i;assert$1(a>=0&&a<=e.byteLength);const l=BYTES[t.componentType],A=COMPONENTS[t.type];return{ArrayType:n,length:o,byteLength:a,componentByteSize:l,numberOfComponentsInElement:A}}function getTypedArrayForBufferView(t,e,n){const r=t.bufferViews[n];assert$1(r);const i=r.buffer,o=e[i];assert$1(o);const a=(r.byteOffset||0)+o.byteOffset;return new Uint8Array(o.arrayBuffer,a,r.byteLength)}function getTypedArrayForAccessor(t,e,n){const r=typeof n=="number"?t.accessors?.[n]:n;if(!r)throw new Error(`No gltf accessor ${JSON.stringify(n)}`);const i=t.bufferViews?.[r.bufferView||0];if(!i)throw new Error(`No gltf buffer view for accessor ${i}`);const{arrayBuffer:o,byteOffset:a}=e[i.buffer],l=(a||0)+(r.byteOffset||0)+(i.byteOffset||0),{ArrayType:A,length:E,componentByteSize:v,numberOfComponentsInElement:x}=getAccessorArrayTypeAndLength(r,i),R=v*x,D=i.byteStride||R;if(typeof i.byteStride>"u"||i.byteStride===R)return new A(o,l,E);const O=new A(E);for(let U=0;U<r.count;U++){const H=new A(o,l+U*D,x);O.set(H,U*x)}return O}function makeDefaultGLTFJson(){return{asset:{version:"2.0",generator:"loaders.gl"},buffers:[],extensions:{},extensionsRequired:[],extensionsUsed:[]}}class GLTFScenegraph{gltf;sourceBuffers;byteLength;constructor(e){this.gltf={json:e?.json||makeDefaultGLTFJson(),buffers:e?.buffers||[],images:e?.images||[]},this.sourceBuffers=[],this.byteLength=0,this.gltf.buffers&&this.gltf.buffers[0]&&(this.byteLength=this.gltf.buffers[0].byteLength,this.sourceBuffers=[this.gltf.buffers[0]])}get json(){return this.gltf.json}getApplicationData(e){return this.json[e]}getExtraData(e){return(this.json.extras||{})[e]}hasExtension(e){const n=this.getUsedExtensions().find(i=>i===e),r=this.getRequiredExtensions().find(i=>i===e);return typeof n=="string"||typeof r=="string"}getExtension(e){const n=this.getUsedExtensions().find(i=>i===e),r=this.json.extensions||{};return n?r[e]:null}getRequiredExtension(e){return this.getRequiredExtensions().find(r=>r===e)?this.getExtension(e):null}getRequiredExtensions(){return this.json.extensionsRequired||[]}getUsedExtensions(){return this.json.extensionsUsed||[]}getRemovedExtensions(){return this.json.extensionsRemoved||[]}getObjectExtension(e,n){return(e.extensions||{})[n]}getScene(e){return this.getObject("scenes",e)}getNode(e){return this.getObject("nodes",e)}getSkin(e){return this.getObject("skins",e)}getMesh(e){return this.getObject("meshes",e)}getMaterial(e){return this.getObject("materials",e)}getAccessor(e){return this.getObject("accessors",e)}getTexture(e){return this.getObject("textures",e)}getSampler(e){return this.getObject("samplers",e)}getImage(e){return this.getObject("images",e)}getBufferView(e){return this.getObject("bufferViews",e)}getBuffer(e){return this.getObject("buffers",e)}getObject(e,n){if(typeof n=="object")return n;const r=this.json[e]&&this.json[e][n];if(!r)throw new Error(`glTF file error: Could not find ${e}[${n}]`);return r}getTypedArrayForBufferView(e){e=this.getBufferView(e);const n=e.buffer,r=this.gltf.buffers[n];assert$1(r);const i=(e.byteOffset||0)+r.byteOffset;return new Uint8Array(r.arrayBuffer,i,e.byteLength)}getTypedArrayForAccessor(e){const n=this.getAccessor(e);return getTypedArrayForAccessor(this.gltf.json,this.gltf.buffers,n)}getTypedArrayForImageData(e){e=this.getAccessor(e);const n=this.getBufferView(e.bufferView),i=this.getBuffer(n.buffer).data,o=n.byteOffset||0;return new Uint8Array(i,o,n.byteLength)}addApplicationData(e,n){return this.json[e]=n,this}addExtraData(e,n){return this.json.extras=this.json.extras||{},this.json.extras[e]=n,this}addObjectExtension(e,n,r){return e.extensions=e.extensions||{},e.extensions[n]=r,this.registerUsedExtension(n),this}setObjectExtension(e,n,r){const i=e.extensions||{};i[n]=r}removeObjectExtension(e,n){const r=e?.extensions||{};if(r[n]){this.json.extensionsRemoved=this.json.extensionsRemoved||[];const i=this.json.extensionsRemoved;i.includes(n)||i.push(n)}delete r[n]}addExtension(e,n={}){return assert$1(n),this.json.extensions=this.json.extensions||{},this.json.extensions[e]=n,this.registerUsedExtension(e),n}addRequiredExtension(e,n={}){return assert$1(n),this.addExtension(e,n),this.registerRequiredExtension(e),n}registerUsedExtension(e){this.json.extensionsUsed=this.json.extensionsUsed||[],this.json.extensionsUsed.find(n=>n===e)||this.json.extensionsUsed.push(e)}registerRequiredExtension(e){this.registerUsedExtension(e),this.json.extensionsRequired=this.json.extensionsRequired||[],this.json.extensionsRequired.find(n=>n===e)||this.json.extensionsRequired.push(e)}removeExtension(e){if(this.json.extensions?.[e]){this.json.extensionsRemoved=this.json.extensionsRemoved||[];const n=this.json.extensionsRemoved;n.includes(e)||n.push(e)}this.json.extensions&&delete this.json.extensions[e],this.json.extensionsRequired&&this._removeStringFromArray(this.json.extensionsRequired,e),this.json.extensionsUsed&&this._removeStringFromArray(this.json.extensionsUsed,e)}setDefaultScene(e){this.json.scene=e}addScene(e){const{nodeIndices:n}=e;return this.json.scenes=this.json.scenes||[],this.json.scenes.push({nodes:n}),this.json.scenes.length-1}addNode(e){const{meshIndex:n,matrix:r}=e;this.json.nodes=this.json.nodes||[];const i={mesh:n};return r&&(i.matrix=r),this.json.nodes.push(i),this.json.nodes.length-1}addMesh(e){const{attributes:n,indices:r,material:i,mode:o=4}=e,l={primitives:[{attributes:this._addAttributes(n),mode:o}]};if(r){const A=this._addIndices(r);l.primitives[0].indices=A}return Number.isFinite(i)&&(l.primitives[0].material=i),this.json.meshes=this.json.meshes||[],this.json.meshes.push(l),this.json.meshes.length-1}addPointCloud(e){const r={primitives:[{attributes:this._addAttributes(e),mode:0}]};return this.json.meshes=this.json.meshes||[],this.json.meshes.push(r),this.json.meshes.length-1}addImage(e,n){const r=getBinaryImageMetadata(e),i=n||r?.mimeType,a={bufferView:this.addBufferView(e),mimeType:i};return this.json.images=this.json.images||[],this.json.images.push(a),this.json.images.length-1}addBufferView(e,n=0,r=this.byteLength){const i=e.byteLength;assert$1(Number.isFinite(i)),this.sourceBuffers=this.sourceBuffers||[],this.sourceBuffers.push(e);const o={buffer:n,byteOffset:r,byteLength:i};return this.byteLength+=padToNBytes(i,4),this.json.bufferViews=this.json.bufferViews||[],this.json.bufferViews.push(o),this.json.bufferViews.length-1}addAccessor(e,n){const r={bufferView:e,type:getAccessorTypeFromSize(n.size),componentType:n.componentType,count:n.count,max:n.max,min:n.min};return this.json.accessors=this.json.accessors||[],this.json.accessors.push(r),this.json.accessors.length-1}addBinaryBuffer(e,n={size:3}){const r=this.addBufferView(e);let i={min:n.min,max:n.max};(!i.min||!i.max)&&(i=this._getAccessorMinMax(e,n.size));const o={size:n.size,componentType:getComponentTypeFromArray(e),count:Math.round(e.length/n.size),min:i.min,max:i.max};return this.addAccessor(r,Object.assign(o,n))}addTexture(e){const{imageIndex:n}=e,r={source:n};return this.json.textures=this.json.textures||[],this.json.textures.push(r),this.json.textures.length-1}addMaterial(e){return this.json.materials=this.json.materials||[],this.json.materials.push(e),this.json.materials.length-1}createBinaryChunk(){const e=this.byteLength,n=new ArrayBuffer(e),r=new Uint8Array(n);let i=0;for(const o of this.sourceBuffers||[])i=copyToArray(o,r,i);this.json?.buffers?.[0]?this.json.buffers[0].byteLength=e:this.json.buffers=[{byteLength:e}],this.gltf.binary=n,this.sourceBuffers=[n],this.gltf.buffers=[{arrayBuffer:n,byteOffset:0,byteLength:n.byteLength}]}_removeStringFromArray(e,n){let r=!0;for(;r;){const i=e.indexOf(n);i>-1?e.splice(i,1):r=!1}}_addAttributes(e={}){const n={};for(const r in e){const i=e[r],o=this._getGltfAttributeName(r),a=this.addBinaryBuffer(i.value,i);n[o]=a}return n}_addIndices(e){return this.addBinaryBuffer(e,{size:1})}_getGltfAttributeName(e){switch(e.toLowerCase()){case"position":case"positions":case"vertices":return"POSITION";case"normal":case"normals":return"NORMAL";case"color":case"colors":return"COLOR_0";case"texcoord":case"texcoords":return"TEXCOORD_0";default:return e}}_getAccessorMinMax(e,n){const r={min:null,max:null};if(e.length<n)return r;r.min=[],r.max=[];const i=e.subarray(0,n);for(const o of i)r.min.push(o),r.max.push(o);for(let o=n;o<e.length;o+=n)for(let a=0;a<n;a++)r.min[0+a]=Math.min(r.min[0+a],e[o+a]),r.max[0+a]=Math.max(r.max[0+a],e[o+a]);return r}}function emod(t){return(t%1+1)%1}const ATTRIBUTE_TYPE_TO_COMPONENTS={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16,BOOLEAN:1,STRING:1,ENUM:1},ATTRIBUTE_COMPONENT_TYPE_TO_ARRAY={INT8:Int8Array,UINT8:Uint8Array,INT16:Int16Array,UINT16:Uint16Array,INT32:Int32Array,UINT32:Uint32Array,INT64:BigInt64Array,UINT64:BigUint64Array,FLOAT32:Float32Array,FLOAT64:Float64Array},ATTRIBUTE_COMPONENT_TYPE_TO_BYTE_SIZE={INT8:1,UINT8:1,INT16:2,UINT16:2,INT32:4,UINT32:4,INT64:8,UINT64:8,FLOAT32:4,FLOAT64:8};function getArrayElementByteSize(t,e){return ATTRIBUTE_COMPONENT_TYPE_TO_BYTE_SIZE[e]*ATTRIBUTE_TYPE_TO_COMPONENTS[t]}function getOffsetsForProperty(t,e,n,r){if(n!=="UINT8"&&n!=="UINT16"&&n!=="UINT32"&&n!=="UINT64")return null;const i=t.getTypedArrayForBufferView(e),o=convertRawBufferToMetadataArray(i,"SCALAR",n,r+1);return o instanceof BigInt64Array||o instanceof BigUint64Array?null:o}function convertRawBufferToMetadataArray(t,e,n,r=1){const i=ATTRIBUTE_TYPE_TO_COMPONENTS[e],o=ATTRIBUTE_COMPONENT_TYPE_TO_ARRAY[n],a=ATTRIBUTE_COMPONENT_TYPE_TO_BYTE_SIZE[n],l=r*i,A=l*a;let E=t.buffer,v=t.byteOffset;return v%a!==0&&(E=new Uint8Array(E).slice(v,v+A).buffer,v=0),new o(E,v,l)}function getPrimitiveTextureData(t,e,n){const r=`TEXCOORD_${e.texCoord||0}`,i=n.attributes[r],o=t.getTypedArrayForAccessor(i),a=t.gltf.json,l=e.index,A=a.textures?.[l]?.source;if(typeof A<"u"){const E=a.images?.[A]?.mimeType,v=t.gltf.images?.[A];if(v&&typeof v.width<"u"){const x=[];for(let R=0;R<o.length;R+=2){const D=getImageValueByCoordinates(v,E,o,R,e.channels);x.push(D)}return x}}return[]}function primitivePropertyDataToAttributes(t,e,n,r,i){if(!n?.length)return;const o=[];for(const v of n){let x=r.findIndex(R=>R===v);x===-1&&(x=r.push(v)-1),o.push(x)}const a=new Uint32Array(o),l=t.gltf.buffers.push({arrayBuffer:a.buffer,byteOffset:a.byteOffset,byteLength:a.byteLength})-1,A=t.addBufferView(a,l,0),E=t.addAccessor(A,{size:1,componentType:getComponentTypeFromArray(a),count:a.length});i.attributes[e]=E}function getImageValueByCoordinates(t,e,n,r,i=[0]){const o={r:{offset:0,shift:0},g:{offset:1,shift:8},b:{offset:2,shift:16},a:{offset:3,shift:24}},a=n[r],l=n[r+1];let A=1;e&&(e.indexOf("image/jpeg")!==-1||e.indexOf("image/png")!==-1)&&(A=4);const E=coordinatesToOffset(a,l,t,A);let v=0;for(const x of i){const R=typeof x=="number"?Object.values(o)[x]:o[x],D=E+R.offset,O=getImageData(t);if(O.data.length<=D)throw new Error(`${O.data.length} <= ${D}`);const U=O.data[D];v|=U<<R.shift}return v}function coordinatesToOffset(t,e,n,r=1){const i=n.width,o=emod(t)*(i-1),a=Math.round(o),l=n.height,A=emod(e)*(l-1),E=Math.round(A),v=n.components?n.components:r;return(E*i+a)*v}function parseVariableLengthArrayNumeric(t,e,n,r,i){const o=[];for(let a=0;a<e;a++){const l=n[a],A=n[a+1]-n[a];if(A+l>r)break;const E=l/i,v=A/i;o.push(t.slice(E,E+v))}return o}function parseFixedLengthArrayNumeric(t,e,n){const r=[];for(let i=0;i<e;i++){const o=i*n;r.push(t.slice(o,o+n))}return r}function getPropertyDataString(t,e,n,r){if(n)throw new Error("Not implemented - arrayOffsets for strings is specified");if(r){const i=[],o=new TextDecoder("utf8");let a=0;for(let l=0;l<t;l++){const A=r[l+1]-r[l];if(A+a<=e.length){const E=e.subarray(a,A+a),v=o.decode(E);i.push(v),a+=A}}return i}return[]}const EXT_MESH_FEATURES_NAME="EXT_mesh_features",name$a=EXT_MESH_FEATURES_NAME;async function decode$9(t,e){const n=new GLTFScenegraph(t);decodeExtMeshFeatures(n,e)}function encode$5(t,e){const n=new GLTFScenegraph(t);return encodeExtMeshFeatures(n),n.createBinaryChunk(),n.gltf}function decodeExtMeshFeatures(t,e){const n=t.gltf.json;if(n.meshes)for(const r of n.meshes)for(const i of r.primitives)processMeshPrimitiveFeatures(t,i,e)}function processMeshPrimitiveFeatures(t,e,n){if(!n?.gltf?.loadBuffers)return;const i=e.extensions?.[EXT_MESH_FEATURES_NAME]?.featureIds;if(i)for(const o of i){let a;if(typeof o.attribute<"u"){const l=`_FEATURE_ID_${o.attribute}`,A=e.attributes[l];a=t.getTypedArrayForAccessor(A)}else typeof o.texture<"u"&&n?.gltf?.loadImages?a=getPrimitiveTextureData(t,o.texture,e):a=[];o.data=a}}function encodeExtMeshFeatures(t,e){const n=t.gltf.json.meshes;if(n)for(const r of n)for(const i of r.primitives)encodeExtMeshFeaturesForPrimitive(t,i)}function createExtMeshFeatures(t,e,n,r){e.extensions||(e.extensions={});let i=e.extensions[EXT_MESH_FEATURES_NAME];i||(i={featureIds:[]},e.extensions[EXT_MESH_FEATURES_NAME]=i);const{featureIds:o}=i,a={featureCount:n.length,propertyTable:r,data:n};o.push(a),t.addObjectExtension(e,EXT_MESH_FEATURES_NAME,i)}function encodeExtMeshFeaturesForPrimitive(t,e){const n=e.extensions?.[EXT_MESH_FEATURES_NAME];if(!n)return;const r=n.featureIds;r.forEach((i,o)=>{if(i.data){const{accessorKey:a,index:l}=createAccessorKey(e.attributes),A=new Uint32Array(i.data);r[o]={featureCount:A.length,propertyTable:i.propertyTable,attribute:l},t.gltf.buffers.push({arrayBuffer:A.buffer,byteOffset:A.byteOffset,byteLength:A.byteLength});const E=t.addBufferView(A),v=t.addAccessor(E,{size:1,componentType:getComponentTypeFromArray(A),count:A.length});e.attributes[a]=v}})}function createAccessorKey(t){const e="_FEATURE_ID_",n=Object.keys(t).filter(o=>o.indexOf(e)===0);let r=-1;for(const o of n){const a=Number(o.substring(e.length));a>r&&(r=a)}return r++,{accessorKey:`${e}${r}`,index:r}}const EXT_mesh_features=Object.freeze(Object.defineProperty({__proto__:null,createExtMeshFeatures,decode:decode$9,encode:encode$5,name:name$a},Symbol.toStringTag,{value:"Module"})),EXT_STRUCTURAL_METADATA_NAME="EXT_structural_metadata",name$9=EXT_STRUCTURAL_METADATA_NAME;async function decode$8(t,e){const n=new GLTFScenegraph(t);decodeExtStructuralMetadata(n,e)}function encode$4(t,e){const n=new GLTFScenegraph(t);return encodeExtStructuralMetadata(n),n.createBinaryChunk(),n.gltf}function decodeExtStructuralMetadata(t,e){if(!e.gltf?.loadBuffers)return;const n=t.getExtension(EXT_STRUCTURAL_METADATA_NAME);n&&(e.gltf?.loadImages&&decodePropertyTextures$1(t,n),decodePropertyTables$1(t,n))}function decodePropertyTextures$1(t,e){const n=e.propertyTextures,r=t.gltf.json;if(n&&r.meshes)for(const i of r.meshes)for(const o of i.primitives)processPrimitivePropertyTextures(t,n,o,e)}function decodePropertyTables$1(t,e){const n=e.schema;if(!n)return;const r=n.classes,i=e.propertyTables;if(r&&i)for(const o in r){const a=findPropertyTableByClass$1(i,o);a&&processPropertyTable$1(t,n,a)}}function findPropertyTableByClass$1(t,e){for(const n of t)if(n.class===e)return n;return null}function processPrimitivePropertyTextures(t,e,n,r){if(!e)return;const o=n.extensions?.[EXT_STRUCTURAL_METADATA_NAME]?.propertyTextures;if(o)for(const a of o){const l=e[a];processPrimitivePropertyTexture(t,l,n,r)}}function processPrimitivePropertyTexture(t,e,n,r){if(!e.properties)return;r.dataAttributeNames||(r.dataAttributeNames=[]);const i=e.class;for(const o in e.properties){const a=`${i}_${o}`,l=e.properties?.[o];if(!l)continue;l.data||(l.data=[]);const A=l.data,E=getPrimitiveTextureData(t,l,n);E!==null&&(primitivePropertyDataToAttributes(t,a,E,A,n),l.data=A,r.dataAttributeNames.push(a))}}function processPropertyTable$1(t,e,n){const r=e.classes?.[n.class];if(!r)throw new Error(`Incorrect data in the EXT_structural_metadata extension: no schema class with name ${n.class}`);const i=n.count;for(const o in r.properties){const a=r.properties[o],l=n.properties?.[o];if(l){const A=getPropertyDataFromBinarySource$1(t,e,a,i,l);l.data=A}}}function getPropertyDataFromBinarySource$1(t,e,n,r,i){let o=[];const a=i.values,l=t.getTypedArrayForBufferView(a),A=getArrayOffsetsForProperty$1(t,n,i,r),E=getStringOffsetsForProperty$1(t,i,r);switch(n.type){case"SCALAR":case"VEC2":case"VEC3":case"VEC4":case"MAT2":case"MAT3":case"MAT4":{o=getPropertyDataNumeric$1(n,r,l,A);break}case"BOOLEAN":throw new Error(`Not implemented - classProperty.type=${n.type}`);case"STRING":{o=getPropertyDataString(r,l,A,E);break}case"ENUM":{o=getPropertyDataENUM(e,n,r,l,A);break}default:throw new Error(`Unknown classProperty type ${n.type}`)}return o}function getArrayOffsetsForProperty$1(t,e,n,r){return e.array&&typeof e.count>"u"&&typeof n.arrayOffsets<"u"?getOffsetsForProperty(t,n.arrayOffsets,n.arrayOffsetType||"UINT32",r):null}function getStringOffsetsForProperty$1(t,e,n){return typeof e.stringOffsets<"u"?getOffsetsForProperty(t,e.stringOffsets,e.stringOffsetType||"UINT32",n):null}function getPropertyDataNumeric$1(t,e,n,r){const i=t.array,o=t.count,a=getArrayElementByteSize(t.type,t.componentType),l=n.byteLength/a;let A;return t.componentType?A=convertRawBufferToMetadataArray(n,t.type,t.componentType,l):A=n,i?r?parseVariableLengthArrayNumeric(A,e,r,n.length,a):o?parseFixedLengthArrayNumeric(A,e,o):[]:A}function getPropertyDataENUM(t,e,n,r,i){const o=e.enumType;if(!o)throw new Error("Incorrect data in the EXT_structural_metadata extension: classProperty.enumType is not set for type ENUM");const a=t.enums?.[o];if(!a)throw new Error(`Incorrect data in the EXT_structural_metadata extension: schema.enums does't contain ${o}`);const l=a.valueType||"UINT16",A=getArrayElementByteSize(e.type,l),E=r.byteLength/A;let v=convertRawBufferToMetadataArray(r,e.type,l,E);if(v||(v=r),e.array){if(i)return parseVariableLengthArrayENUM({valuesData:v,numberOfElements:n,arrayOffsets:i,valuesDataBytesLength:r.length,elementSize:A,enumEntry:a});const x=e.count;return x?parseFixedLengthArrayENUM(v,n,x,a):[]}return getEnumsArray(v,0,n,a)}function parseVariableLengthArrayENUM(t){const{valuesData:e,numberOfElements:n,arrayOffsets:r,valuesDataBytesLength:i,elementSize:o,enumEntry:a}=t,l=[];for(let A=0;A<n;A++){const E=r[A],v=r[A+1]-r[A];if(v+E>i)break;const x=E/o,R=v/o,D=getEnumsArray(e,x,R,a);l.push(D)}return l}function parseFixedLengthArrayENUM(t,e,n,r){const i=[];for(let o=0;o<e;o++){const a=n*o,l=getEnumsArray(t,a,n,r);i.push(l)}return i}function getEnumsArray(t,e,n,r){const i=[];for(let o=0;o<n;o++)if(t instanceof BigInt64Array||t instanceof BigUint64Array)i.push("");else{const a=t[e+o],l=getEnumByValue(r,a);l?i.push(l.name):i.push("")}return i}function getEnumByValue(t,e){for(const n of t.values)if(n.value===e)return n;return null}const SCHEMA_CLASS_ID_DEFAULT="schemaClassId";function encodeExtStructuralMetadata(t,e){const n=t.getExtension(EXT_STRUCTURAL_METADATA_NAME);if(n&&n.propertyTables)for(const r of n.propertyTables){const i=r.class,o=n.schema?.classes?.[i];r.properties&&o&&encodeProperties(r,o,t)}}function encodeProperties(t,e,n){for(const r in t.properties){const i=t.properties[r].data;if(i){const o=e.properties[r];if(o){const a=createPropertyTableProperty(i,o,n);t.properties[r]=a}}}}function createExtStructuralMetadata(t,e,n=SCHEMA_CLASS_ID_DEFAULT){let r=t.getExtension(EXT_STRUCTURAL_METADATA_NAME);r||(r=t.addExtension(EXT_STRUCTURAL_METADATA_NAME)),r.schema=createSchema(e,n,r.schema);const i=createPropertyTable(e,n,r.schema);return r.propertyTables||(r.propertyTables=[]),r.propertyTables.push(i)-1}function createSchema(t,e,n){const r=n??{id:"schema_id"},i={properties:{}};for(const o of t){const a={type:o.elementType,componentType:o.componentType};i.properties[o.name]=a}return r.classes={},r.classes[e]=i,r}function createPropertyTable(t,e,n){const r={class:e,count:0};let i=0;const o=n.classes?.[e];for(const a of t){if(i===0&&(i=a.values.length),i!==a.values.length&&a.values.length)throw new Error("Illegal values in attributes");o?.properties[a.name]&&(r.properties||(r.properties={}),r.properties[a.name]={values:0,data:a.values})}return r.count=i,r}function createPropertyTableProperty(t,e,n){const r={values:0};if(e.type==="STRING"){const{stringData:i,stringOffsets:o}=createPropertyDataString(t);r.stringOffsets=createBufferView(o,n),r.values=createBufferView(i,n)}else if(e.type==="SCALAR"&&e.componentType){const i=createPropertyDataScalar(t,e.componentType);r.values=createBufferView(i,n)}return r}const COMPONENT_TYPE_TO_ARRAY_CONSTRUCTOR={INT8:Int8Array,UINT8:Uint8Array,INT16:Int16Array,UINT16:Uint16Array,INT32:Int32Array,UINT32:Uint32Array,INT64:Int32Array,UINT64:Uint32Array,FLOAT32:Float32Array,FLOAT64:Float64Array};function createPropertyDataScalar(t,e){const n=[];for(const i of t)n.push(Number(i));const r=COMPONENT_TYPE_TO_ARRAY_CONSTRUCTOR[e];if(!r)throw new Error("Illegal component type");return new r(n)}function createPropertyDataString(t){const e=new TextEncoder,n=[];let r=0;for(const A of t){const E=e.encode(A);r+=E.length,n.push(E)}const i=new Uint8Array(r),o=[];let a=0;for(const A of n)i.set(A,a),o.push(a),a+=A.length;o.push(a);const l=new Uint32Array(o);return{stringData:i,stringOffsets:l}}function createBufferView(t,e){return e.gltf.buffers.push({arrayBuffer:t.buffer,byteOffset:t.byteOffset,byteLength:t.byteLength}),e.addBufferView(t)}const EXT_structural_metadata=Object.freeze(Object.defineProperty({__proto__:null,createExtStructuralMetadata,decode:decode$8,encode:encode$4,name:name$9},Symbol.toStringTag,{value:"Module"})),EXT_FEATURE_METADATA_NAME="EXT_feature_metadata",name$8=EXT_FEATURE_METADATA_NAME;async function decode$7(t,e){const n=new GLTFScenegraph(t);decodeExtFeatureMetadata(n,e)}function decodeExtFeatureMetadata(t,e){if(!e.gltf?.loadBuffers)return;const n=t.getExtension(EXT_FEATURE_METADATA_NAME);n&&(e.gltf?.loadImages&&decodePropertyTextures(t,n),decodePropertyTables(t,n))}function decodePropertyTextures(t,e){const n=e.schema;if(!n)return;const r=n.classes,{featureTextures:i}=e;if(r&&i)for(const o in r){const a=r[o],l=findFeatureTextureByClass(i,o);l&&handleFeatureTextureProperties(t,l,a)}}function decodePropertyTables(t,e){const n=e.schema;if(!n)return;const r=n.classes,i=e.featureTables;if(r&&i)for(const o in r){const a=findPropertyTableByClass(i,o);a&&processPropertyTable(t,n,a)}}function findPropertyTableByClass(t,e){for(const n in t){const r=t[n];if(r.class===e)return r}return null}function findFeatureTextureByClass(t,e){for(const n in t){const r=t[n];if(r.class===e)return r}return null}function processPropertyTable(t,e,n){if(!n.class)return;const r=e.classes?.[n.class];if(!r)throw new Error(`Incorrect data in the EXT_structural_metadata extension: no schema class with name ${n.class}`);const i=n.count;for(const o in r.properties){const a=r.properties[o],l=n.properties?.[o];if(l){const A=getPropertyDataFromBinarySource(t,e,a,i,l);l.data=A}}}function handleFeatureTextureProperties(t,e,n){const r=e.class;for(const i in n.properties){const o=e?.properties?.[i];if(o){const a=getPropertyDataFromTexture(t,o,r);o.data=a}}}function getPropertyDataFromBinarySource(t,e,n,r,i){let o=[];const a=i.bufferView,l=t.getTypedArrayForBufferView(a),A=getArrayOffsetsForProperty(t,n,i,r),E=getStringOffsetsForProperty(t,n,i,r);return n.type==="STRING"||n.componentType==="STRING"?o=getPropertyDataString(r,l,A,E):isNumericProperty(n)&&(o=getPropertyDataNumeric(n,r,l,A)),o}function getArrayOffsetsForProperty(t,e,n,r){return e.type==="ARRAY"&&typeof e.componentCount>"u"&&typeof n.arrayOffsetBufferView<"u"?getOffsetsForProperty(t,n.arrayOffsetBufferView,n.offsetType||"UINT32",r):null}function getStringOffsetsForProperty(t,e,n,r){return typeof n.stringOffsetBufferView<"u"?getOffsetsForProperty(t,n.stringOffsetBufferView,n.offsetType||"UINT32",r):null}function isNumericProperty(t){const e=["UINT8","INT16","UINT16","INT32","UINT32","INT64","UINT64","FLOAT32","FLOAT64"];return e.includes(t.type)||typeof t.componentType<"u"&&e.includes(t.componentType)}function getPropertyDataNumeric(t,e,n,r){const i=t.type==="ARRAY",o=t.componentCount,a="SCALAR",l=t.componentType||t.type,A=getArrayElementByteSize(a,l),E=n.byteLength/A,v=convertRawBufferToMetadataArray(n,a,l,E);return i?r?parseVariableLengthArrayNumeric(v,e,r,n.length,A):o?parseFixedLengthArrayNumeric(v,e,o):[]:v}function getPropertyDataFromTexture(t,e,n){const r=t.gltf.json;if(!r.meshes)return[];const i=[];for(const o of r.meshes)for(const a of o.primitives)processPrimitiveTextures(t,n,e,i,a);return i}function processPrimitiveTextures(t,e,n,r,i){const o={channels:n.channels,...n.texture},a=getPrimitiveTextureData(t,o,i);a&&primitivePropertyDataToAttributes(t,e,a,r,i)}const EXT_feature_metadata=Object.freeze(Object.defineProperty({__proto__:null,decode:decode$7,name:name$8},Symbol.toStringTag,{value:"Module"})),VERSION$2="4.3.3",VERSION$1="4.3.3",BASIS_EXTERNAL_LIBRARIES={TRANSCODER:"basis_transcoder.js",TRANSCODER_WASM:"basis_transcoder.wasm",ENCODER:"basis_encoder.js",ENCODER_WASM:"basis_encoder.wasm"};let loadBasisTranscoderPromise;async function loadBasisTranscoderModule(t){registerJSModules(t.modules);const e=getJSModuleOrNull("basis");return e||(loadBasisTranscoderPromise||=loadBasisTranscoder(t),await loadBasisTranscoderPromise)}async function loadBasisTranscoder(t){let e=null,n=null;return[e,n]=await Promise.all([await loadLibrary(BASIS_EXTERNAL_LIBRARIES.TRANSCODER,"textures",t),await loadLibrary(BASIS_EXTERNAL_LIBRARIES.TRANSCODER_WASM,"textures",t)]),e=e||globalThis.BASIS,await initializeBasisTranscoderModule(e,n)}function initializeBasisTranscoderModule(t,e){const n={};return e&&(n.wasmBinary=e),new Promise(r=>{t(n).then(i=>{const{BasisFile:o,initializeBasis:a}=i;a(),r({BasisFile:o})})})}let loadBasisEncoderPromise;async function loadBasisEncoderModule(t){const e=t.modules||{};return e.basisEncoder?e.basisEncoder:(loadBasisEncoderPromise=loadBasisEncoderPromise||loadBasisEncoder(t),await loadBasisEncoderPromise)}async function loadBasisEncoder(t){let e=null,n=null;return[e,n]=await Promise.all([await loadLibrary(BASIS_EXTERNAL_LIBRARIES.ENCODER,"textures",t),await loadLibrary(BASIS_EXTERNAL_LIBRARIES.ENCODER_WASM,"textures",t)]),e=e||globalThis.BASIS,await initializeBasisEncoderModule(e,n)}function initializeBasisEncoderModule(t,e){const n={};return e&&(n.wasmBinary=e),new Promise(r=>{t(n).then(i=>{const{BasisFile:o,KTX2File:a,initializeBasis:l,BasisEncoder:A}=i;l(),r({BasisFile:o,KTX2File:a,BasisEncoder:A})})})}const GL_EXTENSIONS_CONSTANTS={COMPRESSED_RGB_S3TC_DXT1_EXT:33776,COMPRESSED_RGBA_S3TC_DXT5_EXT:33779,COMPRESSED_RGB_PVRTC_4BPPV1_IMG:35840,COMPRESSED_RGBA_PVRTC_4BPPV1_IMG:35842,COMPRESSED_RGB_ETC1_WEBGL:36196,COMPRESSED_RGBA_ASTC_4X4_KHR:37808},BROWSER_PREFIXES=["","WEBKIT_","MOZ_"],WEBGL_EXTENSIONS={WEBGL_compressed_texture_s3tc:"dxt",WEBGL_compressed_texture_s3tc_srgb:"dxt-srgb",WEBGL_compressed_texture_etc1:"etc1",WEBGL_compressed_texture_etc:"etc2",WEBGL_compressed_texture_pvrtc:"pvrtc",WEBGL_compressed_texture_atc:"atc",WEBGL_compressed_texture_astc:"astc",EXT_texture_compression_rgtc:"rgtc"};let formats=null;function getSupportedGPUTextureFormats(t){if(!formats){t=t||getWebGLContext()||void 0,formats=new Set;for(const e of BROWSER_PREFIXES)for(const n in WEBGL_EXTENSIONS)if(t&&t.getExtension(`${e}${n}`)){const r=WEBGL_EXTENSIONS[n];formats.add(r)}}return formats}function getWebGLContext(){try{return document.createElement("canvas").getContext("webgl")}catch{return null}}const KTX2_ID=[171,75,84,88,32,50,48,187,13,10,26,10];function isKTX(t){const e=new Uint8Array(t);return!(e.byteLength<KTX2_ID.length||e[0]!==KTX2_ID[0]||e[1]!==KTX2_ID[1]||e[2]!==KTX2_ID[2]||e[3]!==KTX2_ID[3]||e[4]!==KTX2_ID[4]||e[5]!==KTX2_ID[5]||e[6]!==KTX2_ID[6]||e[7]!==KTX2_ID[7]||e[8]!==KTX2_ID[8]||e[9]!==KTX2_ID[9]||e[10]!==KTX2_ID[10]||e[11]!==KTX2_ID[11])}const OutputFormat={etc1:{basisFormat:0,compressed:!0,format:GL_EXTENSIONS_CONSTANTS.COMPRESSED_RGB_ETC1_WEBGL},etc2:{basisFormat:1,compressed:!0},bc1:{basisFormat:2,compressed:!0,format:GL_EXTENSIONS_CONSTANTS.COMPRESSED_RGB_S3TC_DXT1_EXT},bc3:{basisFormat:3,compressed:!0,format:GL_EXTENSIONS_CONSTANTS.COMPRESSED_RGBA_S3TC_DXT5_EXT},bc4:{basisFormat:4,compressed:!0},bc5:{basisFormat:5,compressed:!0},"bc7-m6-opaque-only":{basisFormat:6,compressed:!0},"bc7-m5":{basisFormat:7,compressed:!0},"pvrtc1-4-rgb":{basisFormat:8,compressed:!0,format:GL_EXTENSIONS_CONSTANTS.COMPRESSED_RGB_PVRTC_4BPPV1_IMG},"pvrtc1-4-rgba":{basisFormat:9,compressed:!0,format:GL_EXTENSIONS_CONSTANTS.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG},"astc-4x4":{basisFormat:10,compressed:!0,format:GL_EXTENSIONS_CONSTANTS.COMPRESSED_RGBA_ASTC_4X4_KHR},"atc-rgb":{basisFormat:11,compressed:!0},"atc-rgba-interpolated-alpha":{basisFormat:12,compressed:!0},rgba32:{basisFormat:13,compressed:!1},rgb565:{basisFormat:14,compressed:!1},bgr565:{basisFormat:15,compressed:!1},rgba4444:{basisFormat:16,compressed:!1}};async function parseBasis(t,e){if(e.basis.containerFormat==="auto"){if(isKTX(t)){const r=await loadBasisEncoderModule(e);return parseKTX2File(r.KTX2File,t,e)}const{BasisFile:n}=await loadBasisTranscoderModule(e);return parseBasisFile(n,t,e)}switch(e.basis.module){case"encoder":const n=await loadBasisEncoderModule(e);switch(e.basis.containerFormat){case"ktx2":return parseKTX2File(n.KTX2File,t,e);case"basis":default:return parseBasisFile(n.BasisFile,t,e)}case"transcoder":default:const{BasisFile:r}=await loadBasisTranscoderModule(e);return parseBasisFile(r,t,e)}}function parseBasisFile(t,e,n){const r=new t(new Uint8Array(e));try{if(!r.startTranscoding())throw new Error("Failed to start basis transcoding");const i=r.getNumImages(),o=[];for(let a=0;a<i;a++){const l=r.getNumLevels(a),A=[];for(let E=0;E<l;E++)A.push(transcodeImage(r,a,E,n));o.push(A)}return o}finally{r.close(),r.delete()}}function transcodeImage(t,e,n,r){const i=t.getImageWidth(e,n),o=t.getImageHeight(e,n),a=t.getHasAlpha(),{compressed:l,format:A,basisFormat:E}=getBasisOptions(r,a),v=t.getImageTranscodedSizeInBytes(e,n,E),x=new Uint8Array(v);if(!t.transcodeImage(x,e,n,E,0,0))throw new Error("failed to start Basis transcoding");return{width:i,height:o,data:x,compressed:l,format:A,hasAlpha:a}}function parseKTX2File(t,e,n){const r=new t(new Uint8Array(e));try{if(!r.startTranscoding())throw new Error("failed to start KTX2 transcoding");const i=r.getLevels(),o=[];for(let a=0;a<i;a++)o.push(transcodeKTX2Image(r,a,n));return[o]}finally{r.close(),r.delete()}}function transcodeKTX2Image(t,e,n){const{alphaFlag:r,height:i,width:o}=t.getImageLevelInfo(e,0,0),{compressed:a,format:l,basisFormat:A}=getBasisOptions(n,r),E=t.getImageTranscodedSizeInBytes(e,0,0,A),v=new Uint8Array(E);if(!t.transcodeImage(v,e,0,0,A,0,-1,-1))throw new Error("Failed to transcode KTX2 image");return{width:o,height:i,data:v,compressed:a,levelSize:E,hasAlpha:r,format:l}}function getBasisOptions(t,e){let n=t&&t.basis&&t.basis.format;return n==="auto"&&(n=selectSupportedBasisFormat()),typeof n=="object"&&(n=e?n.alpha:n.noAlpha),n=n.toLowerCase(),OutputFormat[n]}function selectSupportedBasisFormat(){const t=getSupportedGPUTextureFormats();return t.has("astc")?"astc-4x4":t.has("dxt")?{alpha:"bc3",noAlpha:"bc1"}:t.has("pvrtc")?{alpha:"pvrtc1-4-rgba",noAlpha:"pvrtc1-4-rgb"}:t.has("etc1")?"etc1":t.has("etc2")?"etc2":"rgb565"}const BasisWorkerLoader={dataType:null,batchType:null,name:"Basis",id:"basis",module:"textures",version:VERSION$1,worker:!0,extensions:["basis","ktx2"],mimeTypes:["application/octet-stream","image/ktx2"],tests:["sB"],binary:!0,options:{basis:{format:"auto",libraryPath:"libs/",containerFormat:"auto",module:"transcoder"}}},BasisLoader={...BasisWorkerLoader,parse:parseBasis},LITTLE_ENDIAN=!0,MAGIC_glTF=1735152710,GLB_FILE_HEADER_SIZE=12,GLB_CHUNK_HEADER_SIZE=8,GLB_CHUNK_TYPE_JSON=1313821514,GLB_CHUNK_TYPE_BIN=5130562,GLB_V1_CONTENT_FORMAT_JSON=0,GLB_CHUNK_TYPE_JSON_XVIZ_DEPRECATED=0,GLB_CHUNK_TYPE_BIX_XVIZ_DEPRECATED=1;function getMagicString(t,e=0){return`${String.fromCharCode(t.getUint8(e+0))}${String.fromCharCode(t.getUint8(e+1))}${String.fromCharCode(t.getUint8(e+2))}${String.fromCharCode(t.getUint8(e+3))}`}function isGLB(t,e=0,n={}){const r=new DataView(t),{magic:i=MAGIC_glTF}=n,o=r.getUint32(e,!1);return o===i||o===MAGIC_glTF}function parseGLBSync(t,e,n=0,r={}){const i=new DataView(e),o=getMagicString(i,n+0),a=i.getUint32(n+4,LITTLE_ENDIAN),l=i.getUint32(n+8,LITTLE_ENDIAN);switch(Object.assign(t,{header:{byteOffset:n,byteLength:l,hasBinChunk:!1},type:o,version:a,json:{},binChunks:[]}),n+=GLB_FILE_HEADER_SIZE,t.version){case 1:return parseGLBV1(t,i,n);case 2:return parseGLBV2(t,i,n,r={});default:throw new Error(`Invalid GLB version ${t.version}. Only supports version 1 and 2.`)}}function parseGLBV1(t,e,n){assert$4(t.header.byteLength>GLB_FILE_HEADER_SIZE+GLB_CHUNK_HEADER_SIZE);const r=e.getUint32(n+0,LITTLE_ENDIAN),i=e.getUint32(n+4,LITTLE_ENDIAN);return n+=GLB_CHUNK_HEADER_SIZE,assert$4(i===GLB_V1_CONTENT_FORMAT_JSON),parseJSONChunk(t,e,n,r),n+=r,n+=parseBINChunk(t,e,n,t.header.byteLength),n}function parseGLBV2(t,e,n,r){return assert$4(t.header.byteLength>GLB_FILE_HEADER_SIZE+GLB_CHUNK_HEADER_SIZE),parseGLBChunksSync(t,e,n,r),n+t.header.byteLength}function parseGLBChunksSync(t,e,n,r){for(;n+8<=t.header.byteLength;){const i=e.getUint32(n+0,LITTLE_ENDIAN),o=e.getUint32(n+4,LITTLE_ENDIAN);switch(n+=GLB_CHUNK_HEADER_SIZE,o){case GLB_CHUNK_TYPE_JSON:parseJSONChunk(t,e,n,i);break;case GLB_CHUNK_TYPE_BIN:parseBINChunk(t,e,n,i);break;case GLB_CHUNK_TYPE_JSON_XVIZ_DEPRECATED:r.strict||parseJSONChunk(t,e,n,i);break;case GLB_CHUNK_TYPE_BIX_XVIZ_DEPRECATED:r.strict||parseBINChunk(t,e,n,i);break}n+=padToNBytes(i,4)}return n}function parseJSONChunk(t,e,n,r){const i=new Uint8Array(e.buffer,n,r),a=new TextDecoder("utf8").decode(i);return t.json=JSON.parse(a),padToNBytes(r,4)}function parseBINChunk(t,e,n,r){return t.header.hasBinChunk=!0,t.binChunks.push({byteOffset:n,byteLength:r,arrayBuffer:e.buffer}),padToNBytes(r,4)}function resolveUrl(t,e){if(t.startsWith("data:")||t.startsWith("http:")||t.startsWith("https:"))return t;const r=e.baseUri||e.uri;if(!r)throw new Error(`'baseUri' must be provided to resolve relative url ${t}`);return r.substr(0,r.lastIndexOf("/")+1)+t}const wasm_base="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",wasm_simd="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",detector=new Uint8Array([0,97,115,109,1,0,0,0,1,4,1,96,0,0,3,3,2,0,0,5,3,1,0,1,12,1,0,10,22,2,12,0,65,0,65,0,65,0,252,10,0,0,11,7,0,65,0,253,15,26,11]),wasmpack=new Uint8Array([32,0,65,253,3,1,2,34,4,106,6,5,11,8,7,20,13,33,12,16,128,9,116,64,19,113,127,15,10,21,22,14,255,66,24,54,136,107,18,23,192,26,114,118,132,17,77,101,130,144,27,87,131,44,45,74,156,154,70,167]),FILTERS={0:"",1:"meshopt_decodeFilterOct",2:"meshopt_decodeFilterQuat",3:"meshopt_decodeFilterExp",NONE:"",OCTAHEDRAL:"meshopt_decodeFilterOct",QUATERNION:"meshopt_decodeFilterQuat",EXPONENTIAL:"meshopt_decodeFilterExp"},DECODERS={0:"meshopt_decodeVertexBuffer",1:"meshopt_decodeIndexBuffer",2:"meshopt_decodeIndexSequence",ATTRIBUTES:"meshopt_decodeVertexBuffer",TRIANGLES:"meshopt_decodeIndexBuffer",INDICES:"meshopt_decodeIndexSequence"};async function meshoptDecodeGltfBuffer(t,e,n,r,i,o="NONE"){const a=await loadWasmInstance();decode$6(a,a.exports[DECODERS[i]],t,e,n,r,a.exports[FILTERS[o||"NONE"]])}let wasmPromise;async function loadWasmInstance(){return wasmPromise||(wasmPromise=loadWasmModule()),wasmPromise}async function loadWasmModule(){let t=wasm_base;WebAssembly.validate(detector)&&(t=wasm_simd,console.log("Warning: meshopt_decoder is using experimental SIMD support"));const e=await WebAssembly.instantiate(unpack(t),{});return await e.instance.exports.__wasm_call_ctors(),e.instance}function unpack(t){const e=new Uint8Array(t.length);for(let r=0;r<t.length;++r){const i=t.charCodeAt(r);e[r]=i>96?i-71:i>64?i-65:i>47?i+4:i>46?63:62}let n=0;for(let r=0;r<t.length;++r)e[n++]=e[r]<60?wasmpack[e[r]]:(e[r]-60)*64+e[++r];return e.buffer.slice(0,n)}function decode$6(t,e,n,r,i,o,a){const l=t.exports.sbrk,A=r+3&-4,E=l(A*i),v=l(o.length),x=new Uint8Array(t.exports.memory.buffer);x.set(o,v);const R=e(E,r,i,v,o.length);if(R===0&&a&&a(E,A,i),n.set(x.subarray(E,E+r*i)),l(E-l(0)),R!==0)throw new Error(`Malformed buffer data: ${R}`)}const EXT_MESHOPT_COMPRESSION="EXT_meshopt_compression",name$7=EXT_MESHOPT_COMPRESSION;async function decode$5(t,e){const n=new GLTFScenegraph(t);if(!e?.gltf?.decompressMeshes||!e.gltf?.loadBuffers)return;const r=[];for(const i of t.json.bufferViews||[])r.push(decodeMeshoptBufferView(n,i));await Promise.all(r),n.removeExtension(EXT_MESHOPT_COMPRESSION)}async function decodeMeshoptBufferView(t,e){const n=t.getObjectExtension(e,EXT_MESHOPT_COMPRESSION);if(n){const{byteOffset:r=0,byteLength:i=0,byteStride:o,count:a,mode:l,filter:A="NONE",buffer:E}=n,v=t.gltf.buffers[E],x=new Uint8Array(v.arrayBuffer,v.byteOffset+r,i),R=new Uint8Array(t.gltf.buffers[e.buffer].arrayBuffer,e.byteOffset,e.byteLength);await meshoptDecodeGltfBuffer(R,a,o,x,l,A),t.removeObjectExtension(e,EXT_MESHOPT_COMPRESSION)}}const EXT_meshopt_compression=Object.freeze(Object.defineProperty({__proto__:null,decode:decode$5,name:name$7},Symbol.toStringTag,{value:"Module"})),EXT_TEXTURE_WEBP="EXT_texture_webp",name$6=EXT_TEXTURE_WEBP;function preprocess$3(t,e){const n=new GLTFScenegraph(t);if(!isImageFormatSupported("image/webp")){if(n.getRequiredExtensions().includes(EXT_TEXTURE_WEBP))throw new Error(`gltf: Required extension ${EXT_TEXTURE_WEBP} not supported by browser`);return}const{json:r}=n;for(const i of r.textures||[]){const o=n.getObjectExtension(i,EXT_TEXTURE_WEBP);o&&(i.source=o.source),n.removeObjectExtension(i,EXT_TEXTURE_WEBP)}n.removeExtension(EXT_TEXTURE_WEBP)}const EXT_texture_webp=Object.freeze(Object.defineProperty({__proto__:null,name:name$6,preprocess:preprocess$3},Symbol.toStringTag,{value:"Module"})),KHR_TEXTURE_BASISU="KHR_texture_basisu",name$5=KHR_TEXTURE_BASISU;function preprocess$2(t,e){const n=new GLTFScenegraph(t),{json:r}=n;for(const i of r.textures||[]){const o=n.getObjectExtension(i,KHR_TEXTURE_BASISU);o&&(i.source=o.source,n.removeObjectExtension(i,KHR_TEXTURE_BASISU))}n.removeExtension(KHR_TEXTURE_BASISU)}const KHR_texture_basisu=Object.freeze(Object.defineProperty({__proto__:null,name:name$5,preprocess:preprocess$2},Symbol.toStringTag,{value:"Module"})),VERSION="4.3.3",DracoLoader$1={dataType:null,batchType:null,name:"Draco",id:"draco",module:"draco",version:VERSION,worker:!0,extensions:["drc"],mimeTypes:["application/octet-stream"],binary:!0,tests:["DRACO"],options:{draco:{decoderType:typeof WebAssembly=="object"?"wasm":"js",libraryPath:"libs/",extraAttributes:{},attributeNameEntry:void 0}}};function getDracoSchema(t,e,n){const r=makeMetadata(e.metadata),i=[],o=transformAttributesLoaderData(e.attributes);for(const a in t){const l=t[a],A=getArrowFieldFromAttribute(a,l,o[a]);i.push(A)}if(n){const a=getArrowFieldFromAttribute("indices",n);i.push(a)}return{fields:i,metadata:r}}function transformAttributesLoaderData(t){const e={};for(const n in t){const r=t[n];e[r.name||"undefined"]=r}return e}function getArrowFieldFromAttribute(t,e,n){const r=n?makeMetadata(n.metadata):void 0;return deduceMeshField(t,e,r)}function makeMetadata(t){Object.entries(t);const e={};for(const n in t)e[`${n}.string`]=JSON.stringify(t[n]);return e}const DRACO_TO_GLTF_ATTRIBUTE_NAME_MAP={POSITION:"POSITION",NORMAL:"NORMAL",COLOR:"COLOR_0",TEX_COORD:"TEXCOORD_0"},DRACO_DATA_TYPE_TO_TYPED_ARRAY_MAP={1:Int8Array,2:Uint8Array,3:Int16Array,4:Uint16Array,5:Int32Array,6:Uint32Array,9:Float32Array},INDEX_ITEM_SIZE=4;class DracoParser{draco;decoder;metadataQuerier;constructor(e){this.draco=e,this.decoder=new this.draco.Decoder,this.metadataQuerier=new this.draco.MetadataQuerier}destroy(){this.draco.destroy(this.decoder),this.draco.destroy(this.metadataQuerier)}parseSync(e,n={}){const r=new this.draco.DecoderBuffer;r.Init(new Int8Array(e),e.byteLength),this._disableAttributeTransforms(n);const i=this.decoder.GetEncodedGeometryType(r),o=i===this.draco.TRIANGULAR_MESH?new this.draco.Mesh:new this.draco.PointCloud;try{let a;switch(i){case this.draco.TRIANGULAR_MESH:a=this.decoder.DecodeBufferToMesh(r,o);break;case this.draco.POINT_CLOUD:a=this.decoder.DecodeBufferToPointCloud(r,o);break;default:throw new Error("DRACO: Unknown geometry type.")}if(!a.ok()||!o.ptr){const R=`DRACO decompression failed: ${a.error_msg()}`;throw new Error(R)}const l=this._getDracoLoaderData(o,i,n),A=this._getMeshData(o,l,n),E=getMeshBoundingBox(A.attributes),v=getDracoSchema(A.attributes,l,A.indices);return{loader:"draco",loaderData:l,header:{vertexCount:o.num_points(),boundingBox:E},...A,schema:v}}finally{this.draco.destroy(r),o&&this.draco.destroy(o)}}_getDracoLoaderData(e,n,r){const i=this._getTopLevelMetadata(e),o=this._getDracoAttributes(e,r);return{geometry_type:n,num_attributes:e.num_attributes(),num_points:e.num_points(),num_faces:e instanceof this.draco.Mesh?e.num_faces():0,metadata:i,attributes:o}}_getDracoAttributes(e,n){const r={};for(let i=0;i<e.num_attributes();i++){const o=this.decoder.GetAttribute(e,i),a=this._getAttributeMetadata(e,i);r[o.unique_id()]={unique_id:o.unique_id(),attribute_type:o.attribute_type(),data_type:o.data_type(),num_components:o.num_components(),byte_offset:o.byte_offset(),byte_stride:o.byte_stride(),normalized:o.normalized(),attribute_index:i,metadata:a};const l=this._getQuantizationTransform(o,n);l&&(r[o.unique_id()].quantization_transform=l);const A=this._getOctahedronTransform(o,n);A&&(r[o.unique_id()].octahedron_transform=A)}return r}_getMeshData(e,n,r){const i=this._getMeshAttributes(n,e,r);if(!i.POSITION)throw new Error("DRACO: No position attribute found.");if(e instanceof this.draco.Mesh)switch(r.topology){case"triangle-strip":return{topology:"triangle-strip",mode:4,attributes:i,indices:{value:this._getTriangleStripIndices(e),size:1}};case"triangle-list":default:return{topology:"triangle-list",mode:5,attributes:i,indices:{value:this._getTriangleListIndices(e),size:1}}}return{topology:"point-list",mode:0,attributes:i}}_getMeshAttributes(e,n,r){const i={};for(const o of Object.values(e.attributes)){const a=this._deduceAttributeName(o,r);o.name=a;const l=this._getAttributeValues(n,o);if(l){const{value:A,size:E}=l;i[a]={value:A,size:E,byteOffset:o.byte_offset,byteStride:o.byte_stride,normalized:o.normalized}}}return i}_getTriangleListIndices(e){const r=e.num_faces()*3,i=r*INDEX_ITEM_SIZE,o=this.draco._malloc(i);try{return this.decoder.GetTrianglesUInt32Array(e,i,o),new Uint32Array(this.draco.HEAPF32.buffer,o,r).slice()}finally{this.draco._free(o)}}_getTriangleStripIndices(e){const n=new this.draco.DracoInt32Array;try{return this.decoder.GetTriangleStripsFromMesh(e,n),getUint32Array(n)}finally{this.draco.destroy(n)}}_getAttributeValues(e,n){const r=DRACO_DATA_TYPE_TO_TYPED_ARRAY_MAP[n.data_type];if(!r)return console.warn(`DRACO: Unsupported attribute type ${n.data_type}`),null;const i=n.num_components,a=e.num_points()*i,l=a*r.BYTES_PER_ELEMENT,A=getDracoDataType(this.draco,r);let E;const v=this.draco._malloc(l);try{const x=this.decoder.GetAttribute(e,n.attribute_index);this.decoder.GetAttributeDataArrayForAllPoints(e,x,A,l,v),E=new r(this.draco.HEAPF32.buffer,v,a).slice()}finally{this.draco._free(v)}return{value:E,size:i}}_deduceAttributeName(e,n){const r=e.unique_id;for(const[a,l]of Object.entries(n.extraAttributes||{}))if(l===r)return a;const i=e.attribute_type;for(const a in DRACO_TO_GLTF_ATTRIBUTE_NAME_MAP)if(this.draco[a]===i)return DRACO_TO_GLTF_ATTRIBUTE_NAME_MAP[a];const o=n.attributeNameEntry||"name";return e.metadata[o]?e.metadata[o].string:`CUSTOM_ATTRIBUTE_${r}`}_getTopLevelMetadata(e){const n=this.decoder.GetMetadata(e);return this._getDracoMetadata(n)}_getAttributeMetadata(e,n){const r=this.decoder.GetAttributeMetadata(e,n);return this._getDracoMetadata(r)}_getDracoMetadata(e){if(!e||!e.ptr)return{};const n={},r=this.metadataQuerier.NumEntries(e);for(let i=0;i<r;i++){const o=this.metadataQuerier.GetEntryName(e,i);n[o]=this._getDracoMetadataField(e,o)}return n}_getDracoMetadataField(e,n){const r=new this.draco.DracoInt32Array;try{this.metadataQuerier.GetIntEntryArray(e,n,r);const i=getInt32Array(r);return{int:this.metadataQuerier.GetIntEntry(e,n),string:this.metadataQuerier.GetStringEntry(e,n),double:this.metadataQuerier.GetDoubleEntry(e,n),intArray:i}}finally{this.draco.destroy(r)}}_disableAttributeTransforms(e){const{quantizedAttributes:n=[],octahedronAttributes:r=[]}=e,i=[...n,...r];for(const o of i)this.decoder.SkipAttributeTransform(this.draco[o])}_getQuantizationTransform(e,n){const{quantizedAttributes:r=[]}=n,i=e.attribute_type();if(r.map(a=>this.decoder[a]).includes(i)){const a=new this.draco.AttributeQuantizationTransform;try{if(a.InitFromAttribute(e))return{quantization_bits:a.quantization_bits(),range:a.range(),min_values:new Float32Array([1,2,3]).map(l=>a.min_value(l))}}finally{this.draco.destroy(a)}}return null}_getOctahedronTransform(e,n){const{octahedronAttributes:r=[]}=n,i=e.attribute_type();if(r.map(a=>this.decoder[a]).includes(i)){const a=new this.draco.AttributeQuantizationTransform;try{if(a.InitFromAttribute(e))return{quantization_bits:a.quantization_bits()}}finally{this.draco.destroy(a)}}return null}}function getDracoDataType(t,e){switch(e){case Float32Array:return t.DT_FLOAT32;case Int8Array:return t.DT_INT8;case Int16Array:return t.DT_INT16;case Int32Array:return t.DT_INT32;case Uint8Array:return t.DT_UINT8;case Uint16Array:return t.DT_UINT16;case Uint32Array:return t.DT_UINT32;default:return t.DT_INVALID}}function getInt32Array(t){const e=t.size(),n=new Int32Array(e);for(let r=0;r<e;r++)n[r]=t.GetValue(r);return n}function getUint32Array(t){const e=t.size(),n=new Int32Array(e);for(let r=0;r<e;r++)n[r]=t.GetValue(r);return n}const DRACO_DECODER_VERSION="1.5.6",DRACO_ENCODER_VERSION="1.4.1",STATIC_DECODER_URL=`https://www.gstatic.com/draco/versioned/decoders/${DRACO_DECODER_VERSION}`,DRACO_EXTERNAL_LIBRARIES={DECODER:"draco_wasm_wrapper.js",DECODER_WASM:"draco_decoder.wasm",FALLBACK_DECODER:"draco_decoder.js",ENCODER:"draco_encoder.js"},DRACO_EXTERNAL_LIBRARY_URLS={[DRACO_EXTERNAL_LIBRARIES.DECODER]:`${STATIC_DECODER_URL}/${DRACO_EXTERNAL_LIBRARIES.DECODER}`,[DRACO_EXTERNAL_LIBRARIES.DECODER_WASM]:`${STATIC_DECODER_URL}/${DRACO_EXTERNAL_LIBRARIES.DECODER_WASM}`,[DRACO_EXTERNAL_LIBRARIES.FALLBACK_DECODER]:`${STATIC_DECODER_URL}/${DRACO_EXTERNAL_LIBRARIES.FALLBACK_DECODER}`,[DRACO_EXTERNAL_LIBRARIES.ENCODER]:`https://raw.githubusercontent.com/google/draco/${DRACO_ENCODER_VERSION}/javascript/${DRACO_EXTERNAL_LIBRARIES.ENCODER}`};let loadDecoderPromise;async function loadDracoDecoderModule(t){const e=t.modules||{};return e.draco3d?loadDecoderPromise||=e.draco3d.createDecoderModule({}).then(n=>({draco:n})):loadDecoderPromise||=loadDracoDecoder(t),await loadDecoderPromise}async function loadDracoDecoder(t){let e,n;switch(t.draco&&t.draco.decoderType){case"js":e=await loadLibrary(DRACO_EXTERNAL_LIBRARY_URLS[DRACO_EXTERNAL_LIBRARIES.FALLBACK_DECODER],"draco",t,DRACO_EXTERNAL_LIBRARIES.FALLBACK_DECODER);break;case"wasm":default:[e,n]=await Promise.all([await loadLibrary(DRACO_EXTERNAL_LIBRARY_URLS[DRACO_EXTERNAL_LIBRARIES.DECODER],"draco",t,DRACO_EXTERNAL_LIBRARIES.DECODER),await loadLibrary(DRACO_EXTERNAL_LIBRARY_URLS[DRACO_EXTERNAL_LIBRARIES.DECODER_WASM],"draco",t,DRACO_EXTERNAL_LIBRARIES.DECODER_WASM)])}return e=e||globalThis.DracoDecoderModule,await initializeDracoDecoder(e,n)}function initializeDracoDecoder(t,e){const n={};return e&&(n.wasmBinary=e),new Promise(r=>{t({...n,onModuleLoaded:i=>r({draco:i})})})}const DracoLoader={...DracoLoader$1,parse:parse$1};async function parse$1(t,e){const{draco:n}=await loadDracoDecoderModule(e),r=new DracoParser(n);try{return r.parseSync(t,e?.draco)}finally{r.destroy()}}function getGLTFAccessors(t){const e={};for(const n in t){const r=t[n];if(n!=="indices"){const i=getGLTFAccessor(r);e[n]=i}}return e}function getGLTFAccessor(t){const{buffer:e,size:n,count:r}=getAccessorData(t);return{value:e,size:n,byteOffset:0,count:r,type:getAccessorTypeFromSize(n),componentType:getComponentTypeFromArray(e)}}function getAccessorData(t){let e=t,n=1,r=0;return t&&t.value&&(e=t.value,n=t.size||1),e&&(ArrayBuffer.isView(e)||(e=toTypedArray(e,Float32Array)),r=e.length/n),{buffer:e,size:n,count:r}}function toTypedArray(t,e,n=!1){return t?Array.isArray(t)?new e(t):n&&!(t instanceof e)?new e(t):t:null}const KHR_DRACO_MESH_COMPRESSION="KHR_draco_mesh_compression",name$4=KHR_DRACO_MESH_COMPRESSION;function preprocess$1(t,e,n){const r=new GLTFScenegraph(t);for(const i of makeMeshPrimitiveIterator(r))r.getObjectExtension(i,KHR_DRACO_MESH_COMPRESSION)}async function decode$4(t,e,n){if(!e?.gltf?.decompressMeshes)return;const r=new GLTFScenegraph(t),i=[];for(const o of makeMeshPrimitiveIterator(r))r.getObjectExtension(o,KHR_DRACO_MESH_COMPRESSION)&&i.push(decompressPrimitive(r,o,e,n));await Promise.all(i),r.removeExtension(KHR_DRACO_MESH_COMPRESSION)}function encode$3(t,e={}){const n=new GLTFScenegraph(t);for(const r of n.json.meshes||[])compressMesh(r),n.addRequiredExtension(KHR_DRACO_MESH_COMPRESSION)}async function decompressPrimitive(t,e,n,r){const i=t.getObjectExtension(e,KHR_DRACO_MESH_COMPRESSION);if(!i)return;const o=t.getTypedArrayForBufferView(i.bufferView),a=sliceArrayBuffer(o.buffer,o.byteOffset),l={...n};delete l["3d-tiles"];const A=await parseFromContext(a,DracoLoader,l,r),E=getGLTFAccessors(A.attributes);for(const[v,x]of Object.entries(E))if(v in e.attributes){const R=e.attributes[v],D=t.getAccessor(R);D?.min&&D?.max&&(x.min=D.min,x.max=D.max)}e.attributes=E,A.indices&&(e.indices=getGLTFAccessor(A.indices)),t.removeObjectExtension(e,KHR_DRACO_MESH_COMPRESSION),checkPrimitive(e)}function compressMesh(t,e,n=4,r,i){if(!r.DracoWriter)throw new Error("options.gltf.DracoWriter not provided");const o=r.DracoWriter.encodeSync({attributes:t}),a=i?.parseSync?.({attributes:t}),l=r._addFauxAttributes(a.attributes),A=r.addBufferView(o);return{primitives:[{attributes:l,mode:n,extensions:{[KHR_DRACO_MESH_COMPRESSION]:{bufferView:A,attributes:l}}}]}}function checkPrimitive(t){if(!t.attributes&&Object.keys(t.attributes).length>0)throw new Error("glTF: Empty primitive detected: Draco decompression failure?")}function*makeMeshPrimitiveIterator(t){for(const e of t.json.meshes||[])for(const n of e.primitives)yield n}const KHR_draco_mesh_compression=Object.freeze(Object.defineProperty({__proto__:null,decode:decode$4,encode:encode$3,name:name$4,preprocess:preprocess$1},Symbol.toStringTag,{value:"Module"})),DEFAULT_CONFIG={EPSILON:1e-12,debug:!1,precision:4,printTypes:!1,printDegrees:!1,printRowMajor:!0,_cartographicRadians:!1};globalThis.mathgl=globalThis.mathgl||{config:{...DEFAULT_CONFIG}};const config=globalThis.mathgl.config;function formatValue(t,{precision:e=config.precision}={}){return t=round(t),`${parseFloat(t.toPrecision(e))}`}function isArray(t){return Array.isArray(t)||ArrayBuffer.isView(t)&&!(t instanceof DataView)}function equals(t,e,n){const r=config.EPSILON;try{if(t===e)return!0;if(isArray(t)&&isArray(e)){if(t.length!==e.length)return!1;for(let i=0;i<t.length;++i)if(!equals(t[i],e[i]))return!1;return!0}return t&&t.equals?t.equals(e):e&&e.equals?e.equals(t):typeof t=="number"&&typeof e=="number"?Math.abs(t-e)<=config.EPSILON*Math.max(1,Math.abs(t),Math.abs(e)):!1}finally{config.EPSILON=r}}function round(t){return Math.round(t/config.EPSILON)*config.EPSILON}class MathArray extends Array{clone(){return new this.constructor().copy(this)}fromArray(e,n=0){for(let r=0;r<this.ELEMENTS;++r)this[r]=e[r+n];return this.check()}toArray(e=[],n=0){for(let r=0;r<this.ELEMENTS;++r)e[n+r]=this[r];return e}toObject(e){return e}from(e){return Array.isArray(e)?this.copy(e):this.fromObject(e)}to(e){return e===this?this:isArray(e)?this.toArray(e):this.toObject(e)}toTarget(e){return e?this.to(e):this}toFloat32Array(){return new Float32Array(this)}toString(){return this.formatString(config)}formatString(e){let n="";for(let r=0;r<this.ELEMENTS;++r)n+=(r>0?", ":"")+formatValue(this[r],e);return`${e.printTypes?this.constructor.name:""}[${n}]`}equals(e){if(!e||this.length!==e.length)return!1;for(let n=0;n<this.ELEMENTS;++n)if(!equals(this[n],e[n]))return!1;return!0}exactEquals(e){if(!e||this.length!==e.length)return!1;for(let n=0;n<this.ELEMENTS;++n)if(this[n]!==e[n])return!1;return!0}negate(){for(let e=0;e<this.ELEMENTS;++e)this[e]=-this[e];return this.check()}lerp(e,n,r){if(r===void 0)return this.lerp(this,e,n);for(let i=0;i<this.ELEMENTS;++i){const o=e[i],a=typeof n=="number"?n:n[i];this[i]=o+r*(a-o)}return this.check()}min(e){for(let n=0;n<this.ELEMENTS;++n)this[n]=Math.min(e[n],this[n]);return this.check()}max(e){for(let n=0;n<this.ELEMENTS;++n)this[n]=Math.max(e[n],this[n]);return this.check()}clamp(e,n){for(let r=0;r<this.ELEMENTS;++r)this[r]=Math.min(Math.max(this[r],e[r]),n[r]);return this.check()}add(...e){for(const n of e)for(let r=0;r<this.ELEMENTS;++r)this[r]+=n[r];return this.check()}subtract(...e){for(const n of e)for(let r=0;r<this.ELEMENTS;++r)this[r]-=n[r];return this.check()}scale(e){if(typeof e=="number")for(let n=0;n<this.ELEMENTS;++n)this[n]*=e;else for(let n=0;n<this.ELEMENTS&&n<e.length;++n)this[n]*=e[n];return this.check()}multiplyByScalar(e){for(let n=0;n<this.ELEMENTS;++n)this[n]*=e;return this.check()}check(){if(config.debug&&!this.validate())throw new Error(`math.gl: ${this.constructor.name} some fields set to invalid numbers'`);return this}validate(){let e=this.length===this.ELEMENTS;for(let n=0;n<this.ELEMENTS;++n)e=e&&Number.isFinite(this[n]);return e}sub(e){return this.subtract(e)}setScalar(e){for(let n=0;n<this.ELEMENTS;++n)this[n]=e;return this.check()}addScalar(e){for(let n=0;n<this.ELEMENTS;++n)this[n]+=e;return this.check()}subScalar(e){return this.addScalar(-e)}multiplyScalar(e){for(let n=0;n<this.ELEMENTS;++n)this[n]*=e;return this.check()}divideScalar(e){return this.multiplyByScalar(1/e)}clampScalar(e,n){for(let r=0;r<this.ELEMENTS;++r)this[r]=Math.min(Math.max(this[r],e),n);return this.check()}get elements(){return this}}function validateVector(t,e){if(t.length!==e)return!1;for(let n=0;n<t.length;++n)if(!Number.isFinite(t[n]))return!1;return!0}function checkNumber(t){if(!Number.isFinite(t))throw new Error(`Invalid number ${JSON.stringify(t)}`);return t}function checkVector(t,e,n=""){if(config.debug&&!validateVector(t,e))throw new Error(`math.gl: ${n} some fields set to invalid numbers'`);return t}function assert(t,e){if(!t)throw new Error(`math.gl assertion ${e}`)}class Vector extends MathArray{get x(){return this[0]}set x(e){this[0]=checkNumber(e)}get y(){return this[1]}set y(e){this[1]=checkNumber(e)}len(){return Math.sqrt(this.lengthSquared())}magnitude(){return this.len()}lengthSquared(){let e=0;for(let n=0;n<this.ELEMENTS;++n)e+=this[n]*this[n];return e}magnitudeSquared(){return this.lengthSquared()}distance(e){return Math.sqrt(this.distanceSquared(e))}distanceSquared(e){let n=0;for(let r=0;r<this.ELEMENTS;++r){const i=this[r]-e[r];n+=i*i}return checkNumber(n)}dot(e){let n=0;for(let r=0;r<this.ELEMENTS;++r)n+=this[r]*e[r];return checkNumber(n)}normalize(){const e=this.magnitude();if(e!==0)for(let n=0;n<this.ELEMENTS;++n)this[n]/=e;return this.check()}multiply(...e){for(const n of e)for(let r=0;r<this.ELEMENTS;++r)this[r]*=n[r];return this.check()}divide(...e){for(const n of e)for(let r=0;r<this.ELEMENTS;++r)this[r]/=n[r];return this.check()}lengthSq(){return this.lengthSquared()}distanceTo(e){return this.distance(e)}distanceToSquared(e){return this.distanceSquared(e)}getComponent(e){return assert(e>=0&&e<this.ELEMENTS,"index is out of range"),checkNumber(this[e])}setComponent(e,n){return assert(e>=0&&e<this.ELEMENTS,"index is out of range"),this[e]=n,this.check()}addVectors(e,n){return this.copy(e).add(n)}subVectors(e,n){return this.copy(e).subtract(n)}multiplyVectors(e,n){return this.copy(e).multiply(n)}addScaledVector(e,n){return this.add(new this.constructor(e).multiplyScalar(n))}}let ARRAY_TYPE=typeof Float32Array<"u"?Float32Array:Array;function create$1(){const t=new ARRAY_TYPE(2);return ARRAY_TYPE!=Float32Array&&(t[0]=0,t[1]=0),t}function transformMat3$1(t,e,n){const r=e[0],i=e[1];return t[0]=n[0]*r+n[3]*i+n[6],t[1]=n[1]*r+n[4]*i+n[7],t}(function(){const t=create$1();return function(e,n,r,i,o,a){let l,A;for(n||(n=2),r||(r=0),i?A=Math.min(i*n+r,e.length):A=e.length,l=r;l<A;l+=n)t[0]=e[l],t[1]=e[l+1],o(t,t,a),e[l]=t[0],e[l+1]=t[1];return e}})();function vec3_transformMat4AsVector(t,e,n){const r=e[0],i=e[1],o=e[2],a=n[3]*r+n[7]*i+n[11]*o||1;return t[0]=(n[0]*r+n[4]*i+n[8]*o)/a,t[1]=(n[1]*r+n[5]*i+n[9]*o)/a,t[2]=(n[2]*r+n[6]*i+n[10]*o)/a,t}function vec3_transformMat2(t,e,n){const r=e[0],i=e[1];return t[0]=n[0]*r+n[2]*i,t[1]=n[1]*r+n[3]*i,t[2]=e[2],t}function vec4_transformMat3(t,e,n){const r=e[0],i=e[1],o=e[2];return t[0]=n[0]*r+n[3]*i+n[6]*o,t[1]=n[1]*r+n[4]*i+n[7]*o,t[2]=n[2]*r+n[5]*i+n[8]*o,t[3]=e[3],t}function create(){const t=new ARRAY_TYPE(3);return ARRAY_TYPE!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t}function dot(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}function cross(t,e,n){const r=e[0],i=e[1],o=e[2],a=n[0],l=n[1],A=n[2];return t[0]=i*A-o*l,t[1]=o*a-r*A,t[2]=r*l-i*a,t}function transformMat4(t,e,n){const r=e[0],i=e[1],o=e[2];let a=n[3]*r+n[7]*i+n[11]*o+n[15];return a=a||1,t[0]=(n[0]*r+n[4]*i+n[8]*o+n[12])/a,t[1]=(n[1]*r+n[5]*i+n[9]*o+n[13])/a,t[2]=(n[2]*r+n[6]*i+n[10]*o+n[14])/a,t}function transformMat3(t,e,n){const r=e[0],i=e[1],o=e[2];return t[0]=r*n[0]+i*n[3]+o*n[6],t[1]=r*n[1]+i*n[4]+o*n[7],t[2]=r*n[2]+i*n[5]+o*n[8],t}function transformQuat(t,e,n){const r=n[0],i=n[1],o=n[2],a=n[3],l=e[0],A=e[1],E=e[2];let v=i*E-o*A,x=o*l-r*E,R=r*A-i*l,D=i*R-o*x,O=o*v-r*R,U=r*x-i*v;const H=a*2;return v*=H,x*=H,R*=H,D*=2,O*=2,U*=2,t[0]=l+v+D,t[1]=A+x+O,t[2]=E+R+U,t}function rotateX(t,e,n,r){const i=[],o=[];return i[0]=e[0]-n[0],i[1]=e[1]-n[1],i[2]=e[2]-n[2],o[0]=i[0],o[1]=i[1]*Math.cos(r)-i[2]*Math.sin(r),o[2]=i[1]*Math.sin(r)+i[2]*Math.cos(r),t[0]=o[0]+n[0],t[1]=o[1]+n[1],t[2]=o[2]+n[2],t}function rotateY(t,e,n,r){const i=[],o=[];return i[0]=e[0]-n[0],i[1]=e[1]-n[1],i[2]=e[2]-n[2],o[0]=i[2]*Math.sin(r)+i[0]*Math.cos(r),o[1]=i[1],o[2]=i[2]*Math.cos(r)-i[0]*Math.sin(r),t[0]=o[0]+n[0],t[1]=o[1]+n[1],t[2]=o[2]+n[2],t}function rotateZ(t,e,n,r){const i=[],o=[];return i[0]=e[0]-n[0],i[1]=e[1]-n[1],i[2]=e[2]-n[2],o[0]=i[0]*Math.cos(r)-i[1]*Math.sin(r),o[1]=i[0]*Math.sin(r)+i[1]*Math.cos(r),o[2]=i[2],t[0]=o[0]+n[0],t[1]=o[1]+n[1],t[2]=o[2]+n[2],t}function angle(t,e){const n=t[0],r=t[1],i=t[2],o=e[0],a=e[1],l=e[2],A=Math.sqrt((n*n+r*r+i*i)*(o*o+a*a+l*l)),E=A&&dot(t,e)/A;return Math.acos(Math.min(Math.max(E,-1),1))}(function(){const t=create();return function(e,n,r,i,o,a){let l,A;for(n||(n=3),r||(r=0),i?A=Math.min(i*n+r,e.length):A=e.length,l=r;l<A;l+=n)t[0]=e[l],t[1]=e[l+1],t[2]=e[l+2],o(t,t,a),e[l]=t[0],e[l+1]=t[1],e[l+2]=t[2];return e}})();const ORIGIN=[0,0,0];let ZERO;class Vector3 extends Vector{static get ZERO(){return ZERO||(ZERO=new Vector3(0,0,0),Object.freeze(ZERO)),ZERO}constructor(e=0,n=0,r=0){super(-0,-0,-0),arguments.length===1&&isArray(e)?this.copy(e):(config.debug&&(checkNumber(e),checkNumber(n),checkNumber(r)),this[0]=e,this[1]=n,this[2]=r)}set(e,n,r){return this[0]=e,this[1]=n,this[2]=r,this.check()}copy(e){return this[0]=e[0],this[1]=e[1],this[2]=e[2],this.check()}fromObject(e){return config.debug&&(checkNumber(e.x),checkNumber(e.y),checkNumber(e.z)),this[0]=e.x,this[1]=e.y,this[2]=e.z,this.check()}toObject(e){return e.x=this[0],e.y=this[1],e.z=this[2],e}get ELEMENTS(){return 3}get z(){return this[2]}set z(e){this[2]=checkNumber(e)}angle(e){return angle(this,e)}cross(e){return cross(this,this,e),this.check()}rotateX({radians:e,origin:n=ORIGIN}){return rotateX(this,this,n,e),this.check()}rotateY({radians:e,origin:n=ORIGIN}){return rotateY(this,this,n,e),this.check()}rotateZ({radians:e,origin:n=ORIGIN}){return rotateZ(this,this,n,e),this.check()}transform(e){return this.transformAsPoint(e)}transformAsPoint(e){return transformMat4(this,this,e),this.check()}transformAsVector(e){return vec3_transformMat4AsVector(this,this,e),this.check()}transformByMatrix3(e){return transformMat3(this,this,e),this.check()}transformByMatrix2(e){return vec3_transformMat2(this,this,e),this.check()}transformByQuaternion(e){return transformQuat(this,this,e),this.check()}}class Matrix extends MathArray{toString(){let e="[";if(config.printRowMajor){e+="row-major:";for(let n=0;n<this.RANK;++n)for(let r=0;r<this.RANK;++r)e+=` ${this[r*this.RANK+n]}`}else{e+="column-major:";for(let n=0;n<this.ELEMENTS;++n)e+=` ${this[n]}`}return e+="]",e}getElementIndex(e,n){return n*this.RANK+e}getElement(e,n){return this[n*this.RANK+e]}setElement(e,n,r){return this[n*this.RANK+e]=checkNumber(r),this}getColumn(e,n=new Array(this.RANK).fill(-0)){const r=e*this.RANK;for(let i=0;i<this.RANK;++i)n[i]=this[r+i];return n}setColumn(e,n){const r=e*this.RANK;for(let i=0;i<this.RANK;++i)this[r+i]=n[i];return this}}function transpose(t,e){if(t===e){const n=e[1],r=e[2],i=e[5];t[1]=e[3],t[2]=e[6],t[3]=n,t[5]=e[7],t[6]=r,t[7]=i}else t[0]=e[0],t[1]=e[3],t[2]=e[6],t[3]=e[1],t[4]=e[4],t[5]=e[7],t[6]=e[2],t[7]=e[5],t[8]=e[8];return t}function invert(t,e){const n=e[0],r=e[1],i=e[2],o=e[3],a=e[4],l=e[5],A=e[6],E=e[7],v=e[8],x=v*a-l*E,R=-v*o+l*A,D=E*o-a*A;let O=n*x+r*R+i*D;return O?(O=1/O,t[0]=x*O,t[1]=(-v*r+i*E)*O,t[2]=(l*r-i*a)*O,t[3]=R*O,t[4]=(v*n-i*A)*O,t[5]=(-l*n+i*o)*O,t[6]=D*O,t[7]=(-E*n+r*A)*O,t[8]=(a*n-r*o)*O,t):null}function determinant(t){const e=t[0],n=t[1],r=t[2],i=t[3],o=t[4],a=t[5],l=t[6],A=t[7],E=t[8];return e*(E*o-a*A)+n*(-E*i+a*l)+r*(A*i-o*l)}function multiply(t,e,n){const r=e[0],i=e[1],o=e[2],a=e[3],l=e[4],A=e[5],E=e[6],v=e[7],x=e[8],R=n[0],D=n[1],O=n[2],U=n[3],H=n[4],$=n[5],X=n[6],V=n[7],q=n[8];return t[0]=R*r+D*a+O*E,t[1]=R*i+D*l+O*v,t[2]=R*o+D*A+O*x,t[3]=U*r+H*a+$*E,t[4]=U*i+H*l+$*v,t[5]=U*o+H*A+$*x,t[6]=X*r+V*a+q*E,t[7]=X*i+V*l+q*v,t[8]=X*o+V*A+q*x,t}function translate(t,e,n){const r=e[0],i=e[1],o=e[2],a=e[3],l=e[4],A=e[5],E=e[6],v=e[7],x=e[8],R=n[0],D=n[1];return t[0]=r,t[1]=i,t[2]=o,t[3]=a,t[4]=l,t[5]=A,t[6]=R*r+D*a+E,t[7]=R*i+D*l+v,t[8]=R*o+D*A+x,t}function rotate(t,e,n){const r=e[0],i=e[1],o=e[2],a=e[3],l=e[4],A=e[5],E=e[6],v=e[7],x=e[8],R=Math.sin(n),D=Math.cos(n);return t[0]=D*r+R*a,t[1]=D*i+R*l,t[2]=D*o+R*A,t[3]=D*a-R*r,t[4]=D*l-R*i,t[5]=D*A-R*o,t[6]=E,t[7]=v,t[8]=x,t}function scale(t,e,n){const r=n[0],i=n[1];return t[0]=r*e[0],t[1]=r*e[1],t[2]=r*e[2],t[3]=i*e[3],t[4]=i*e[4],t[5]=i*e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t}function fromQuat(t,e){const n=e[0],r=e[1],i=e[2],o=e[3],a=n+n,l=r+r,A=i+i,E=n*a,v=r*a,x=r*l,R=i*a,D=i*l,O=i*A,U=o*a,H=o*l,$=o*A;return t[0]=1-x-O,t[3]=v-$,t[6]=R+H,t[1]=v+$,t[4]=1-E-O,t[7]=D-U,t[2]=R-H,t[5]=D+U,t[8]=1-E-x,t}var INDICES;(function(t){t[t.COL0ROW0=0]="COL0ROW0",t[t.COL0ROW1=1]="COL0ROW1",t[t.COL0ROW2=2]="COL0ROW2",t[t.COL1ROW0=3]="COL1ROW0",t[t.COL1ROW1=4]="COL1ROW1",t[t.COL1ROW2=5]="COL1ROW2",t[t.COL2ROW0=6]="COL2ROW0",t[t.COL2ROW1=7]="COL2ROW1",t[t.COL2ROW2=8]="COL2ROW2"})(INDICES||(INDICES={}));const IDENTITY_MATRIX=Object.freeze([1,0,0,0,1,0,0,0,1]);class Matrix3 extends Matrix{static get IDENTITY(){return getIdentityMatrix()}static get ZERO(){return getZeroMatrix()}get ELEMENTS(){return 9}get RANK(){return 3}get INDICES(){return INDICES}constructor(e,...n){super(-0,-0,-0,-0,-0,-0,-0,-0,-0),arguments.length===1&&Array.isArray(e)?this.copy(e):n.length>0?this.copy([e,...n]):this.identity()}copy(e){return this[0]=e[0],this[1]=e[1],this[2]=e[2],this[3]=e[3],this[4]=e[4],this[5]=e[5],this[6]=e[6],this[7]=e[7],this[8]=e[8],this.check()}identity(){return this.copy(IDENTITY_MATRIX)}fromObject(e){return this.check()}fromQuaternion(e){return fromQuat(this,e),this.check()}set(e,n,r,i,o,a,l,A,E){return this[0]=e,this[1]=n,this[2]=r,this[3]=i,this[4]=o,this[5]=a,this[6]=l,this[7]=A,this[8]=E,this.check()}setRowMajor(e,n,r,i,o,a,l,A,E){return this[0]=e,this[1]=i,this[2]=l,this[3]=n,this[4]=o,this[5]=A,this[6]=r,this[7]=a,this[8]=E,this.check()}determinant(){return determinant(this)}transpose(){return transpose(this,this),this.check()}invert(){return invert(this,this),this.check()}multiplyLeft(e){return multiply(this,e,this),this.check()}multiplyRight(e){return multiply(this,this,e),this.check()}rotate(e){return rotate(this,this,e),this.check()}scale(e){return Array.isArray(e)?scale(this,this,e):scale(this,this,[e,e]),this.check()}translate(e){return translate(this,this,e),this.check()}transform(e,n){let r;switch(e.length){case 2:r=transformMat3$1(n||[-0,-0],e,this);break;case 3:r=transformMat3(n||[-0,-0,-0],e,this);break;case 4:r=vec4_transformMat3(n||[-0,-0,-0,-0],e,this);break;default:throw new Error("Illegal vector")}return checkVector(r,e.length),r}transformVector(e,n){return this.transform(e,n)}transformVector2(e,n){return this.transform(e,n)}transformVector3(e,n){return this.transform(e,n)}}let ZERO_MATRIX3,IDENTITY_MATRIX3=null;function getZeroMatrix(){return ZERO_MATRIX3||(ZERO_MATRIX3=new Matrix3([0,0,0,0,0,0,0,0,0]),Object.freeze(ZERO_MATRIX3)),ZERO_MATRIX3}function getIdentityMatrix(){return IDENTITY_MATRIX3||(IDENTITY_MATRIX3=new Matrix3,Object.freeze(IDENTITY_MATRIX3)),IDENTITY_MATRIX3}const KHR_TEXTURE_TRANSFORM="KHR_texture_transform",name$3=KHR_TEXTURE_TRANSFORM,scratchVector=new Vector3,scratchRotationMatrix=new Matrix3,scratchScaleMatrix=new Matrix3;async function decode$3(t,e){if(!new GLTFScenegraph(t).hasExtension(KHR_TEXTURE_TRANSFORM)||!e.gltf?.loadBuffers)return;const i=t.json.materials||[];for(let o=0;o<i.length;o++)transformTexCoords(o,t)}function transformTexCoords(t,e){const n=e.json.materials?.[t],r=[n?.pbrMetallicRoughness?.baseColorTexture,n?.emissiveTexture,n?.normalTexture,n?.occlusionTexture,n?.pbrMetallicRoughness?.metallicRoughnessTexture],i=[];for(const o of r)o&&o?.extensions?.[KHR_TEXTURE_TRANSFORM]&&transformPrimitives(e,t,o,i)}function transformPrimitives(t,e,n,r){const i=getTransformParameters(n,r);if(!i)return;const o=t.json.meshes||[];for(const a of o)for(const l of a.primitives){const A=l.material;Number.isFinite(A)&&e===A&&transformPrimitive(t,l,i)}}function getTransformParameters(t,e){const n=t.extensions?.[KHR_TEXTURE_TRANSFORM],{texCoord:r=0}=t,{texCoord:i=r}=n;if(!(e.findIndex(([a,l])=>a===r&&l===i)!==-1)){const a=makeTransformationMatrix(n);return r!==i&&(t.texCoord=i),e.push([r,i]),{originalTexCoord:r,texCoord:i,matrix:a}}return null}function transformPrimitive(t,e,n){const{originalTexCoord:r,texCoord:i,matrix:o}=n,a=e.attributes[`TEXCOORD_${r}`];if(Number.isFinite(a)){const l=t.json.accessors?.[a];if(l&&l.bufferView){const A=t.json.bufferViews?.[l.bufferView];if(A){const{arrayBuffer:E,byteOffset:v}=t.buffers[A.buffer],x=(v||0)+(l.byteOffset||0)+(A.byteOffset||0),{ArrayType:R,length:D}=getAccessorArrayTypeAndLength(l,A),O=BYTES[l.componentType],U=COMPONENTS[l.type],H=A.byteStride||O*U,$=new Float32Array(D);for(let X=0;X<l.count;X++){const V=new R(E,x+X*H,2);scratchVector.set(V[0],V[1],1),scratchVector.transformByMatrix3(o),$.set([scratchVector[0],scratchVector[1]],X*U)}r===i?updateGltf(l,A,t.buffers,$):createAttribute(i,l,e,t,$)}}}}function updateGltf(t,e,n,r){t.componentType=5126,n.push({arrayBuffer:r.buffer,byteOffset:0,byteLength:r.buffer.byteLength}),e.buffer=n.length-1,e.byteLength=r.buffer.byteLength,e.byteOffset=0,delete e.byteStride}function createAttribute(t,e,n,r,i){r.buffers.push({arrayBuffer:i.buffer,byteOffset:0,byteLength:i.buffer.byteLength});const o=r.json.bufferViews;if(!o)return;o.push({buffer:r.buffers.length-1,byteLength:i.buffer.byteLength,byteOffset:0});const a=r.json.accessors;a&&(a.push({bufferView:o?.length-1,byteOffset:0,componentType:5126,count:e.count,type:"VEC2"}),n.attributes[`TEXCOORD_${t}`]=a.length-1)}function makeTransformationMatrix(t){const{offset:e=[0,0],rotation:n=0,scale:r=[1,1]}=t,i=new Matrix3().set(1,0,0,0,1,0,e[0],e[1],1),o=scratchRotationMatrix.set(Math.cos(n),Math.sin(n),0,-Math.sin(n),Math.cos(n),0,0,0,1),a=scratchScaleMatrix.set(r[0],0,0,0,r[1],0,0,0,1);return i.multiplyRight(o).multiplyRight(a)}const KHR_texture_transform=Object.freeze(Object.defineProperty({__proto__:null,decode:decode$3,name:name$3},Symbol.toStringTag,{value:"Module"})),KHR_LIGHTS_PUNCTUAL="KHR_lights_punctual",name$2=KHR_LIGHTS_PUNCTUAL;async function decode$2(t){const e=new GLTFScenegraph(t),{json:n}=e,r=e.getExtension(KHR_LIGHTS_PUNCTUAL);r&&(e.json.lights=r.lights,e.removeExtension(KHR_LIGHTS_PUNCTUAL));for(const i of n.nodes||[]){const o=e.getObjectExtension(i,KHR_LIGHTS_PUNCTUAL);o&&(i.light=o.light),e.removeObjectExtension(i,KHR_LIGHTS_PUNCTUAL)}}async function encode$2(t){const e=new GLTFScenegraph(t),{json:n}=e;if(n.lights){const r=e.addExtension(KHR_LIGHTS_PUNCTUAL);assert$1(!r.lights),r.lights=n.lights,delete n.lights}if(e.json.lights){for(const r of e.json.lights){const i=r.node;e.addObjectExtension(i,KHR_LIGHTS_PUNCTUAL,r)}delete e.json.lights}}const KHR_lights_punctual=Object.freeze(Object.defineProperty({__proto__:null,decode:decode$2,encode:encode$2,name:name$2},Symbol.toStringTag,{value:"Module"})),KHR_MATERIALS_UNLIT="KHR_materials_unlit",name$1=KHR_MATERIALS_UNLIT;async function decode$1(t){const e=new GLTFScenegraph(t),{json:n}=e;for(const r of n.materials||[])r.extensions&&r.extensions.KHR_materials_unlit&&(r.unlit=!0),e.removeObjectExtension(r,KHR_MATERIALS_UNLIT);e.removeExtension(KHR_MATERIALS_UNLIT)}function encode$1(t){const e=new GLTFScenegraph(t),{json:n}=e;if(e.materials)for(const r of n.materials||[])r.unlit&&(delete r.unlit,e.addObjectExtension(r,KHR_MATERIALS_UNLIT,{}),e.addExtension(KHR_MATERIALS_UNLIT))}const KHR_materials_unlit=Object.freeze(Object.defineProperty({__proto__:null,decode:decode$1,encode:encode$1,name:name$1},Symbol.toStringTag,{value:"Module"})),KHR_TECHNIQUES_WEBGL="KHR_techniques_webgl",name=KHR_TECHNIQUES_WEBGL;async function decode(t){const e=new GLTFScenegraph(t),{json:n}=e,r=e.getExtension(KHR_TECHNIQUES_WEBGL);if(r){const i=resolveTechniques(r,e);for(const o of n.materials||[]){const a=e.getObjectExtension(o,KHR_TECHNIQUES_WEBGL);a&&(o.technique=Object.assign({},a,i[a.technique]),o.technique.values=resolveValues(o.technique,e)),e.removeObjectExtension(o,KHR_TECHNIQUES_WEBGL)}e.removeExtension(KHR_TECHNIQUES_WEBGL)}}async function encode(t,e){}function resolveTechniques(t,e){const{programs:n=[],shaders:r=[],techniques:i=[]}=t,o=new TextDecoder;return r.forEach(a=>{if(Number.isFinite(a.bufferView))a.code=o.decode(e.getTypedArrayForBufferView(a.bufferView));else throw new Error("KHR_techniques_webgl: no shader code")}),n.forEach(a=>{a.fragmentShader=r[a.fragmentShader],a.vertexShader=r[a.vertexShader]}),i.forEach(a=>{a.program=n[a.program]}),i}function resolveValues(t,e){const n=Object.assign({},t.values);return Object.keys(t.uniforms||{}).forEach(r=>{t.uniforms[r].value&&!(r in n)&&(n[r]=t.uniforms[r].value)}),Object.keys(n).forEach(r=>{typeof n[r]=="object"&&n[r].index!==void 0&&(n[r].texture=e.getTexture(n[r].index))}),n}const KHR_techniques_webgl=Object.freeze(Object.defineProperty({__proto__:null,decode,encode,name},Symbol.toStringTag,{value:"Module"})),EXTENSIONS=[EXT_structural_metadata,EXT_mesh_features,EXT_meshopt_compression,EXT_texture_webp,KHR_texture_basisu,KHR_draco_mesh_compression,KHR_lights_punctual,KHR_materials_unlit,KHR_techniques_webgl,KHR_texture_transform,EXT_feature_metadata];function preprocessExtensions(t,e={},n){const r=EXTENSIONS.filter(i=>useExtension(i.name,e));for(const i of r)i.preprocess?.(t,e,n)}async function decodeExtensions(t,e={},n){const r=EXTENSIONS.filter(i=>useExtension(i.name,e));for(const i of r)await i.decode?.(t,e,n)}function useExtension(t,e){const n=e?.gltf?.excludeExtensions||{};return!(t in n&&!n[t])}const KHR_BINARY_GLTF="KHR_binary_glTF";function preprocess(t){const e=new GLTFScenegraph(t),{json:n}=e;for(const r of n.images||[]){const i=e.getObjectExtension(r,KHR_BINARY_GLTF);i&&Object.assign(r,i),e.removeObjectExtension(r,KHR_BINARY_GLTF)}n.buffers&&n.buffers[0]&&delete n.buffers[0].uri,e.removeExtension(KHR_BINARY_GLTF)}const GLTF_ARRAYS={accessors:"accessor",animations:"animation",buffers:"buffer",bufferViews:"bufferView",images:"image",materials:"material",meshes:"mesh",nodes:"node",samplers:"sampler",scenes:"scene",skins:"skin",textures:"texture"},GLTF_KEYS={accessor:"accessors",animations:"animation",buffer:"buffers",bufferView:"bufferViews",image:"images",material:"materials",mesh:"meshes",node:"nodes",sampler:"samplers",scene:"scenes",skin:"skins",texture:"textures"};class GLTFV1Normalizer{idToIndexMap={animations:{},accessors:{},buffers:{},bufferViews:{},images:{},materials:{},meshes:{},nodes:{},samplers:{},scenes:{},skins:{},textures:{}};json;normalize(e,n){this.json=e.json;const r=e.json;switch(r.asset&&r.asset.version){case"2.0":return;case void 0:case"1.0":break;default:console.warn(`glTF: Unknown version ${r.asset.version}`);return}if(!n.normalize)throw new Error("glTF v1 is not supported.");console.warn("Converting glTF v1 to glTF v2 format. This is experimental and may fail."),this._addAsset(r),this._convertTopLevelObjectsToArrays(r),preprocess(e),this._convertObjectIdsToArrayIndices(r),this._updateObjects(r),this._updateMaterial(r)}_addAsset(e){e.asset=e.asset||{},e.asset.version="2.0",e.asset.generator=e.asset.generator||"Normalized to glTF 2.0 by loaders.gl"}_convertTopLevelObjectsToArrays(e){for(const n in GLTF_ARRAYS)this._convertTopLevelObjectToArray(e,n)}_convertTopLevelObjectToArray(e,n){const r=e[n];if(!(!r||Array.isArray(r))){e[n]=[];for(const i in r){const o=r[i];o.id=o.id||i;const a=e[n].length;e[n].push(o),this.idToIndexMap[n][i]=a}}}_convertObjectIdsToArrayIndices(e){for(const n in GLTF_ARRAYS)this._convertIdsToIndices(e,n);"scene"in e&&(e.scene=this._convertIdToIndex(e.scene,"scene"));for(const n of e.textures)this._convertTextureIds(n);for(const n of e.meshes)this._convertMeshIds(n);for(const n of e.nodes)this._convertNodeIds(n);for(const n of e.scenes)this._convertSceneIds(n)}_convertTextureIds(e){e.source&&(e.source=this._convertIdToIndex(e.source,"image"))}_convertMeshIds(e){for(const n of e.primitives){const{attributes:r,indices:i,material:o}=n;for(const a in r)r[a]=this._convertIdToIndex(r[a],"accessor");i&&(n.indices=this._convertIdToIndex(i,"accessor")),o&&(n.material=this._convertIdToIndex(o,"material"))}}_convertNodeIds(e){e.children&&(e.children=e.children.map(n=>this._convertIdToIndex(n,"node"))),e.meshes&&(e.meshes=e.meshes.map(n=>this._convertIdToIndex(n,"mesh")))}_convertSceneIds(e){e.nodes&&(e.nodes=e.nodes.map(n=>this._convertIdToIndex(n,"node")))}_convertIdsToIndices(e,n){e[n]||(console.warn(`gltf v1: json doesn't contain attribute ${n}`),e[n]=[]);for(const r of e[n])for(const i in r){const o=r[i],a=this._convertIdToIndex(o,i);r[i]=a}}_convertIdToIndex(e,n){const r=GLTF_KEYS[n];if(r in this.idToIndexMap){const i=this.idToIndexMap[r][e];if(!Number.isFinite(i))throw new Error(`gltf v1: failed to resolve ${n} with id ${e}`);return i}return e}_updateObjects(e){for(const n of this.json.buffers)delete n.type}_updateMaterial(e){for(const n of e.materials){n.pbrMetallicRoughness={baseColorFactor:[1,1,1,1],metallicFactor:1,roughnessFactor:1};const r=n.values?.tex||n.values?.texture2d_0||n.values?.diffuseTex,i=e.textures.findIndex(o=>o.id===r);i!==-1&&(n.pbrMetallicRoughness.baseColorTexture={index:i})}}}function normalizeGLTFV1(t,e={}){return new GLTFV1Normalizer().normalize(t,e)}async function parseGLTF(t,e,n=0,r,i){return parseGLTFContainerSync(t,e,n,r),normalizeGLTFV1(t,{normalize:r?.gltf?.normalize}),preprocessExtensions(t,r,i),r?.gltf?.loadBuffers&&t.json.buffers&&await loadBuffers(t,r,i),r?.gltf?.loadImages&&await loadImages(t,r,i),await decodeExtensions(t,r,i),t}function parseGLTFContainerSync(t,e,n,r){if(r.uri&&(t.baseUri=r.uri),e instanceof ArrayBuffer&&!isGLB(e,n,r)&&(e=new TextDecoder().decode(e)),typeof e=="string")t.json=parseJSON(e);else if(e instanceof ArrayBuffer){const a={};n=parseGLBSync(a,e,n,r.glb),assert$1(a.type==="glTF",`Invalid GLB magic string ${a.type}`),t._glb=a,t.json=a.json}else assert$1(!1,"GLTF: must be ArrayBuffer or string");const i=t.json.buffers||[];if(t.buffers=new Array(i.length).fill(null),t._glb&&t._glb.header.hasBinChunk){const{binChunks:a}=t._glb;t.buffers[0]={arrayBuffer:a[0].arrayBuffer,byteOffset:a[0].byteOffset,byteLength:a[0].byteLength}}const o=t.json.images||[];t.images=new Array(o.length).fill({})}async function loadBuffers(t,e,n){const r=t.json.buffers||[];for(let i=0;i<r.length;++i){const o=r[i];if(o.uri){const{fetch:a}=n;assert$1(a);const l=resolveUrl(o.uri,e),E=await(await n?.fetch?.(l))?.arrayBuffer?.();t.buffers[i]={arrayBuffer:E,byteOffset:0,byteLength:E.byteLength},delete o.uri}else t.buffers[i]===null&&(t.buffers[i]={arrayBuffer:new ArrayBuffer(o.byteLength),byteOffset:0,byteLength:o.byteLength})}}async function loadImages(t,e,n){const r=getReferencesImageIndices(t),i=t.json.images||[],o=[];for(const a of r)o.push(loadImage(t,i[a],a,e,n));return await Promise.all(o)}function getReferencesImageIndices(t){const e=new Set,n=t.json.textures||[];for(const r of n)r.source!==void 0&&e.add(r.source);return Array.from(e).sort()}async function loadImage(t,e,n,r,i){let o;if(e.uri&&!e.hasOwnProperty("bufferView")){const l=resolveUrl(e.uri,r),{fetch:A}=i;o=await(await A(l)).arrayBuffer(),e.bufferView={data:o}}if(Number.isFinite(e.bufferView)){const l=getTypedArrayForBufferView(t.json,t.buffers,e.bufferView);o=sliceArrayBuffer(l.buffer,l.byteOffset,l.byteLength)}assert$1(o,"glTF image has no data");let a=await parseFromContext(o,[ImageLoader,BasisLoader],{...r,mimeType:e.mimeType,basis:r.basis||{format:selectSupportedBasisFormat()}},i);a&&a[0]&&(a={compressed:!0,mipmaps:!1,width:a[0].width,height:a[0].height,data:a[0]}),t.images=t.images||[],t.images[n]=a}const GLTFLoader={dataType:null,batchType:null,name:"glTF",id:"gltf",module:"gltf",version:VERSION$2,extensions:["gltf","glb"],mimeTypes:["model/gltf+json","model/gltf-binary"],text:!0,binary:!0,tests:["glTF"],parse,options:{gltf:{normalize:!0,loadBuffers:!0,loadImages:!0,decompressMeshes:!0},log:console}};async function parse(t,e={},n){e={...GLTFLoader.options,...e},e.gltf={...GLTFLoader.options.gltf,...e.gltf};const{byteOffset:r=0}=e;return await parseGLTF({},t,r,e,n)}function wrapConstructor(t,e){return class extends t{constructor(...n){super(...n),e(this)}}}const ZeroArray=wrapConstructor(Array,t=>t.fill(0));let EPSILON=1e-6;function getAPIImpl$5(t){function e(b=0,w=0){const T=new t(2);return b!==void 0&&(T[0]=b,w!==void 0&&(T[1]=w)),T}const n=e;function r(b,w,T){const s=T??new t(2);return s[0]=b,s[1]=w,s}function i(b,w){const T=w??new t(2);return T[0]=Math.ceil(b[0]),T[1]=Math.ceil(b[1]),T}function o(b,w){const T=w??new t(2);return T[0]=Math.floor(b[0]),T[1]=Math.floor(b[1]),T}function a(b,w){const T=w??new t(2);return T[0]=Math.round(b[0]),T[1]=Math.round(b[1]),T}function l(b,w=0,T=1,s){const m=s??new t(2);return m[0]=Math.min(T,Math.max(w,b[0])),m[1]=Math.min(T,Math.max(w,b[1])),m}function A(b,w,T){const s=T??new t(2);return s[0]=b[0]+w[0],s[1]=b[1]+w[1],s}function E(b,w,T,s){const m=s??new t(2);return m[0]=b[0]+w[0]*T,m[1]=b[1]+w[1]*T,m}function v(b,w){const T=b[0],s=b[1],m=w[0],d=w[1],h=Math.sqrt(T*T+s*s),u=Math.sqrt(m*m+d*d),g=h*u,C=g&&we(b,w)/g;return Math.acos(C)}function x(b,w,T){const s=T??new t(2);return s[0]=b[0]-w[0],s[1]=b[1]-w[1],s}const R=x;function D(b,w){return Math.abs(b[0]-w[0])<EPSILON&&Math.abs(b[1]-w[1])<EPSILON}function O(b,w){return b[0]===w[0]&&b[1]===w[1]}function U(b,w,T,s){const m=s??new t(2);return m[0]=b[0]+T*(w[0]-b[0]),m[1]=b[1]+T*(w[1]-b[1]),m}function H(b,w,T,s){const m=s??new t(2);return m[0]=b[0]+T[0]*(w[0]-b[0]),m[1]=b[1]+T[1]*(w[1]-b[1]),m}function $(b,w,T){const s=T??new t(2);return s[0]=Math.max(b[0],w[0]),s[1]=Math.max(b[1],w[1]),s}function X(b,w,T){const s=T??new t(2);return s[0]=Math.min(b[0],w[0]),s[1]=Math.min(b[1],w[1]),s}function V(b,w,T){const s=T??new t(2);return s[0]=b[0]*w,s[1]=b[1]*w,s}const q=V;function te(b,w,T){const s=T??new t(2);return s[0]=b[0]/w,s[1]=b[1]/w,s}function be(b,w){const T=w??new t(2);return T[0]=1/b[0],T[1]=1/b[1],T}const Ie=be;function Ee(b,w,T){const s=T??new t(3),m=b[0]*w[1]-b[1]*w[0];return s[0]=0,s[1]=0,s[2]=m,s}function we(b,w){return b[0]*w[0]+b[1]*w[1]}function oe(b){const w=b[0],T=b[1];return Math.sqrt(w*w+T*T)}const Ge=oe;function ge(b){const w=b[0],T=b[1];return w*w+T*T}const Re=ge;function ae(b,w){const T=b[0]-w[0],s=b[1]-w[1];return Math.sqrt(T*T+s*s)}const Y=ae;function Q(b,w){const T=b[0]-w[0],s=b[1]-w[1];return T*T+s*s}const j=Q;function pe(b,w){const T=w??new t(2),s=b[0],m=b[1],d=Math.sqrt(s*s+m*m);return d>1e-5?(T[0]=s/d,T[1]=m/d):(T[0]=0,T[1]=0),T}function Le(b,w){const T=w??new t(2);return T[0]=-b[0],T[1]=-b[1],T}function ee(b,w){const T=w??new t(2);return T[0]=b[0],T[1]=b[1],T}const De=ee;function ye(b,w,T){const s=T??new t(2);return s[0]=b[0]*w[0],s[1]=b[1]*w[1],s}const Pe=ye;function Ce(b,w,T){const s=T??new t(2);return s[0]=b[0]/w[0],s[1]=b[1]/w[1],s}const xe=Ce;function Me(b=1,w){const T=w??new t(2),s=Math.random()*2*Math.PI;return T[0]=Math.cos(s)*b,T[1]=Math.sin(s)*b,T}function S(b){const w=b??new t(2);return w[0]=0,w[1]=0,w}function L(b,w,T){const s=T??new t(2),m=b[0],d=b[1];return s[0]=m*w[0]+d*w[4]+w[12],s[1]=m*w[1]+d*w[5]+w[13],s}function y(b,w,T){const s=T??new t(2),m=b[0],d=b[1];return s[0]=w[0]*m+w[4]*d+w[8],s[1]=w[1]*m+w[5]*d+w[9],s}function c(b,w,T,s){const m=s??new t(2),d=b[0]-w[0],h=b[1]-w[1],u=Math.sin(T),g=Math.cos(T);return m[0]=d*g-h*u+w[0],m[1]=d*u+h*g+w[1],m}function p(b,w,T){const s=T??new t(2);return pe(b,s),V(s,w,s)}function f(b,w,T){const s=T??new t(2);return oe(b)>w?p(b,w,s):ee(b,s)}function _(b,w,T){const s=T??new t(2);return U(b,w,.5,s)}return{create:e,fromValues:n,set:r,ceil:i,floor:o,round:a,clamp:l,add:A,addScaled:E,angle:v,subtract:x,sub:R,equalsApproximately:D,equals:O,lerp:U,lerpV:H,max:$,min:X,mulScalar:V,scale:q,divScalar:te,inverse:be,invert:Ie,cross:Ee,dot:we,length:oe,len:Ge,lengthSq:ge,lenSq:Re,distance:ae,dist:Y,distanceSq:Q,distSq:j,normalize:pe,negate:Le,copy:ee,clone:De,multiply:ye,mul:Pe,divide:Ce,div:xe,random:Me,zero:S,transformMat4:L,transformMat3:y,rotate:c,setLength:p,truncate:f,midpoint:_}}const cache$5=new Map;function getAPI$5(t){let e=cache$5.get(t);return e||(e=getAPIImpl$5(t),cache$5.set(t,e)),e}function getAPIImpl$4(t){function e(u,g,C){const B=new t(3);return u!==void 0&&(B[0]=u,g!==void 0&&(B[1]=g,C!==void 0&&(B[2]=C))),B}const n=e;function r(u,g,C,B){const I=B??new t(3);return I[0]=u,I[1]=g,I[2]=C,I}function i(u,g){const C=g??new t(3);return C[0]=Math.ceil(u[0]),C[1]=Math.ceil(u[1]),C[2]=Math.ceil(u[2]),C}function o(u,g){const C=g??new t(3);return C[0]=Math.floor(u[0]),C[1]=Math.floor(u[1]),C[2]=Math.floor(u[2]),C}function a(u,g){const C=g??new t(3);return C[0]=Math.round(u[0]),C[1]=Math.round(u[1]),C[2]=Math.round(u[2]),C}function l(u,g=0,C=1,B){const I=B??new t(3);return I[0]=Math.min(C,Math.max(g,u[0])),I[1]=Math.min(C,Math.max(g,u[1])),I[2]=Math.min(C,Math.max(g,u[2])),I}function A(u,g,C){const B=C??new t(3);return B[0]=u[0]+g[0],B[1]=u[1]+g[1],B[2]=u[2]+g[2],B}function E(u,g,C,B){const I=B??new t(3);return I[0]=u[0]+g[0]*C,I[1]=u[1]+g[1]*C,I[2]=u[2]+g[2]*C,I}function v(u,g){const C=u[0],B=u[1],I=u[2],M=g[0],G=g[1],N=g[2],P=Math.sqrt(C*C+B*B+I*I),F=Math.sqrt(M*M+G*G+N*N),k=P*F,K=k&&we(u,g)/k;return Math.acos(K)}function x(u,g,C){const B=C??new t(3);return B[0]=u[0]-g[0],B[1]=u[1]-g[1],B[2]=u[2]-g[2],B}const R=x;function D(u,g){return Math.abs(u[0]-g[0])<EPSILON&&Math.abs(u[1]-g[1])<EPSILON&&Math.abs(u[2]-g[2])<EPSILON}function O(u,g){return u[0]===g[0]&&u[1]===g[1]&&u[2]===g[2]}function U(u,g,C,B){const I=B??new t(3);return I[0]=u[0]+C*(g[0]-u[0]),I[1]=u[1]+C*(g[1]-u[1]),I[2]=u[2]+C*(g[2]-u[2]),I}function H(u,g,C,B){const I=B??new t(3);return I[0]=u[0]+C[0]*(g[0]-u[0]),I[1]=u[1]+C[1]*(g[1]-u[1]),I[2]=u[2]+C[2]*(g[2]-u[2]),I}function $(u,g,C){const B=C??new t(3);return B[0]=Math.max(u[0],g[0]),B[1]=Math.max(u[1],g[1]),B[2]=Math.max(u[2],g[2]),B}function X(u,g,C){const B=C??new t(3);return B[0]=Math.min(u[0],g[0]),B[1]=Math.min(u[1],g[1]),B[2]=Math.min(u[2],g[2]),B}function V(u,g,C){const B=C??new t(3);return B[0]=u[0]*g,B[1]=u[1]*g,B[2]=u[2]*g,B}const q=V;function te(u,g,C){const B=C??new t(3);return B[0]=u[0]/g,B[1]=u[1]/g,B[2]=u[2]/g,B}function be(u,g){const C=g??new t(3);return C[0]=1/u[0],C[1]=1/u[1],C[2]=1/u[2],C}const Ie=be;function Ee(u,g,C){const B=C??new t(3),I=u[2]*g[0]-u[0]*g[2],M=u[0]*g[1]-u[1]*g[0];return B[0]=u[1]*g[2]-u[2]*g[1],B[1]=I,B[2]=M,B}function we(u,g){return u[0]*g[0]+u[1]*g[1]+u[2]*g[2]}function oe(u){const g=u[0],C=u[1],B=u[2];return Math.sqrt(g*g+C*C+B*B)}const Ge=oe;function ge(u){const g=u[0],C=u[1],B=u[2];return g*g+C*C+B*B}const Re=ge;function ae(u,g){const C=u[0]-g[0],B=u[1]-g[1],I=u[2]-g[2];return Math.sqrt(C*C+B*B+I*I)}const Y=ae;function Q(u,g){const C=u[0]-g[0],B=u[1]-g[1],I=u[2]-g[2];return C*C+B*B+I*I}const j=Q;function pe(u,g){const C=g??new t(3),B=u[0],I=u[1],M=u[2],G=Math.sqrt(B*B+I*I+M*M);return G>1e-5?(C[0]=B/G,C[1]=I/G,C[2]=M/G):(C[0]=0,C[1]=0,C[2]=0),C}function Le(u,g){const C=g??new t(3);return C[0]=-u[0],C[1]=-u[1],C[2]=-u[2],C}function ee(u,g){const C=g??new t(3);return C[0]=u[0],C[1]=u[1],C[2]=u[2],C}const De=ee;function ye(u,g,C){const B=C??new t(3);return B[0]=u[0]*g[0],B[1]=u[1]*g[1],B[2]=u[2]*g[2],B}const Pe=ye;function Ce(u,g,C){const B=C??new t(3);return B[0]=u[0]/g[0],B[1]=u[1]/g[1],B[2]=u[2]/g[2],B}const xe=Ce;function Me(u=1,g){const C=g??new t(3),B=Math.random()*2*Math.PI,I=Math.random()*2-1,M=Math.sqrt(1-I*I)*u;return C[0]=Math.cos(B)*M,C[1]=Math.sin(B)*M,C[2]=I*u,C}function S(u){const g=u??new t(3);return g[0]=0,g[1]=0,g[2]=0,g}function L(u,g,C){const B=C??new t(3),I=u[0],M=u[1],G=u[2],N=g[3]*I+g[7]*M+g[11]*G+g[15]||1;return B[0]=(g[0]*I+g[4]*M+g[8]*G+g[12])/N,B[1]=(g[1]*I+g[5]*M+g[9]*G+g[13])/N,B[2]=(g[2]*I+g[6]*M+g[10]*G+g[14])/N,B}function y(u,g,C){const B=C??new t(3),I=u[0],M=u[1],G=u[2];return B[0]=I*g[0]+M*g[4]+G*g[8],B[1]=I*g[1]+M*g[5]+G*g[9],B[2]=I*g[2]+M*g[6]+G*g[10],B}function c(u,g,C){const B=C??new t(3),I=u[0],M=u[1],G=u[2];return B[0]=I*g[0]+M*g[4]+G*g[8],B[1]=I*g[1]+M*g[5]+G*g[9],B[2]=I*g[2]+M*g[6]+G*g[10],B}function p(u,g,C){const B=C??new t(3),I=g[0],M=g[1],G=g[2],N=g[3]*2,P=u[0],F=u[1],k=u[2],K=M*k-G*F,J=G*P-I*k,z=I*F-M*P;return B[0]=P+K*N+(M*z-G*J)*2,B[1]=F+J*N+(G*K-I*z)*2,B[2]=k+z*N+(I*J-M*K)*2,B}function f(u,g){const C=g??new t(3);return C[0]=u[12],C[1]=u[13],C[2]=u[14],C}function _(u,g,C){const B=C??new t(3),I=g*4;return B[0]=u[I+0],B[1]=u[I+1],B[2]=u[I+2],B}function b(u,g){const C=g??new t(3),B=u[0],I=u[1],M=u[2],G=u[4],N=u[5],P=u[6],F=u[8],k=u[9],K=u[10];return C[0]=Math.sqrt(B*B+I*I+M*M),C[1]=Math.sqrt(G*G+N*N+P*P),C[2]=Math.sqrt(F*F+k*k+K*K),C}function w(u,g,C,B){const I=B??new t(3),M=[],G=[];return M[0]=u[0]-g[0],M[1]=u[1]-g[1],M[2]=u[2]-g[2],G[0]=M[0],G[1]=M[1]*Math.cos(C)-M[2]*Math.sin(C),G[2]=M[1]*Math.sin(C)+M[2]*Math.cos(C),I[0]=G[0]+g[0],I[1]=G[1]+g[1],I[2]=G[2]+g[2],I}function T(u,g,C,B){const I=B??new t(3),M=[],G=[];return M[0]=u[0]-g[0],M[1]=u[1]-g[1],M[2]=u[2]-g[2],G[0]=M[2]*Math.sin(C)+M[0]*Math.cos(C),G[1]=M[1],G[2]=M[2]*Math.cos(C)-M[0]*Math.sin(C),I[0]=G[0]+g[0],I[1]=G[1]+g[1],I[2]=G[2]+g[2],I}function s(u,g,C,B){const I=B??new t(3),M=[],G=[];return M[0]=u[0]-g[0],M[1]=u[1]-g[1],M[2]=u[2]-g[2],G[0]=M[0]*Math.cos(C)-M[1]*Math.sin(C),G[1]=M[0]*Math.sin(C)+M[1]*Math.cos(C),G[2]=M[2],I[0]=G[0]+g[0],I[1]=G[1]+g[1],I[2]=G[2]+g[2],I}function m(u,g,C){const B=C??new t(3);return pe(u,B),V(B,g,B)}function d(u,g,C){const B=C??new t(3);return oe(u)>g?m(u,g,B):ee(u,B)}function h(u,g,C){const B=C??new t(3);return U(u,g,.5,B)}return{create:e,fromValues:n,set:r,ceil:i,floor:o,round:a,clamp:l,add:A,addScaled:E,angle:v,subtract:x,sub:R,equalsApproximately:D,equals:O,lerp:U,lerpV:H,max:$,min:X,mulScalar:V,scale:q,divScalar:te,inverse:be,invert:Ie,cross:Ee,dot:we,length:oe,len:Ge,lengthSq:ge,lenSq:Re,distance:ae,dist:Y,distanceSq:Q,distSq:j,normalize:pe,negate:Le,copy:ee,clone:De,multiply:ye,mul:Pe,divide:Ce,div:xe,random:Me,zero:S,transformMat4:L,transformMat4Upper3x3:y,transformMat3:c,transformQuat:p,getTranslation:f,getAxis:_,getScaling:b,rotateX:w,rotateY:T,rotateZ:s,setLength:m,truncate:d,midpoint:h}}const cache$4=new Map;function getAPI$4(t){let e=cache$4.get(t);return e||(e=getAPIImpl$4(t),cache$4.set(t,e)),e}function getAPIImpl$3(t){const e=getAPI$5(t),n=getAPI$4(t);function r(c,p,f,_,b,w,T,s,m){const d=new t(12);return d[3]=0,d[7]=0,d[11]=0,c!==void 0&&(d[0]=c,p!==void 0&&(d[1]=p,f!==void 0&&(d[2]=f,_!==void 0&&(d[4]=_,b!==void 0&&(d[5]=b,w!==void 0&&(d[6]=w,T!==void 0&&(d[8]=T,s!==void 0&&(d[9]=s,m!==void 0&&(d[10]=m))))))))),d}function i(c,p,f,_,b,w,T,s,m,d){const h=d??new t(12);return h[0]=c,h[1]=p,h[2]=f,h[3]=0,h[4]=_,h[5]=b,h[6]=w,h[7]=0,h[8]=T,h[9]=s,h[10]=m,h[11]=0,h}function o(c,p){const f=p??new t(12);return f[0]=c[0],f[1]=c[1],f[2]=c[2],f[3]=0,f[4]=c[4],f[5]=c[5],f[6]=c[6],f[7]=0,f[8]=c[8],f[9]=c[9],f[10]=c[10],f[11]=0,f}function a(c,p){const f=p??new t(12),_=c[0],b=c[1],w=c[2],T=c[3],s=_+_,m=b+b,d=w+w,h=_*s,u=b*s,g=b*m,C=w*s,B=w*m,I=w*d,M=T*s,G=T*m,N=T*d;return f[0]=1-g-I,f[1]=u+N,f[2]=C-G,f[3]=0,f[4]=u-N,f[5]=1-h-I,f[6]=B+M,f[7]=0,f[8]=C+G,f[9]=B-M,f[10]=1-h-g,f[11]=0,f}function l(c,p){const f=p??new t(12);return f[0]=-c[0],f[1]=-c[1],f[2]=-c[2],f[4]=-c[4],f[5]=-c[5],f[6]=-c[6],f[8]=-c[8],f[9]=-c[9],f[10]=-c[10],f}function A(c,p,f){const _=f??new t(12);return _[0]=c[0]*p,_[1]=c[1]*p,_[2]=c[2]*p,_[4]=c[4]*p,_[5]=c[5]*p,_[6]=c[6]*p,_[8]=c[8]*p,_[9]=c[9]*p,_[10]=c[10]*p,_}const E=A;function v(c,p,f){const _=f??new t(12);return _[0]=c[0]+p[0],_[1]=c[1]+p[1],_[2]=c[2]+p[2],_[4]=c[4]+p[4],_[5]=c[5]+p[5],_[6]=c[6]+p[6],_[8]=c[8]+p[8],_[9]=c[9]+p[9],_[10]=c[10]+p[10],_}function x(c,p){const f=p??new t(12);return f[0]=c[0],f[1]=c[1],f[2]=c[2],f[4]=c[4],f[5]=c[5],f[6]=c[6],f[8]=c[8],f[9]=c[9],f[10]=c[10],f}const R=x;function D(c,p){return Math.abs(c[0]-p[0])<EPSILON&&Math.abs(c[1]-p[1])<EPSILON&&Math.abs(c[2]-p[2])<EPSILON&&Math.abs(c[4]-p[4])<EPSILON&&Math.abs(c[5]-p[5])<EPSILON&&Math.abs(c[6]-p[6])<EPSILON&&Math.abs(c[8]-p[8])<EPSILON&&Math.abs(c[9]-p[9])<EPSILON&&Math.abs(c[10]-p[10])<EPSILON}function O(c,p){return c[0]===p[0]&&c[1]===p[1]&&c[2]===p[2]&&c[4]===p[4]&&c[5]===p[5]&&c[6]===p[6]&&c[8]===p[8]&&c[9]===p[9]&&c[10]===p[10]}function U(c){const p=c??new t(12);return p[0]=1,p[1]=0,p[2]=0,p[4]=0,p[5]=1,p[6]=0,p[8]=0,p[9]=0,p[10]=1,p}function H(c,p){const f=p??new t(12);if(f===c){let g;return g=c[1],c[1]=c[4],c[4]=g,g=c[2],c[2]=c[8],c[8]=g,g=c[6],c[6]=c[9],c[9]=g,f}const _=c[0],b=c[1],w=c[2],T=c[4],s=c[5],m=c[6],d=c[8],h=c[9],u=c[10];return f[0]=_,f[1]=T,f[2]=d,f[4]=b,f[5]=s,f[6]=h,f[8]=w,f[9]=m,f[10]=u,f}function $(c,p){const f=p??new t(12),_=c[0],b=c[1],w=c[2],T=c[4],s=c[5],m=c[6],d=c[8],h=c[9],u=c[10],g=u*s-m*h,C=-u*T+m*d,B=h*T-s*d,I=1/(_*g+b*C+w*B);return f[0]=g*I,f[1]=(-u*b+w*h)*I,f[2]=(m*b-w*s)*I,f[4]=C*I,f[5]=(u*_-w*d)*I,f[6]=(-m*_+w*T)*I,f[8]=B*I,f[9]=(-h*_+b*d)*I,f[10]=(s*_-b*T)*I,f}function X(c){const p=c[0],f=c[1],_=c[2],b=c[4],w=c[5],T=c[6],s=c[8],m=c[9],d=c[10];return p*(w*d-m*T)-b*(f*d-m*_)+s*(f*T-w*_)}const V=$;function q(c,p,f){const _=f??new t(12),b=c[0],w=c[1],T=c[2],s=c[4],m=c[5],d=c[6],h=c[8],u=c[9],g=c[10],C=p[0],B=p[1],I=p[2],M=p[4],G=p[5],N=p[6],P=p[8],F=p[9],k=p[10];return _[0]=b*C+s*B+h*I,_[1]=w*C+m*B+u*I,_[2]=T*C+d*B+g*I,_[4]=b*M+s*G+h*N,_[5]=w*M+m*G+u*N,_[6]=T*M+d*G+g*N,_[8]=b*P+s*F+h*k,_[9]=w*P+m*F+u*k,_[10]=T*P+d*F+g*k,_}const te=q;function be(c,p,f){const _=f??U();return c!==_&&(_[0]=c[0],_[1]=c[1],_[2]=c[2],_[4]=c[4],_[5]=c[5],_[6]=c[6]),_[8]=p[0],_[9]=p[1],_[10]=1,_}function Ie(c,p){const f=p??e.create();return f[0]=c[8],f[1]=c[9],f}function Ee(c,p,f){const _=f??e.create(),b=p*4;return _[0]=c[b+0],_[1]=c[b+1],_}function we(c,p,f,_){const b=_===c?c:x(c,_),w=f*4;return b[w+0]=p[0],b[w+1]=p[1],b}function oe(c,p){const f=p??e.create(),_=c[0],b=c[1],w=c[4],T=c[5];return f[0]=Math.sqrt(_*_+b*b),f[1]=Math.sqrt(w*w+T*T),f}function Ge(c,p){const f=p??n.create(),_=c[0],b=c[1],w=c[2],T=c[4],s=c[5],m=c[6],d=c[8],h=c[9],u=c[10];return f[0]=Math.sqrt(_*_+b*b+w*w),f[1]=Math.sqrt(T*T+s*s+m*m),f[2]=Math.sqrt(d*d+h*h+u*u),f}function ge(c,p){const f=p??new t(12);return f[0]=1,f[1]=0,f[2]=0,f[4]=0,f[5]=1,f[6]=0,f[8]=c[0],f[9]=c[1],f[10]=1,f}function Re(c,p,f){const _=f??new t(12),b=p[0],w=p[1],T=c[0],s=c[1],m=c[2],d=c[4],h=c[5],u=c[6],g=c[8],C=c[9],B=c[10];return c!==_&&(_[0]=T,_[1]=s,_[2]=m,_[4]=d,_[5]=h,_[6]=u),_[8]=T*b+d*w+g,_[9]=s*b+h*w+C,_[10]=m*b+u*w+B,_}function ae(c,p){const f=p??new t(12),_=Math.cos(c),b=Math.sin(c);return f[0]=_,f[1]=b,f[2]=0,f[4]=-b,f[5]=_,f[6]=0,f[8]=0,f[9]=0,f[10]=1,f}function Y(c,p,f){const _=f??new t(12),b=c[0],w=c[1],T=c[2],s=c[4],m=c[5],d=c[6],h=Math.cos(p),u=Math.sin(p);return _[0]=h*b+u*s,_[1]=h*w+u*m,_[2]=h*T+u*d,_[4]=h*s-u*b,_[5]=h*m-u*w,_[6]=h*d-u*T,c!==_&&(_[8]=c[8],_[9]=c[9],_[10]=c[10]),_}function Q(c,p){const f=p??new t(12),_=Math.cos(c),b=Math.sin(c);return f[0]=1,f[1]=0,f[2]=0,f[4]=0,f[5]=_,f[6]=b,f[8]=0,f[9]=-b,f[10]=_,f}function j(c,p,f){const _=f??new t(12),b=c[4],w=c[5],T=c[6],s=c[8],m=c[9],d=c[10],h=Math.cos(p),u=Math.sin(p);return _[4]=h*b+u*s,_[5]=h*w+u*m,_[6]=h*T+u*d,_[8]=h*s-u*b,_[9]=h*m-u*w,_[10]=h*d-u*T,c!==_&&(_[0]=c[0],_[1]=c[1],_[2]=c[2]),_}function pe(c,p){const f=p??new t(12),_=Math.cos(c),b=Math.sin(c);return f[0]=_,f[1]=0,f[2]=-b,f[4]=0,f[5]=1,f[6]=0,f[8]=b,f[9]=0,f[10]=_,f}function Le(c,p,f){const _=f??new t(12),b=c[0],w=c[1],T=c[2],s=c[8],m=c[9],d=c[10],h=Math.cos(p),u=Math.sin(p);return _[0]=h*b-u*s,_[1]=h*w-u*m,_[2]=h*T-u*d,_[8]=h*s+u*b,_[9]=h*m+u*w,_[10]=h*d+u*T,c!==_&&(_[4]=c[4],_[5]=c[5],_[6]=c[6]),_}const ee=ae,De=Y;function ye(c,p){const f=p??new t(12);return f[0]=c[0],f[1]=0,f[2]=0,f[4]=0,f[5]=c[1],f[6]=0,f[8]=0,f[9]=0,f[10]=1,f}function Pe(c,p,f){const _=f??new t(12),b=p[0],w=p[1];return _[0]=b*c[0],_[1]=b*c[1],_[2]=b*c[2],_[4]=w*c[4],_[5]=w*c[5],_[6]=w*c[6],c!==_&&(_[8]=c[8],_[9]=c[9],_[10]=c[10]),_}function Ce(c,p){const f=p??new t(12);return f[0]=c[0],f[1]=0,f[2]=0,f[4]=0,f[5]=c[1],f[6]=0,f[8]=0,f[9]=0,f[10]=c[2],f}function xe(c,p,f){const _=f??new t(12),b=p[0],w=p[1],T=p[2];return _[0]=b*c[0],_[1]=b*c[1],_[2]=b*c[2],_[4]=w*c[4],_[5]=w*c[5],_[6]=w*c[6],_[8]=T*c[8],_[9]=T*c[9],_[10]=T*c[10],_}function Me(c,p){const f=p??new t(12);return f[0]=c,f[1]=0,f[2]=0,f[4]=0,f[5]=c,f[6]=0,f[8]=0,f[9]=0,f[10]=1,f}function S(c,p,f){const _=f??new t(12);return _[0]=p*c[0],_[1]=p*c[1],_[2]=p*c[2],_[4]=p*c[4],_[5]=p*c[5],_[6]=p*c[6],c!==_&&(_[8]=c[8],_[9]=c[9],_[10]=c[10]),_}function L(c,p){const f=p??new t(12);return f[0]=c,f[1]=0,f[2]=0,f[4]=0,f[5]=c,f[6]=0,f[8]=0,f[9]=0,f[10]=c,f}function y(c,p,f){const _=f??new t(12);return _[0]=p*c[0],_[1]=p*c[1],_[2]=p*c[2],_[4]=p*c[4],_[5]=p*c[5],_[6]=p*c[6],_[8]=p*c[8],_[9]=p*c[9],_[10]=p*c[10],_}return{add:v,clone:R,copy:x,create:r,determinant:X,equals:O,equalsApproximately:D,fromMat4:o,fromQuat:a,get3DScaling:Ge,getAxis:Ee,getScaling:oe,getTranslation:Ie,identity:U,inverse:$,invert:V,mul:te,mulScalar:E,multiply:q,multiplyScalar:A,negate:l,rotate:Y,rotateX:j,rotateY:Le,rotateZ:De,rotation:ae,rotationX:Q,rotationY:pe,rotationZ:ee,scale:Pe,scale3D:xe,scaling:ye,scaling3D:Ce,set:i,setAxis:we,setTranslation:be,translate:Re,translation:ge,transpose:H,uniformScale:S,uniformScale3D:y,uniformScaling:Me,uniformScaling3D:L}}const cache$3=new Map;function getAPI$3(t){let e=cache$3.get(t);return e||(e=getAPIImpl$3(t),cache$3.set(t,e)),e}function getAPIImpl$2(t){const e=getAPI$4(t);function n(s,m,d,h,u,g,C,B,I,M,G,N,P,F,k,K){const J=new t(16);return s!==void 0&&(J[0]=s,m!==void 0&&(J[1]=m,d!==void 0&&(J[2]=d,h!==void 0&&(J[3]=h,u!==void 0&&(J[4]=u,g!==void 0&&(J[5]=g,C!==void 0&&(J[6]=C,B!==void 0&&(J[7]=B,I!==void 0&&(J[8]=I,M!==void 0&&(J[9]=M,G!==void 0&&(J[10]=G,N!==void 0&&(J[11]=N,P!==void 0&&(J[12]=P,F!==void 0&&(J[13]=F,k!==void 0&&(J[14]=k,K!==void 0&&(J[15]=K)))))))))))))))),J}function r(s,m,d,h,u,g,C,B,I,M,G,N,P,F,k,K,J){const z=J??new t(16);return z[0]=s,z[1]=m,z[2]=d,z[3]=h,z[4]=u,z[5]=g,z[6]=C,z[7]=B,z[8]=I,z[9]=M,z[10]=G,z[11]=N,z[12]=P,z[13]=F,z[14]=k,z[15]=K,z}function i(s,m){const d=m??new t(16);return d[0]=s[0],d[1]=s[1],d[2]=s[2],d[3]=0,d[4]=s[4],d[5]=s[5],d[6]=s[6],d[7]=0,d[8]=s[8],d[9]=s[9],d[10]=s[10],d[11]=0,d[12]=0,d[13]=0,d[14]=0,d[15]=1,d}function o(s,m){const d=m??new t(16),h=s[0],u=s[1],g=s[2],C=s[3],B=h+h,I=u+u,M=g+g,G=h*B,N=u*B,P=u*I,F=g*B,k=g*I,K=g*M,J=C*B,z=C*I,Z=C*M;return d[0]=1-P-K,d[1]=N+Z,d[2]=F-z,d[3]=0,d[4]=N-Z,d[5]=1-G-K,d[6]=k+J,d[7]=0,d[8]=F+z,d[9]=k-J,d[10]=1-G-P,d[11]=0,d[12]=0,d[13]=0,d[14]=0,d[15]=1,d}function a(s,m){const d=m??new t(16);return d[0]=-s[0],d[1]=-s[1],d[2]=-s[2],d[3]=-s[3],d[4]=-s[4],d[5]=-s[5],d[6]=-s[6],d[7]=-s[7],d[8]=-s[8],d[9]=-s[9],d[10]=-s[10],d[11]=-s[11],d[12]=-s[12],d[13]=-s[13],d[14]=-s[14],d[15]=-s[15],d}function l(s,m,d){const h=d??new t(16);return h[0]=s[0]+m[0],h[1]=s[1]+m[1],h[2]=s[2]+m[2],h[3]=s[3]+m[3],h[4]=s[4]+m[4],h[5]=s[5]+m[5],h[6]=s[6]+m[6],h[7]=s[7]+m[7],h[8]=s[8]+m[8],h[9]=s[9]+m[9],h[10]=s[10]+m[10],h[11]=s[11]+m[11],h[12]=s[12]+m[12],h[13]=s[13]+m[13],h[14]=s[14]+m[14],h[15]=s[15]+m[15],h}function A(s,m,d){const h=d??new t(16);return h[0]=s[0]*m,h[1]=s[1]*m,h[2]=s[2]*m,h[3]=s[3]*m,h[4]=s[4]*m,h[5]=s[5]*m,h[6]=s[6]*m,h[7]=s[7]*m,h[8]=s[8]*m,h[9]=s[9]*m,h[10]=s[10]*m,h[11]=s[11]*m,h[12]=s[12]*m,h[13]=s[13]*m,h[14]=s[14]*m,h[15]=s[15]*m,h}const E=A;function v(s,m){const d=m??new t(16);return d[0]=s[0],d[1]=s[1],d[2]=s[2],d[3]=s[3],d[4]=s[4],d[5]=s[5],d[6]=s[6],d[7]=s[7],d[8]=s[8],d[9]=s[9],d[10]=s[10],d[11]=s[11],d[12]=s[12],d[13]=s[13],d[14]=s[14],d[15]=s[15],d}const x=v;function R(s,m){return Math.abs(s[0]-m[0])<EPSILON&&Math.abs(s[1]-m[1])<EPSILON&&Math.abs(s[2]-m[2])<EPSILON&&Math.abs(s[3]-m[3])<EPSILON&&Math.abs(s[4]-m[4])<EPSILON&&Math.abs(s[5]-m[5])<EPSILON&&Math.abs(s[6]-m[6])<EPSILON&&Math.abs(s[7]-m[7])<EPSILON&&Math.abs(s[8]-m[8])<EPSILON&&Math.abs(s[9]-m[9])<EPSILON&&Math.abs(s[10]-m[10])<EPSILON&&Math.abs(s[11]-m[11])<EPSILON&&Math.abs(s[12]-m[12])<EPSILON&&Math.abs(s[13]-m[13])<EPSILON&&Math.abs(s[14]-m[14])<EPSILON&&Math.abs(s[15]-m[15])<EPSILON}function D(s,m){return s[0]===m[0]&&s[1]===m[1]&&s[2]===m[2]&&s[3]===m[3]&&s[4]===m[4]&&s[5]===m[5]&&s[6]===m[6]&&s[7]===m[7]&&s[8]===m[8]&&s[9]===m[9]&&s[10]===m[10]&&s[11]===m[11]&&s[12]===m[12]&&s[13]===m[13]&&s[14]===m[14]&&s[15]===m[15]}function O(s){const m=s??new t(16);return m[0]=1,m[1]=0,m[2]=0,m[3]=0,m[4]=0,m[5]=1,m[6]=0,m[7]=0,m[8]=0,m[9]=0,m[10]=1,m[11]=0,m[12]=0,m[13]=0,m[14]=0,m[15]=1,m}function U(s,m){const d=m??new t(16);if(d===s){let W;return W=s[1],s[1]=s[4],s[4]=W,W=s[2],s[2]=s[8],s[8]=W,W=s[3],s[3]=s[12],s[12]=W,W=s[6],s[6]=s[9],s[9]=W,W=s[7],s[7]=s[13],s[13]=W,W=s[11],s[11]=s[14],s[14]=W,d}const h=s[0],u=s[1],g=s[2],C=s[3],B=s[4],I=s[5],M=s[6],G=s[7],N=s[8],P=s[9],F=s[10],k=s[11],K=s[12],J=s[13],z=s[14],Z=s[15];return d[0]=h,d[1]=B,d[2]=N,d[3]=K,d[4]=u,d[5]=I,d[6]=P,d[7]=J,d[8]=g,d[9]=M,d[10]=F,d[11]=z,d[12]=C,d[13]=G,d[14]=k,d[15]=Z,d}function H(s,m){const d=m??new t(16),h=s[0],u=s[1],g=s[2],C=s[3],B=s[4],I=s[5],M=s[6],G=s[7],N=s[8],P=s[9],F=s[10],k=s[11],K=s[12],J=s[13],z=s[14],Z=s[15],W=F*Z,ne=z*k,re=M*Z,ie=z*G,se=M*k,ce=F*G,ue=g*Z,le=z*C,de=g*k,fe=F*C,me=g*G,Ae=M*C,_e=N*J,Be=K*P,Te=B*J,ve=K*I,Se=B*P,Fe=N*I,Oe=h*J,Ue=K*u,Ne=h*P,He=N*u,ke=h*I,Je=B*u,Ve=W*I+ie*P+se*J-(ne*I+re*P+ce*J),ze=ne*u+ue*P+fe*J-(W*u+le*P+de*J),$e=re*u+le*I+me*J-(ie*u+ue*I+Ae*J),Ke=ce*u+de*I+Ae*P-(se*u+fe*I+me*P),he=1/(h*Ve+B*ze+N*$e+K*Ke);return d[0]=he*Ve,d[1]=he*ze,d[2]=he*$e,d[3]=he*Ke,d[4]=he*(ne*B+re*N+ce*K-(W*B+ie*N+se*K)),d[5]=he*(W*h+le*N+de*K-(ne*h+ue*N+fe*K)),d[6]=he*(ie*h+ue*B+Ae*K-(re*h+le*B+me*K)),d[7]=he*(se*h+fe*B+me*N-(ce*h+de*B+Ae*N)),d[8]=he*(_e*G+ve*k+Se*Z-(Be*G+Te*k+Fe*Z)),d[9]=he*(Be*C+Oe*k+He*Z-(_e*C+Ue*k+Ne*Z)),d[10]=he*(Te*C+Ue*G+ke*Z-(ve*C+Oe*G+Je*Z)),d[11]=he*(Fe*C+Ne*G+Je*k-(Se*C+He*G+ke*k)),d[12]=he*(Te*F+Fe*z+Be*M-(Se*z+_e*M+ve*F)),d[13]=he*(Ne*z+_e*g+Ue*F-(Oe*F+He*z+Be*g)),d[14]=he*(Oe*M+Je*z+ve*g-(ke*z+Te*g+Ue*M)),d[15]=he*(ke*F+Se*g+He*M-(Ne*M+Je*F+Fe*g)),d}function $(s){const m=s[0],d=s[1],h=s[2],u=s[3],g=s[4],C=s[5],B=s[6],I=s[7],M=s[8],G=s[9],N=s[10],P=s[11],F=s[12],k=s[13],K=s[14],J=s[15],z=N*J,Z=K*P,W=B*J,ne=K*I,re=B*P,ie=N*I,se=h*J,ce=K*u,ue=h*P,le=N*u,de=h*I,fe=B*u,me=z*C+ne*G+re*k-(Z*C+W*G+ie*k),Ae=Z*d+se*G+le*k-(z*d+ce*G+ue*k),_e=W*d+ce*C+de*k-(ne*d+se*C+fe*k),Be=ie*d+ue*C+fe*G-(re*d+le*C+de*G);return m*me+g*Ae+M*_e+F*Be}const X=H;function V(s,m,d){const h=d??new t(16),u=s[0],g=s[1],C=s[2],B=s[3],I=s[4],M=s[5],G=s[6],N=s[7],P=s[8],F=s[9],k=s[10],K=s[11],J=s[12],z=s[13],Z=s[14],W=s[15],ne=m[0],re=m[1],ie=m[2],se=m[3],ce=m[4],ue=m[5],le=m[6],de=m[7],fe=m[8],me=m[9],Ae=m[10],_e=m[11],Be=m[12],Te=m[13],ve=m[14],Se=m[15];return h[0]=u*ne+I*re+P*ie+J*se,h[1]=g*ne+M*re+F*ie+z*se,h[2]=C*ne+G*re+k*ie+Z*se,h[3]=B*ne+N*re+K*ie+W*se,h[4]=u*ce+I*ue+P*le+J*de,h[5]=g*ce+M*ue+F*le+z*de,h[6]=C*ce+G*ue+k*le+Z*de,h[7]=B*ce+N*ue+K*le+W*de,h[8]=u*fe+I*me+P*Ae+J*_e,h[9]=g*fe+M*me+F*Ae+z*_e,h[10]=C*fe+G*me+k*Ae+Z*_e,h[11]=B*fe+N*me+K*Ae+W*_e,h[12]=u*Be+I*Te+P*ve+J*Se,h[13]=g*Be+M*Te+F*ve+z*Se,h[14]=C*Be+G*Te+k*ve+Z*Se,h[15]=B*Be+N*Te+K*ve+W*Se,h}const q=V;function te(s,m,d){const h=d??O();return s!==h&&(h[0]=s[0],h[1]=s[1],h[2]=s[2],h[3]=s[3],h[4]=s[4],h[5]=s[5],h[6]=s[6],h[7]=s[7],h[8]=s[8],h[9]=s[9],h[10]=s[10],h[11]=s[11]),h[12]=m[0],h[13]=m[1],h[14]=m[2],h[15]=1,h}function be(s,m){const d=m??e.create();return d[0]=s[12],d[1]=s[13],d[2]=s[14],d}function Ie(s,m,d){const h=d??e.create(),u=m*4;return h[0]=s[u+0],h[1]=s[u+1],h[2]=s[u+2],h}function Ee(s,m,d,h){const u=h===s?h:v(s,h),g=d*4;return u[g+0]=m[0],u[g+1]=m[1],u[g+2]=m[2],u}function we(s,m){const d=m??e.create(),h=s[0],u=s[1],g=s[2],C=s[4],B=s[5],I=s[6],M=s[8],G=s[9],N=s[10];return d[0]=Math.sqrt(h*h+u*u+g*g),d[1]=Math.sqrt(C*C+B*B+I*I),d[2]=Math.sqrt(M*M+G*G+N*N),d}function oe(s,m,d,h,u){const g=u??new t(16),C=Math.tan(Math.PI*.5-.5*s);if(g[0]=C/m,g[1]=0,g[2]=0,g[3]=0,g[4]=0,g[5]=C,g[6]=0,g[7]=0,g[8]=0,g[9]=0,g[11]=-1,g[12]=0,g[13]=0,g[15]=0,Number.isFinite(h)){const B=1/(d-h);g[10]=h*B,g[14]=h*d*B}else g[10]=-1,g[14]=-d;return g}function Ge(s,m,d,h=1/0,u){const g=u??new t(16),C=1/Math.tan(s*.5);if(g[0]=C/m,g[1]=0,g[2]=0,g[3]=0,g[4]=0,g[5]=C,g[6]=0,g[7]=0,g[8]=0,g[9]=0,g[11]=-1,g[12]=0,g[13]=0,g[15]=0,h===1/0)g[10]=0,g[14]=d;else{const B=1/(h-d);g[10]=d*B,g[14]=h*d*B}return g}function ge(s,m,d,h,u,g,C){const B=C??new t(16);return B[0]=2/(m-s),B[1]=0,B[2]=0,B[3]=0,B[4]=0,B[5]=2/(h-d),B[6]=0,B[7]=0,B[8]=0,B[9]=0,B[10]=1/(u-g),B[11]=0,B[12]=(m+s)/(s-m),B[13]=(h+d)/(d-h),B[14]=u/(u-g),B[15]=1,B}function Re(s,m,d,h,u,g,C){const B=C??new t(16),I=m-s,M=h-d,G=u-g;return B[0]=2*u/I,B[1]=0,B[2]=0,B[3]=0,B[4]=0,B[5]=2*u/M,B[6]=0,B[7]=0,B[8]=(s+m)/I,B[9]=(h+d)/M,B[10]=g/G,B[11]=-1,B[12]=0,B[13]=0,B[14]=u*g/G,B[15]=0,B}function ae(s,m,d,h,u,g=1/0,C){const B=C??new t(16),I=m-s,M=h-d;if(B[0]=2*u/I,B[1]=0,B[2]=0,B[3]=0,B[4]=0,B[5]=2*u/M,B[6]=0,B[7]=0,B[8]=(s+m)/I,B[9]=(h+d)/M,B[11]=-1,B[12]=0,B[13]=0,B[15]=0,g===1/0)B[10]=0,B[14]=u;else{const G=1/(g-u);B[10]=u*G,B[14]=g*u*G}return B}const Y=e.create(),Q=e.create(),j=e.create();function pe(s,m,d,h){const u=h??new t(16);return e.normalize(e.subtract(m,s,j),j),e.normalize(e.cross(d,j,Y),Y),e.normalize(e.cross(j,Y,Q),Q),u[0]=Y[0],u[1]=Y[1],u[2]=Y[2],u[3]=0,u[4]=Q[0],u[5]=Q[1],u[6]=Q[2],u[7]=0,u[8]=j[0],u[9]=j[1],u[10]=j[2],u[11]=0,u[12]=s[0],u[13]=s[1],u[14]=s[2],u[15]=1,u}function Le(s,m,d,h){const u=h??new t(16);return e.normalize(e.subtract(s,m,j),j),e.normalize(e.cross(d,j,Y),Y),e.normalize(e.cross(j,Y,Q),Q),u[0]=Y[0],u[1]=Y[1],u[2]=Y[2],u[3]=0,u[4]=Q[0],u[5]=Q[1],u[6]=Q[2],u[7]=0,u[8]=j[0],u[9]=j[1],u[10]=j[2],u[11]=0,u[12]=s[0],u[13]=s[1],u[14]=s[2],u[15]=1,u}function ee(s,m,d,h){const u=h??new t(16);return e.normalize(e.subtract(s,m,j),j),e.normalize(e.cross(d,j,Y),Y),e.normalize(e.cross(j,Y,Q),Q),u[0]=Y[0],u[1]=Q[0],u[2]=j[0],u[3]=0,u[4]=Y[1],u[5]=Q[1],u[6]=j[1],u[7]=0,u[8]=Y[2],u[9]=Q[2],u[10]=j[2],u[11]=0,u[12]=-(Y[0]*s[0]+Y[1]*s[1]+Y[2]*s[2]),u[13]=-(Q[0]*s[0]+Q[1]*s[1]+Q[2]*s[2]),u[14]=-(j[0]*s[0]+j[1]*s[1]+j[2]*s[2]),u[15]=1,u}function De(s,m){const d=m??new t(16);return d[0]=1,d[1]=0,d[2]=0,d[3]=0,d[4]=0,d[5]=1,d[6]=0,d[7]=0,d[8]=0,d[9]=0,d[10]=1,d[11]=0,d[12]=s[0],d[13]=s[1],d[14]=s[2],d[15]=1,d}function ye(s,m,d){const h=d??new t(16),u=m[0],g=m[1],C=m[2],B=s[0],I=s[1],M=s[2],G=s[3],N=s[4],P=s[5],F=s[6],k=s[7],K=s[8],J=s[9],z=s[10],Z=s[11],W=s[12],ne=s[13],re=s[14],ie=s[15];return s!==h&&(h[0]=B,h[1]=I,h[2]=M,h[3]=G,h[4]=N,h[5]=P,h[6]=F,h[7]=k,h[8]=K,h[9]=J,h[10]=z,h[11]=Z),h[12]=B*u+N*g+K*C+W,h[13]=I*u+P*g+J*C+ne,h[14]=M*u+F*g+z*C+re,h[15]=G*u+k*g+Z*C+ie,h}function Pe(s,m){const d=m??new t(16),h=Math.cos(s),u=Math.sin(s);return d[0]=1,d[1]=0,d[2]=0,d[3]=0,d[4]=0,d[5]=h,d[6]=u,d[7]=0,d[8]=0,d[9]=-u,d[10]=h,d[11]=0,d[12]=0,d[13]=0,d[14]=0,d[15]=1,d}function Ce(s,m,d){const h=d??new t(16),u=s[4],g=s[5],C=s[6],B=s[7],I=s[8],M=s[9],G=s[10],N=s[11],P=Math.cos(m),F=Math.sin(m);return h[4]=P*u+F*I,h[5]=P*g+F*M,h[6]=P*C+F*G,h[7]=P*B+F*N,h[8]=P*I-F*u,h[9]=P*M-F*g,h[10]=P*G-F*C,h[11]=P*N-F*B,s!==h&&(h[0]=s[0],h[1]=s[1],h[2]=s[2],h[3]=s[3],h[12]=s[12],h[13]=s[13],h[14]=s[14],h[15]=s[15]),h}function xe(s,m){const d=m??new t(16),h=Math.cos(s),u=Math.sin(s);return d[0]=h,d[1]=0,d[2]=-u,d[3]=0,d[4]=0,d[5]=1,d[6]=0,d[7]=0,d[8]=u,d[9]=0,d[10]=h,d[11]=0,d[12]=0,d[13]=0,d[14]=0,d[15]=1,d}function Me(s,m,d){const h=d??new t(16),u=s[0],g=s[1],C=s[2],B=s[3],I=s[8],M=s[9],G=s[10],N=s[11],P=Math.cos(m),F=Math.sin(m);return h[0]=P*u-F*I,h[1]=P*g-F*M,h[2]=P*C-F*G,h[3]=P*B-F*N,h[8]=P*I+F*u,h[9]=P*M+F*g,h[10]=P*G+F*C,h[11]=P*N+F*B,s!==h&&(h[4]=s[4],h[5]=s[5],h[6]=s[6],h[7]=s[7],h[12]=s[12],h[13]=s[13],h[14]=s[14],h[15]=s[15]),h}function S(s,m){const d=m??new t(16),h=Math.cos(s),u=Math.sin(s);return d[0]=h,d[1]=u,d[2]=0,d[3]=0,d[4]=-u,d[5]=h,d[6]=0,d[7]=0,d[8]=0,d[9]=0,d[10]=1,d[11]=0,d[12]=0,d[13]=0,d[14]=0,d[15]=1,d}function L(s,m,d){const h=d??new t(16),u=s[0],g=s[1],C=s[2],B=s[3],I=s[4],M=s[5],G=s[6],N=s[7],P=Math.cos(m),F=Math.sin(m);return h[0]=P*u+F*I,h[1]=P*g+F*M,h[2]=P*C+F*G,h[3]=P*B+F*N,h[4]=P*I-F*u,h[5]=P*M-F*g,h[6]=P*G-F*C,h[7]=P*N-F*B,s!==h&&(h[8]=s[8],h[9]=s[9],h[10]=s[10],h[11]=s[11],h[12]=s[12],h[13]=s[13],h[14]=s[14],h[15]=s[15]),h}function y(s,m,d){const h=d??new t(16);let u=s[0],g=s[1],C=s[2];const B=Math.sqrt(u*u+g*g+C*C);u/=B,g/=B,C/=B;const I=u*u,M=g*g,G=C*C,N=Math.cos(m),P=Math.sin(m),F=1-N;return h[0]=I+(1-I)*N,h[1]=u*g*F+C*P,h[2]=u*C*F-g*P,h[3]=0,h[4]=u*g*F-C*P,h[5]=M+(1-M)*N,h[6]=g*C*F+u*P,h[7]=0,h[8]=u*C*F+g*P,h[9]=g*C*F-u*P,h[10]=G+(1-G)*N,h[11]=0,h[12]=0,h[13]=0,h[14]=0,h[15]=1,h}const c=y;function p(s,m,d,h){const u=h??new t(16);let g=m[0],C=m[1],B=m[2];const I=Math.sqrt(g*g+C*C+B*B);g/=I,C/=I,B/=I;const M=g*g,G=C*C,N=B*B,P=Math.cos(d),F=Math.sin(d),k=1-P,K=M+(1-M)*P,J=g*C*k+B*F,z=g*B*k-C*F,Z=g*C*k-B*F,W=G+(1-G)*P,ne=C*B*k+g*F,re=g*B*k+C*F,ie=C*B*k-g*F,se=N+(1-N)*P,ce=s[0],ue=s[1],le=s[2],de=s[3],fe=s[4],me=s[5],Ae=s[6],_e=s[7],Be=s[8],Te=s[9],ve=s[10],Se=s[11];return u[0]=K*ce+J*fe+z*Be,u[1]=K*ue+J*me+z*Te,u[2]=K*le+J*Ae+z*ve,u[3]=K*de+J*_e+z*Se,u[4]=Z*ce+W*fe+ne*Be,u[5]=Z*ue+W*me+ne*Te,u[6]=Z*le+W*Ae+ne*ve,u[7]=Z*de+W*_e+ne*Se,u[8]=re*ce+ie*fe+se*Be,u[9]=re*ue+ie*me+se*Te,u[10]=re*le+ie*Ae+se*ve,u[11]=re*de+ie*_e+se*Se,s!==u&&(u[12]=s[12],u[13]=s[13],u[14]=s[14],u[15]=s[15]),u}const f=p;function _(s,m){const d=m??new t(16);return d[0]=s[0],d[1]=0,d[2]=0,d[3]=0,d[4]=0,d[5]=s[1],d[6]=0,d[7]=0,d[8]=0,d[9]=0,d[10]=s[2],d[11]=0,d[12]=0,d[13]=0,d[14]=0,d[15]=1,d}function b(s,m,d){const h=d??new t(16),u=m[0],g=m[1],C=m[2];return h[0]=u*s[0],h[1]=u*s[1],h[2]=u*s[2],h[3]=u*s[3],h[4]=g*s[4],h[5]=g*s[5],h[6]=g*s[6],h[7]=g*s[7],h[8]=C*s[8],h[9]=C*s[9],h[10]=C*s[10],h[11]=C*s[11],s!==h&&(h[12]=s[12],h[13]=s[13],h[14]=s[14],h[15]=s[15]),h}function w(s,m){const d=m??new t(16);return d[0]=s,d[1]=0,d[2]=0,d[3]=0,d[4]=0,d[5]=s,d[6]=0,d[7]=0,d[8]=0,d[9]=0,d[10]=s,d[11]=0,d[12]=0,d[13]=0,d[14]=0,d[15]=1,d}function T(s,m,d){const h=d??new t(16);return h[0]=m*s[0],h[1]=m*s[1],h[2]=m*s[2],h[3]=m*s[3],h[4]=m*s[4],h[5]=m*s[5],h[6]=m*s[6],h[7]=m*s[7],h[8]=m*s[8],h[9]=m*s[9],h[10]=m*s[10],h[11]=m*s[11],s!==h&&(h[12]=s[12],h[13]=s[13],h[14]=s[14],h[15]=s[15]),h}return{add:l,aim:pe,axisRotate:p,axisRotation:y,cameraAim:Le,clone:x,copy:v,create:n,determinant:$,equals:D,equalsApproximately:R,fromMat3:i,fromQuat:o,frustum:Re,frustumReverseZ:ae,getAxis:Ie,getScaling:we,getTranslation:be,identity:O,inverse:H,invert:X,lookAt:ee,mul:q,mulScalar:E,multiply:V,multiplyScalar:A,negate:a,ortho:ge,perspective:oe,perspectiveReverseZ:Ge,rotate:f,rotateX:Ce,rotateY:Me,rotateZ:L,rotation:c,rotationX:Pe,rotationY:xe,rotationZ:S,scale:b,scaling:_,set:r,setAxis:Ee,setTranslation:te,translate:ye,translation:De,transpose:U,uniformScale:T,uniformScaling:w}}const cache$2=new Map;function getAPI$2(t){let e=cache$2.get(t);return e||(e=getAPIImpl$2(t),cache$2.set(t,e)),e}function getAPIImpl$1(t){const e=getAPI$4(t);function n(S,L,y,c){const p=new t(4);return S!==void 0&&(p[0]=S,L!==void 0&&(p[1]=L,y!==void 0&&(p[2]=y,c!==void 0&&(p[3]=c)))),p}const r=n;function i(S,L,y,c,p){const f=p??new t(4);return f[0]=S,f[1]=L,f[2]=y,f[3]=c,f}function o(S,L,y){const c=y??new t(4),p=L*.5,f=Math.sin(p);return c[0]=f*S[0],c[1]=f*S[1],c[2]=f*S[2],c[3]=Math.cos(p),c}function a(S,L){const y=L??e.create(3),c=Math.acos(S[3])*2,p=Math.sin(c*.5);return p>EPSILON?(y[0]=S[0]/p,y[1]=S[1]/p,y[2]=S[2]/p):(y[0]=1,y[1]=0,y[2]=0),{angle:c,axis:y}}function l(S,L){const y=oe(S,L);return Math.acos(2*y*y-1)}function A(S,L,y){const c=y??new t(4),p=S[0],f=S[1],_=S[2],b=S[3],w=L[0],T=L[1],s=L[2],m=L[3];return c[0]=p*m+b*w+f*s-_*T,c[1]=f*m+b*T+_*w-p*s,c[2]=_*m+b*s+p*T-f*w,c[3]=b*m-p*w-f*T-_*s,c}const E=A;function v(S,L,y){const c=y??new t(4),p=L*.5,f=S[0],_=S[1],b=S[2],w=S[3],T=Math.sin(p),s=Math.cos(p);return c[0]=f*s+w*T,c[1]=_*s+b*T,c[2]=b*s-_*T,c[3]=w*s-f*T,c}function x(S,L,y){const c=y??new t(4),p=L*.5,f=S[0],_=S[1],b=S[2],w=S[3],T=Math.sin(p),s=Math.cos(p);return c[0]=f*s-b*T,c[1]=_*s+w*T,c[2]=b*s+f*T,c[3]=w*s-_*T,c}function R(S,L,y){const c=y??new t(4),p=L*.5,f=S[0],_=S[1],b=S[2],w=S[3],T=Math.sin(p),s=Math.cos(p);return c[0]=f*s+_*T,c[1]=_*s-f*T,c[2]=b*s+w*T,c[3]=w*s-b*T,c}function D(S,L,y,c){const p=c??new t(4),f=S[0],_=S[1],b=S[2],w=S[3];let T=L[0],s=L[1],m=L[2],d=L[3],h=f*T+_*s+b*m+w*d;h<0&&(h=-h,T=-T,s=-s,m=-m,d=-d);let u,g;if(1-h>EPSILON){const C=Math.acos(h),B=Math.sin(C);u=Math.sin((1-y)*C)/B,g=Math.sin(y*C)/B}else u=1-y,g=y;return p[0]=u*f+g*T,p[1]=u*_+g*s,p[2]=u*b+g*m,p[3]=u*w+g*d,p}function O(S,L){const y=L??new t(4),c=S[0],p=S[1],f=S[2],_=S[3],b=c*c+p*p+f*f+_*_,w=b?1/b:0;return y[0]=-c*w,y[1]=-p*w,y[2]=-f*w,y[3]=_*w,y}function U(S,L){const y=L??new t(4);return y[0]=-S[0],y[1]=-S[1],y[2]=-S[2],y[3]=S[3],y}function H(S,L){const y=L??new t(4),c=S[0]+S[5]+S[10];if(c>0){const p=Math.sqrt(c+1);y[3]=.5*p;const f=.5/p;y[0]=(S[6]-S[9])*f,y[1]=(S[8]-S[2])*f,y[2]=(S[1]-S[4])*f}else{let p=0;S[5]>S[0]&&(p=1),S[10]>S[p*4+p]&&(p=2);const f=(p+1)%3,_=(p+2)%3,b=Math.sqrt(S[p*4+p]-S[f*4+f]-S[_*4+_]+1);y[p]=.5*b;const w=.5/b;y[3]=(S[f*4+_]-S[_*4+f])*w,y[f]=(S[f*4+p]+S[p*4+f])*w,y[_]=(S[_*4+p]+S[p*4+_])*w}return y}function $(S,L,y,c,p){const f=p??new t(4),_=S*.5,b=L*.5,w=y*.5,T=Math.sin(_),s=Math.cos(_),m=Math.sin(b),d=Math.cos(b),h=Math.sin(w),u=Math.cos(w);switch(c){case"xyz":f[0]=T*d*u+s*m*h,f[1]=s*m*u-T*d*h,f[2]=s*d*h+T*m*u,f[3]=s*d*u-T*m*h;break;case"xzy":f[0]=T*d*u-s*m*h,f[1]=s*m*u-T*d*h,f[2]=s*d*h+T*m*u,f[3]=s*d*u+T*m*h;break;case"yxz":f[0]=T*d*u+s*m*h,f[1]=s*m*u-T*d*h,f[2]=s*d*h-T*m*u,f[3]=s*d*u+T*m*h;break;case"yzx":f[0]=T*d*u+s*m*h,f[1]=s*m*u+T*d*h,f[2]=s*d*h-T*m*u,f[3]=s*d*u-T*m*h;break;case"zxy":f[0]=T*d*u-s*m*h,f[1]=s*m*u+T*d*h,f[2]=s*d*h+T*m*u,f[3]=s*d*u-T*m*h;break;case"zyx":f[0]=T*d*u-s*m*h,f[1]=s*m*u+T*d*h,f[2]=s*d*h-T*m*u,f[3]=s*d*u+T*m*h;break;default:throw new Error(`Unknown rotation order: ${c}`)}return f}function X(S,L){const y=L??new t(4);return y[0]=S[0],y[1]=S[1],y[2]=S[2],y[3]=S[3],y}const V=X;function q(S,L,y){const c=y??new t(4);return c[0]=S[0]+L[0],c[1]=S[1]+L[1],c[2]=S[2]+L[2],c[3]=S[3]+L[3],c}function te(S,L,y){const c=y??new t(4);return c[0]=S[0]-L[0],c[1]=S[1]-L[1],c[2]=S[2]-L[2],c[3]=S[3]-L[3],c}const be=te;function Ie(S,L,y){const c=y??new t(4);return c[0]=S[0]*L,c[1]=S[1]*L,c[2]=S[2]*L,c[3]=S[3]*L,c}const Ee=Ie;function we(S,L,y){const c=y??new t(4);return c[0]=S[0]/L,c[1]=S[1]/L,c[2]=S[2]/L,c[3]=S[3]/L,c}function oe(S,L){return S[0]*L[0]+S[1]*L[1]+S[2]*L[2]+S[3]*L[3]}function Ge(S,L,y,c){const p=c??new t(4);return p[0]=S[0]+y*(L[0]-S[0]),p[1]=S[1]+y*(L[1]-S[1]),p[2]=S[2]+y*(L[2]-S[2]),p[3]=S[3]+y*(L[3]-S[3]),p}function ge(S){const L=S[0],y=S[1],c=S[2],p=S[3];return Math.sqrt(L*L+y*y+c*c+p*p)}const Re=ge;function ae(S){const L=S[0],y=S[1],c=S[2],p=S[3];return L*L+y*y+c*c+p*p}const Y=ae;function Q(S,L){const y=L??new t(4),c=S[0],p=S[1],f=S[2],_=S[3],b=Math.sqrt(c*c+p*p+f*f+_*_);return b>1e-5?(y[0]=c/b,y[1]=p/b,y[2]=f/b,y[3]=_/b):(y[0]=0,y[1]=0,y[2]=0,y[3]=1),y}function j(S,L){return Math.abs(S[0]-L[0])<EPSILON&&Math.abs(S[1]-L[1])<EPSILON&&Math.abs(S[2]-L[2])<EPSILON&&Math.abs(S[3]-L[3])<EPSILON}function pe(S,L){return S[0]===L[0]&&S[1]===L[1]&&S[2]===L[2]&&S[3]===L[3]}function Le(S){const L=S??new t(4);return L[0]=0,L[1]=0,L[2]=0,L[3]=1,L}const ee=e.create(),De=e.create(),ye=e.create();function Pe(S,L,y){const c=y??new t(4),p=e.dot(S,L);return p<-.999999?(e.cross(De,S,ee),e.len(ee)<1e-6&&e.cross(ye,S,ee),e.normalize(ee,ee),o(ee,Math.PI,c),c):p>.999999?(c[0]=0,c[1]=0,c[2]=0,c[3]=1,c):(e.cross(S,L,ee),c[0]=ee[0],c[1]=ee[1],c[2]=ee[2],c[3]=1+p,Q(c,c))}const Ce=new t(4),xe=new t(4);function Me(S,L,y,c,p,f){const _=f??new t(4);return D(S,c,p,Ce),D(L,y,p,xe),D(Ce,xe,2*p*(1-p),_),_}return{create:n,fromValues:r,set:i,fromAxisAngle:o,toAxisAngle:a,angle:l,multiply:A,mul:E,rotateX:v,rotateY:x,rotateZ:R,slerp:D,inverse:O,conjugate:U,fromMat:H,fromEuler:$,copy:X,clone:V,add:q,subtract:te,sub:be,mulScalar:Ie,scale:Ee,divScalar:we,dot:oe,lerp:Ge,length:ge,len:Re,lengthSq:ae,lenSq:Y,normalize:Q,equalsApproximately:j,equals:pe,identity:Le,rotationTo:Pe,sqlerp:Me}}const cache$1=new Map;function getAPI$1(t){let e=cache$1.get(t);return e||(e=getAPIImpl$1(t),cache$1.set(t,e)),e}function getAPIImpl(t){function e(y,c,p,f){const _=new t(4);return y!==void 0&&(_[0]=y,c!==void 0&&(_[1]=c,p!==void 0&&(_[2]=p,f!==void 0&&(_[3]=f)))),_}const n=e;function r(y,c,p,f,_){const b=_??new t(4);return b[0]=y,b[1]=c,b[2]=p,b[3]=f,b}function i(y,c){const p=c??new t(4);return p[0]=Math.ceil(y[0]),p[1]=Math.ceil(y[1]),p[2]=Math.ceil(y[2]),p[3]=Math.ceil(y[3]),p}function o(y,c){const p=c??new t(4);return p[0]=Math.floor(y[0]),p[1]=Math.floor(y[1]),p[2]=Math.floor(y[2]),p[3]=Math.floor(y[3]),p}function a(y,c){const p=c??new t(4);return p[0]=Math.round(y[0]),p[1]=Math.round(y[1]),p[2]=Math.round(y[2]),p[3]=Math.round(y[3]),p}function l(y,c=0,p=1,f){const _=f??new t(4);return _[0]=Math.min(p,Math.max(c,y[0])),_[1]=Math.min(p,Math.max(c,y[1])),_[2]=Math.min(p,Math.max(c,y[2])),_[3]=Math.min(p,Math.max(c,y[3])),_}function A(y,c,p){const f=p??new t(4);return f[0]=y[0]+c[0],f[1]=y[1]+c[1],f[2]=y[2]+c[2],f[3]=y[3]+c[3],f}function E(y,c,p,f){const _=f??new t(4);return _[0]=y[0]+c[0]*p,_[1]=y[1]+c[1]*p,_[2]=y[2]+c[2]*p,_[3]=y[3]+c[3]*p,_}function v(y,c,p){const f=p??new t(4);return f[0]=y[0]-c[0],f[1]=y[1]-c[1],f[2]=y[2]-c[2],f[3]=y[3]-c[3],f}const x=v;function R(y,c){return Math.abs(y[0]-c[0])<EPSILON&&Math.abs(y[1]-c[1])<EPSILON&&Math.abs(y[2]-c[2])<EPSILON&&Math.abs(y[3]-c[3])<EPSILON}function D(y,c){return y[0]===c[0]&&y[1]===c[1]&&y[2]===c[2]&&y[3]===c[3]}function O(y,c,p,f){const _=f??new t(4);return _[0]=y[0]+p*(c[0]-y[0]),_[1]=y[1]+p*(c[1]-y[1]),_[2]=y[2]+p*(c[2]-y[2]),_[3]=y[3]+p*(c[3]-y[3]),_}function U(y,c,p,f){const _=f??new t(4);return _[0]=y[0]+p[0]*(c[0]-y[0]),_[1]=y[1]+p[1]*(c[1]-y[1]),_[2]=y[2]+p[2]*(c[2]-y[2]),_[3]=y[3]+p[3]*(c[3]-y[3]),_}function H(y,c,p){const f=p??new t(4);return f[0]=Math.max(y[0],c[0]),f[1]=Math.max(y[1],c[1]),f[2]=Math.max(y[2],c[2]),f[3]=Math.max(y[3],c[3]),f}function $(y,c,p){const f=p??new t(4);return f[0]=Math.min(y[0],c[0]),f[1]=Math.min(y[1],c[1]),f[2]=Math.min(y[2],c[2]),f[3]=Math.min(y[3],c[3]),f}function X(y,c,p){const f=p??new t(4);return f[0]=y[0]*c,f[1]=y[1]*c,f[2]=y[2]*c,f[3]=y[3]*c,f}const V=X;function q(y,c,p){const f=p??new t(4);return f[0]=y[0]/c,f[1]=y[1]/c,f[2]=y[2]/c,f[3]=y[3]/c,f}function te(y,c){const p=c??new t(4);return p[0]=1/y[0],p[1]=1/y[1],p[2]=1/y[2],p[3]=1/y[3],p}const be=te;function Ie(y,c){return y[0]*c[0]+y[1]*c[1]+y[2]*c[2]+y[3]*c[3]}function Ee(y){const c=y[0],p=y[1],f=y[2],_=y[3];return Math.sqrt(c*c+p*p+f*f+_*_)}const we=Ee;function oe(y){const c=y[0],p=y[1],f=y[2],_=y[3];return c*c+p*p+f*f+_*_}const Ge=oe;function ge(y,c){const p=y[0]-c[0],f=y[1]-c[1],_=y[2]-c[2],b=y[3]-c[3];return Math.sqrt(p*p+f*f+_*_+b*b)}const Re=ge;function ae(y,c){const p=y[0]-c[0],f=y[1]-c[1],_=y[2]-c[2],b=y[3]-c[3];return p*p+f*f+_*_+b*b}const Y=ae;function Q(y,c){const p=c??new t(4),f=y[0],_=y[1],b=y[2],w=y[3],T=Math.sqrt(f*f+_*_+b*b+w*w);return T>1e-5?(p[0]=f/T,p[1]=_/T,p[2]=b/T,p[3]=w/T):(p[0]=0,p[1]=0,p[2]=0,p[3]=0),p}function j(y,c){const p=c??new t(4);return p[0]=-y[0],p[1]=-y[1],p[2]=-y[2],p[3]=-y[3],p}function pe(y,c){const p=c??new t(4);return p[0]=y[0],p[1]=y[1],p[2]=y[2],p[3]=y[3],p}const Le=pe;function ee(y,c,p){const f=p??new t(4);return f[0]=y[0]*c[0],f[1]=y[1]*c[1],f[2]=y[2]*c[2],f[3]=y[3]*c[3],f}const De=ee;function ye(y,c,p){const f=p??new t(4);return f[0]=y[0]/c[0],f[1]=y[1]/c[1],f[2]=y[2]/c[2],f[3]=y[3]/c[3],f}const Pe=ye;function Ce(y){const c=y??new t(4);return c[0]=0,c[1]=0,c[2]=0,c[3]=0,c}function xe(y,c,p){const f=p??new t(4),_=y[0],b=y[1],w=y[2],T=y[3];return f[0]=c[0]*_+c[4]*b+c[8]*w+c[12]*T,f[1]=c[1]*_+c[5]*b+c[9]*w+c[13]*T,f[2]=c[2]*_+c[6]*b+c[10]*w+c[14]*T,f[3]=c[3]*_+c[7]*b+c[11]*w+c[15]*T,f}function Me(y,c,p){const f=p??new t(4);return Q(y,f),X(f,c,f)}function S(y,c,p){const f=p??new t(4);return Ee(y)>c?Me(y,c,f):pe(y,f)}function L(y,c,p){const f=p??new t(4);return O(y,c,.5,f)}return{create:e,fromValues:n,set:r,ceil:i,floor:o,round:a,clamp:l,add:A,addScaled:E,subtract:v,sub:x,equalsApproximately:R,equals:D,lerp:O,lerpV:U,max:H,min:$,mulScalar:X,scale:V,divScalar:q,inverse:te,invert:be,dot:Ie,length:Ee,len:we,lengthSq:oe,lenSq:Ge,distance:ge,dist:Re,distanceSq:ae,distSq:Y,normalize:Q,negate:j,copy:pe,clone:Le,multiply:ee,mul:De,divide:ye,div:Pe,zero:Ce,transformMat4:xe,setLength:Me,truncate:S,midpoint:L}}const cache=new Map;function getAPI(t){let e=cache.get(t);return e||(e=getAPIImpl(t),cache.set(t,e)),e}function wgpuMatrixAPI(t,e,n,r,i,o){return{mat3:getAPI$3(t),mat4:getAPI$2(e),quat:getAPI$1(n),vec2:getAPI$5(r),vec3:getAPI$4(i),vec4:getAPI(o)}}const{mat4,vec3}=wgpuMatrixAPI(Float32Array,Float32Array,Float32Array,Float32Array,Float32Array,Float32Array);wgpuMatrixAPI(Float64Array,Float64Array,Float64Array,Float64Array,Float64Array,Float64Array);wgpuMatrixAPI(ZeroArray,Array,Array,Array,Array,Array);function setupLoaders(){registerLoaders([GLTFLoader,ImageLoader])}function getFloatArray(t,e){const n=t.json,r=n.accessors[e],i=n.bufferViews[r.bufferView],o=t.buffers[i.buffer],a=(r.byteOffset??0)+(i.byteOffset??0)+o.byteOffset;return new Float32Array(o.arrayBuffer,a,i.byteLength/4)}class Texture{image;sampler;constructor(e,n){this.image=e,this.sampler=n}}class Material{static nextId=0;id;materialBindGroup;constructor(e,n){this.id=Material.nextId++;const r=n[e.pbrMetallicRoughness.baseColorTexture.index];this.materialBindGroup=device.createBindGroup({label:"material bind group",layout:materialBindGroupLayout,entries:[{binding:0,resource:r.image.createView()},{binding:1,resource:r.sampler}]})}}class Primitive{vertexBuffer;indexBuffer;numIndices=-1;material;constructor(e,n,r){this.material=r;const i=n.json,o=i.accessors[e.indices],a=i.bufferViews[o.bufferView],l=o.componentType,A=n.buffers[a.buffer],E=(o.byteOffset??0)+(a.byteOffset??0)+A.byteOffset;let v;switch(l){case 5123:v=Uint32Array.from(new Uint16Array(A.arrayBuffer,E,o.count));break;case 5125:v=new Uint32Array(A.arrayBuffer,E,o.count);break;default:throw new Error(`unsupported index buffer element component type: 0x${l.toString(16)}`)}const x=getFloatArray(n,e.attributes.POSITION),R=getFloatArray(n,e.attributes.NORMAL),D=getFloatArray(n,e.attributes.TEXCOORD_0),O=8,U=x.length/3,H=new Float32Array(U*O);for(let $=0;$<U;++$){const X=$*O;H[X]=x[$*3],H[X+1]=x[$*3+1],H[X+2]=x[$*3+2],H[X+3]=R[$*3],H[X+4]=R[$*3+1],H[X+5]=R[$*3+2],H[X+6]=D[$*2],H[X+7]=D[$*2+1]}this.indexBuffer=device.createBuffer({label:"index buffer",size:v.byteLength,usage:GPUBufferUsage.INDEX|GPUBufferUsage.COPY_DST}),device.queue.writeBuffer(this.indexBuffer,0,v.buffer),this.vertexBuffer=device.createBuffer({label:"vertex buffer",size:H.byteLength,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST}),device.queue.writeBuffer(this.vertexBuffer,0,H),this.numIndices=v.length}}class Mesh{primitives=[];constructor(e,n,r){e.primitives.forEach(i=>{this.primitives.push(new Primitive(i,n,r[i.material]))}),this.primitives.sort((i,o)=>i.material.id-o.material.id)}}class Node{name="node";parent;children=new Set;transform=mat4.identity();modelMatUniformBuffer;modelBindGroup;mesh;setName(e){this.name=e}setParent(e){this.parent!=null&&this.parent.children.delete(this),this.parent=e,e.children.add(this)}propagateTransformations(){this.parent!=null&&(this.transform=mat4.mul(this.parent.transform,this.transform)),this.mesh!=null&&(this.modelMatUniformBuffer=device.createBuffer({label:"model mat uniform",size:64,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),device.queue.writeBuffer(this.modelMatUniformBuffer,0,this.transform.buffer),this.modelBindGroup=device.createBindGroup({label:"model bind group",layout:modelBindGroupLayout,entries:[{binding:0,resource:{buffer:this.modelMatUniformBuffer}}]}));for(let e of this.children)e.propagateTransformations()}}function createTexture(t){let e=device.createTexture({size:[t.width,t.height],format:"rgba8unorm",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT});return device.queue.copyExternalImageToTexture({source:t},{texture:e},{width:t.width,height:t.height}),e}function convertWrapModeEnum(t){switch(t){case 10497:return"repeat";case 33071:return"clamp-to-edge";case 33648:return"mirror-repeat";default:throw new Error(`unsupported wrap mode: 0x${t.toString(16)}`)}}function createSampler(t){let e={};switch(t.magFilter){case 9728:e.magFilter="nearest";break;case 9729:e.magFilter="linear";break;default:throw new Error(`unsupported magFilter: 0x${t.magFilter.toString(16)}`)}switch(t.minFilter){case 9728:e.minFilter="nearest";break;case 9729:e.minFilter="linear";break;case 9984:e.minFilter="nearest",e.mipmapFilter="nearest";break;case 9985:e.minFilter="linear",e.mipmapFilter="nearest";break;case 9986:e.minFilter="nearest",e.mipmapFilter="linear";break;case 9987:e.minFilter="linear",e.mipmapFilter="linear";break;default:throw new Error(`unsupported minFilter: 0x${t.minFilter.toString(16)}`)}return e.addressModeU=convertWrapModeEnum(t.wrapS),e.addressModeV=convertWrapModeEnum(t.wrapT),device.createSampler(e)}class Scene{root=new Node;constructor(){this.root.setName("root")}async loadGltf(e){const n=await load(e),r=n.json;let i=[];{let E=[];for(let x of n.images)E.push(createTexture(x));let v=[];for(let x of r.samplers)v.push(createSampler(x));for(let x of r.textures)i.push(new Texture(E[x.source],v[x.sampler]))}let o=[];for(let E of r.materials)o.push(new Material(E,i));let a=[];for(let E of r.meshes)a.push(new Mesh(E,n,o));let l=new Node;l.setName("scene root"),l.setParent(this.root);let A=[];for(let E of r.nodes){let v=new Node;v.setName(E.name),v.setParent(l),E.mesh!=null&&(v.mesh=a[E.mesh]),E.matrix!=null?v.transform=new Float32Array(E.matrix):(E.translation!=null&&(v.transform=mat4.mul(v.transform,mat4.translation(E.translation))),E.rotation!=null&&(v.transform=mat4.mul(v.transform,mat4.fromQuat(E.rotation))),E.scale!=null&&(v.transform=mat4.mul(v.transform,mat4.scaling(E.scale)))),A.push(v)}for(let E in r.nodes){const v=r.nodes[E];if(v.children!=null)for(let x of v.children)A[x].setParent(A[E])}l.propagateTransformations()}iterate(e,n,r){let i=[this.root],o;for(;i.length>0;){let a=i.pop();if(a.mesh!=null){e(a);for(let l of a.mesh.primitives)l.material.id!=o&&(n(l.material),o=l.material.id),r(l)}for(let l of a.children)i.push(l)}}}function hueToRgb(t){let e=(n,r=(n+t*6)%6)=>1-Math.max(Math.min(r,4-r,1),0);return vec3.lerp(vec3.create(1,1,1),vec3.create(e(5),e(3),e(1)),.8)}class Lights{camera;numLights=1600;static maxNumLights=5e3;static numFloatsPerLight=8;static lightIntensity=1;lightsArray=new Float32Array(Lights.maxNumLights*Lights.numFloatsPerLight);lightSetStorageBuffer;timeUniformBuffer;moveLightsComputeBindGroupLayout;moveLightsComputeBindGroup;moveLightsComputePipeline;constructor(e){this.camera=e,this.lightSetStorageBuffer=device.createBuffer({label:"lights",size:16+this.lightsArray.byteLength,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST}),this.populateLightsBuffer(),this.updateLightSetUniformNumLights(),this.timeUniformBuffer=device.createBuffer({label:"time uniform",size:4,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),this.moveLightsComputeBindGroupLayout=device.createBindGroupLayout({label:"move lights compute bind group layout",entries:[{binding:0,visibility:GPUShaderStage.COMPUTE,buffer:{type:"storage"}},{binding:1,visibility:GPUShaderStage.COMPUTE,buffer:{type:"uniform"}}]}),this.moveLightsComputeBindGroup=device.createBindGroup({label:"move lights compute bind group",layout:this.moveLightsComputeBindGroupLayout,entries:[{binding:0,resource:{buffer:this.lightSetStorageBuffer}},{binding:1,resource:{buffer:this.timeUniformBuffer}}]}),this.moveLightsComputePipeline=device.createComputePipeline({label:"move lights compute pipeline",layout:device.createPipelineLayout({label:"move lights compute pipeline layout",bindGroupLayouts:[this.moveLightsComputeBindGroupLayout]}),compute:{module:device.createShaderModule({label:"move lights compute shader",code:moveLightsComputeSrc}),entryPoint:"main"}})}populateLightsBuffer(){for(let e=0;e<Lights.maxNumLights;++e){const n=vec3.scale(hueToRgb(Math.random()),Lights.lightIntensity);this.lightsArray.set(n,e*Lights.numFloatsPerLight+4)}device.queue.writeBuffer(this.lightSetStorageBuffer,16,this.lightsArray)}updateLightSetUniformNumLights(){device.queue.writeBuffer(this.lightSetStorageBuffer,0,new Uint32Array([this.numLights]))}doLightClustering(e){}onFrame(e){device.queue.writeBuffer(this.timeUniformBuffer,0,new Float32Array([e]));const n=device.createCommandEncoder(),r=n.beginComputePass();r.setPipeline(this.moveLightsComputePipeline),r.setBindGroup(0,this.moveLightsComputeBindGroup);const i=Math.ceil(this.numLights/constants.moveLightsWorkgroupSize);r.dispatchWorkgroups(i),r.end(),device.queue.submit([n.finish()])}}function toRadians(t){return t*Math.PI/180}class CameraUniforms{buffer=new ArrayBuffer(144);floatView=new Float32Array(this.buffer);set viewProjMat(e){for(var n=0;n<16;n++)this.floatView[n]=e[n]}set viewMat(e){for(var n=0;n<16;n++)this.floatView[n+16]=e[n]}set viewportSizeX(e){this.floatView[32]=e}set viewportSizeY(e){this.floatView[33]=e}set ParamX(e){this.floatView[34]=e}set ParamY(e){this.floatView[35]=e}}class Camera{uniforms=new CameraUniforms;uniformsBuffer;projMat=mat4.create();cameraPos=vec3.create(-7,2,0);cameraFront=vec3.create(0,0,-1);cameraUp=vec3.create(0,1,0);cameraRight=vec3.create(1,0,0);yaw=0;pitch=0;moveSpeed=.004;sensitivity=.15;static nearPlane=.1;static farPlane=1e3;keys={};constructor(){this.projMat=mat4.perspective(toRadians(fovYDegrees),aspectRatio,Camera.nearPlane,Camera.farPlane),this.uniformsBuffer=device.createBuffer({size:this.uniforms.buffer.byteLength,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),this.rotateCamera(0,0),window.addEventListener("keydown",e=>this.onKeyEvent(e,!0)),window.addEventListener("keyup",e=>this.onKeyEvent(e,!1)),window.onblur=()=>this.keys={},canvas.addEventListener("mousedown",()=>canvas.requestPointerLock()),canvas.addEventListener("mouseup",()=>document.exitPointerLock()),canvas.addEventListener("mousemove",e=>this.onMouseMove(e))}onKeyEvent(e,n){this.keys[e.key.toLowerCase()]=n,this.keys.alt&&e.preventDefault()}rotateCamera(e,n){this.yaw+=e,this.pitch-=n,this.pitch>89&&(this.pitch=89),this.pitch<-89&&(this.pitch=-89);const r=mat4.create();r[0]=Math.cos(toRadians(this.yaw))*Math.cos(toRadians(this.pitch)),r[1]=Math.sin(toRadians(this.pitch)),r[2]=Math.sin(toRadians(this.yaw))*Math.cos(toRadians(this.pitch)),this.cameraFront=vec3.normalize(r),this.cameraRight=vec3.normalize(vec3.cross(this.cameraFront,[0,1,0])),this.cameraUp=vec3.normalize(vec3.cross(this.cameraRight,this.cameraFront))}onMouseMove(e){document.pointerLockElement===canvas&&this.rotateCamera(e.movementX*this.sensitivity,e.movementY*this.sensitivity)}processInput(e){let n=vec3.create(0,0,0);this.keys.w&&(n=vec3.add(n,this.cameraFront)),this.keys.s&&(n=vec3.sub(n,this.cameraFront)),this.keys.a&&(n=vec3.sub(n,this.cameraRight)),this.keys.d&&(n=vec3.add(n,this.cameraRight)),this.keys.q&&(n=vec3.sub(n,this.cameraUp)),this.keys.e&&(n=vec3.add(n,this.cameraUp));let r=this.moveSpeed*e;const i=3;if(this.keys.shift&&(r*=i),this.keys.alt&&(r/=i),vec3.length(n)>0){const o=vec3.scale(vec3.normalize(n),r);this.cameraPos=vec3.add(this.cameraPos,o)}}onFrame(e){this.processInput(e);const n=vec3.add(this.cameraPos,vec3.scale(this.cameraFront,1)),r=mat4.lookAt(this.cameraPos,n,[0,1,0]),i=mat4.mul(this.projMat,r);this.uniforms.viewProjMat=i,this.uniforms.viewMat=r,this.uniforms.viewportSizeX=canvas.width,this.uniforms.viewportSizeY=canvas.height,this.uniforms.ParamX=aspectRatio*Math.tan(toRadians(fovYDegrees)*.5),this.uniforms.ParamY=Math.tan(toRadians(fovYDegrees)*.5),device.queue.writeBuffer(this.uniformsBuffer,0,this.uniforms.buffer)}}class Stage{scene;lights;camera;stats;constructor(e,n,r,i){this.scene=e,this.lights=n,this.camera=r,this.stats=i}}await initWebGPU();setupLoaders();let scene=new Scene;await scene.loadGltf("./scenes/sponza/Sponza.gltf");const camera=new Camera,lights=new Lights(camera),stats=new Stats;stats.showPanel(0);document.body.appendChild(stats.dom);const gui=new GUI$1;gui.add(lights,"numLights").min(1).max(Lights.maxNumLights).step(1).onChange(()=>{lights.updateLightSetUniformNumLights()});const stage=new Stage(scene,lights,camera,stats);var renderer;function setRenderer(t){switch(renderer?.stop(),t){case renderModes.naive:renderer=new NaiveRenderer(stage);break;case renderModes.forwardPlus:renderer=new ForwardPlusRenderer(stage);break;case renderModes.clusteredDeferred:renderer=new ClusteredDeferredRenderer(stage);break}}const renderModes={naive:"naive",forwardPlus:"forward+",clusteredDeferred:"clustered deferred"};let renderModeController=gui.add({mode:renderModes.clusteredDeferred},"mode",renderModes);renderModeController.onChange(setRenderer);setRenderer(renderModeController.getValue());
